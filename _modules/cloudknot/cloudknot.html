
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>cloudknot.cloudknot &#8212; cloudknot 0.1 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/collapsible.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">cloudknot</a></h1>



<p class="blurb">Run your existing python code on AWS Batch</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=richford&repo=cloudknot&type=star&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../documentation.html">documentation</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/richford/cloudknot/tree/master/examples">examples</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/richford/cloudknot">code</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/richford/cloudknot/issues">bugs</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for cloudknot.cloudknot</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">configparser</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="k">import</span> <span class="n">ThreadPoolExecutor</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">aws</span>
<span class="kn">from</span> <span class="nn">.config</span> <span class="k">import</span> <span class="n">get_config_file</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">dockerimage</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Pars&quot;</span><span class="p">,</span> <span class="s2">&quot;Knot&quot;</span><span class="p">]</span>

<span class="n">mod_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># noinspection PyPropertyAccess,PyAttributeOutsideInit</span>
<div class="viewcode-block" id="Pars"><a class="viewcode-back" href="../../documentation.html#cloudknot.Pars">[docs]</a><span class="k">class</span> <span class="nc">Pars</span><span class="p">(</span><span class="n">aws</span><span class="o">.</span><span class="n">NamedObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;PARS stands for Persistent AWS Resource Set</span>

<span class="sd">    This object collects AWS resources that could, in theory, be created only</span>
<span class="sd">    once for each cloudknot user and used for all of their subsequent AWS</span>
<span class="sd">    batch jobs. This set consists of IAM roles, a VPC with subnets for each</span>
<span class="sd">    availability zone, and a security group.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span>
                 <span class="n">batch_service_role_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ecs_instance_role_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">ecs_task_role_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spot_fleet_role_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">policies</span><span class="o">=</span><span class="p">(),</span> <span class="n">vpc_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vpc_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_default_vpc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">security_group_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">security_group_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize a PARS instance.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            The name of this PARS. If `pars name` exists in the config file,</span>
<span class="sd">            Pars will retrieve those PARS resource parameters. Otherwise,</span>
<span class="sd">            Pars will create a new PARS with this name.</span>
<span class="sd">            Default: &#39;default&#39;</span>

<span class="sd">        batch_service_role_name : str</span>
<span class="sd">            Name of this PARS&#39; batch service IAM role. If the role already</span>
<span class="sd">            exists, Pars will adopt it. Otherwise, it will create it.</span>
<span class="sd">            Default: name + &#39;-cloudknot-batch-service-role&#39;</span>

<span class="sd">        ecs_instance_role_name : str</span>
<span class="sd">            Name of this PARS&#39; ECS instance IAM role. If the role already</span>
<span class="sd">            exists, Pars will adopt it. Otherwise, it will create it.</span>
<span class="sd">            Default: name + &#39;-cloudknot-ecs-instance-role&#39;</span>

<span class="sd">        ecs_task_role_name : str</span>
<span class="sd">            Name of this PARS&#39; ECS task IAM role. If the role already</span>
<span class="sd">            exists, Pars will adopt it. Otherwise, it will create it.</span>
<span class="sd">            Default: name + &#39;-cloudknot-ecs-task-role&#39;</span>

<span class="sd">        spot_fleet_role_name : str</span>
<span class="sd">            Name of this PARS&#39; spot fleet IAM role. If the role already</span>
<span class="sd">            exists, Pars will adopt it. Otherwise, it will create it.</span>
<span class="sd">            Default: name + &#39;-cloudknot-spot-fleet-role&#39;</span>

<span class="sd">        policies : tuple of strings</span>
<span class="sd">            tuple of names of AWS policies to attach to each role</span>
<span class="sd">            Default: ()</span>

<span class="sd">        vpc_id : str</span>
<span class="sd">            The VPC-ID of the pre-existing VPC that this PARS should adopt</span>
<span class="sd">            Default: None</span>

<span class="sd">        vpc_name : str</span>
<span class="sd">            The name of the VPC that this PARS should create</span>
<span class="sd">            Default: name + &#39;-cloudknot-vpc&#39;</span>

<span class="sd">        use_default_vpc : bool</span>
<span class="sd">            if True, create or retrieve the default VPC</span>
<span class="sd">            if False, use other input args to create a non-default VPC</span>

<span class="sd">        security_group_id : str</span>
<span class="sd">            The ID of the pre-existing security group that this PARS should</span>
<span class="sd">            adopt</span>
<span class="sd">            Default: None</span>

<span class="sd">        security_group_name : str</span>
<span class="sd">            The name of the security group that this PARS should create</span>
<span class="sd">            Default: name + &#39;-cloudknot-security-group&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate name input</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;PARS name must be a string. You passed a &#39;</span>
                             <span class="s1">&#39;</span><span class="si">{t!s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Pars</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Validate vpc_name input</span>
        <span class="k">if</span> <span class="n">vpc_name</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vpc_name</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;if provided, vpc_name must be a string.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vpc_name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;-cloudknot-vpc&#39;</span>

        <span class="c1"># Validate security_group_name input</span>
        <span class="k">if</span> <span class="n">security_group_name</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">security_group_name</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;if provided, security_group_name must be &#39;</span>
                                 <span class="s1">&#39;a string.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">security_group_name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;-cloudknot-security-group&#39;</span>

        <span class="c1"># Check for existence of this pars in the config file</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
        <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">get_config_file</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pars_name</span> <span class="o">=</span> <span class="s1">&#39;pars &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pars_name</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">sections</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_region</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars_name</span><span class="p">,</span> <span class="s1">&#39;region&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_profile</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars_name</span><span class="p">,</span> <span class="s1">&#39;profile&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_profile_and_region</span><span class="p">()</span>

            <span class="c1"># Pars exists, check that user did not provide any resource names</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">batch_service_role_name</span><span class="p">,</span> <span class="n">ecs_instance_role_name</span><span class="p">,</span>
                    <span class="n">spot_fleet_role_name</span><span class="p">,</span> <span class="n">vpc_id</span><span class="p">,</span> <span class="n">security_group_id</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You provided resources for a pars that &#39;</span>
                                 <span class="s1">&#39;already exists in configuration file &#39;</span>
                                 <span class="s1">&#39;</span><span class="si">{fn:s}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="n">get_config_file</span><span class="p">()))</span>

            <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Found PARS </span><span class="si">{name:s}</span><span class="s1"> in config&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">))</span>
            <span class="n">role_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars_name</span><span class="p">,</span> <span class="s1">&#39;batch-service-role&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Use config values to adopt role if it exists already</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_batch_service_role</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">IamRole</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">role_name</span><span class="p">)</span>
                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;PARS </span><span class="si">{name:s}</span><span class="s1"> adopted role </span><span class="si">{role:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">role_name</span>
                <span class="p">))</span>
            <span class="k">except</span> <span class="n">aws</span><span class="o">.</span><span class="n">ResourceDoesNotExistException</span><span class="p">:</span>
                <span class="c1"># Otherwise create the new role</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_batch_service_role</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">IamRole</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">role_name</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;This AWS batch service role was &#39;</span>
                                <span class="s1">&#39;automatically generated by cloudknot.&#39;</span><span class="p">,</span>
                    <span class="n">service</span><span class="o">=</span><span class="s1">&#39;batch&#39;</span><span class="p">,</span>
                    <span class="n">policies</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;AWSBatchServiceRole&#39;</span><span class="p">,)</span> <span class="o">+</span> <span class="n">policies</span><span class="p">,</span>
                    <span class="n">add_instance_profile</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;PARS </span><span class="si">{name:s}</span><span class="s1"> created role </span><span class="si">{role:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">role_name</span>
                <span class="p">))</span>

            <span class="n">role_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars_name</span><span class="p">,</span> <span class="s1">&#39;ecs-instance-role&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Use config values to adopt role if it exists already</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ecs_instance_role</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">IamRole</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">role_name</span><span class="p">)</span>
                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;PARS </span><span class="si">{name:s}</span><span class="s1"> adopted role </span><span class="si">{role:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">role_name</span>
                <span class="p">))</span>
            <span class="k">except</span> <span class="n">aws</span><span class="o">.</span><span class="n">ResourceDoesNotExistException</span><span class="p">:</span>
                <span class="c1"># Otherwise create the new role</span>
                <span class="n">pols</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;AmazonEC2ContainerServiceforEC2Role&#39;</span><span class="p">,)</span> <span class="o">+</span> <span class="n">policies</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ecs_instance_role</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">IamRole</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">role_name</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;This AWS ECS instance role was automatically &#39;</span>
                                <span class="s1">&#39;generated by cloudknot.&#39;</span><span class="p">,</span>
                    <span class="n">service</span><span class="o">=</span><span class="s1">&#39;ec2&#39;</span><span class="p">,</span>
                    <span class="n">policies</span><span class="o">=</span><span class="n">pols</span><span class="p">,</span>
                    <span class="n">add_instance_profile</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;PARS </span><span class="si">{name:s}</span><span class="s1"> created role </span><span class="si">{role:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">role_name</span>
                <span class="p">))</span>

            <span class="n">role_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars_name</span><span class="p">,</span> <span class="s1">&#39;ecs-task-role&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Use config values to adopt role if it exists already</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ecs_task_role</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">IamRole</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">role_name</span><span class="p">)</span>
                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;PARS </span><span class="si">{name:s}</span><span class="s1"> adopted role </span><span class="si">{role:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">role_name</span>
                <span class="p">))</span>
            <span class="k">except</span> <span class="n">aws</span><span class="o">.</span><span class="n">ResourceDoesNotExistException</span><span class="p">:</span>
                <span class="c1"># Otherwise create the new role</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ecs_task_role</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">IamRole</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">role_name</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;This AWS ECS task role was automatically &#39;</span>
                                <span class="s1">&#39;generated by cloudknot.&#39;</span><span class="p">,</span>
                    <span class="n">service</span><span class="o">=</span><span class="s1">&#39;ecs-tasks&#39;</span><span class="p">,</span>
                    <span class="n">policies</span><span class="o">=</span><span class="n">policies</span><span class="p">,</span>
                    <span class="n">add_instance_profile</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;PARS </span><span class="si">{name:s}</span><span class="s1"> created role </span><span class="si">{role:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">role_name</span>
                <span class="p">))</span>

            <span class="n">role_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars_name</span><span class="p">,</span> <span class="s1">&#39;spot-fleet-role&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Use config values to adopt role if it exists already</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_spot_fleet_role</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">IamRole</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">role_name</span><span class="p">)</span>
                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;PARS </span><span class="si">{name:s}</span><span class="s1"> adopted role </span><span class="si">{role:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">role_name</span>
                <span class="p">))</span>
            <span class="k">except</span> <span class="n">aws</span><span class="o">.</span><span class="n">ResourceDoesNotExistException</span><span class="p">:</span>
                <span class="c1"># Otherwise create the new role</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_spot_fleet_role</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">IamRole</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">role_name</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;This AWS spot fleet role was automatically &#39;</span>
                                <span class="s1">&#39;generated by cloudknot.&#39;</span><span class="p">,</span>
                    <span class="n">service</span><span class="o">=</span><span class="s1">&#39;spotfleet&#39;</span><span class="p">,</span>
                    <span class="n">policies</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;AmazonEC2SpotFleetRole&#39;</span><span class="p">,)</span> <span class="o">+</span> <span class="n">policies</span><span class="p">,</span>
                    <span class="n">add_instance_profile</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;PARS </span><span class="si">{name:s}</span><span class="s1"> created role </span><span class="si">{role:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">role_name</span>
                <span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Use config values to adopt VPC if it exists already</span>
                <span class="n">vpcid</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars_name</span><span class="p">,</span> <span class="s1">&#39;vpc&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_vpc</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">Vpc</span><span class="p">(</span><span class="n">vpc_id</span><span class="o">=</span><span class="n">vpcid</span><span class="p">)</span>
                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;PARS </span><span class="si">{name:s}</span><span class="s1"> adopted VPC </span><span class="si">{vpcid:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">vpcid</span><span class="o">=</span><span class="n">vpcid</span>
                <span class="p">))</span>
            <span class="k">except</span> <span class="n">aws</span><span class="o">.</span><span class="n">ResourceDoesNotExistException</span><span class="p">:</span>
                <span class="c1"># Otherwise create the new VPC</span>
                <span class="k">if</span> <span class="n">use_default_vpc</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_vpc</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">Vpc</span><span class="p">(</span><span class="n">use_default_vpc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">aws</span><span class="o">.</span><span class="n">CannotCreateResourceException</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_vpc</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">Vpc</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">vpc_name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_vpc</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">Vpc</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">vpc_name</span><span class="p">)</span>
                <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
                <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">get_config_file</span><span class="p">())</span>
                <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars_name</span><span class="p">,</span> <span class="s1">&#39;vpc&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vpc</span><span class="o">.</span><span class="n">vpc_id</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">get_config_file</span><span class="p">(),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;PARS </span><span class="si">{name:s}</span><span class="s1"> created VPC </span><span class="si">{vpcid:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">vpcid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vpc</span><span class="o">.</span><span class="n">vpc_id</span>
                <span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Use config values to adopt security group if it exists</span>
                <span class="n">sgid</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars_name</span><span class="p">,</span> <span class="s1">&#39;security-group&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_security_group</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">SecurityGroup</span><span class="p">(</span>
                    <span class="n">security_group_id</span><span class="o">=</span><span class="n">sgid</span>
                <span class="p">)</span>
                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;PARS </span><span class="si">{name:s}</span><span class="s1"> adopted security group </span><span class="si">{sgid:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">sgid</span><span class="o">=</span><span class="n">sgid</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">aws</span><span class="o">.</span><span class="n">ResourceDoesNotExistException</span><span class="p">:</span>
                <span class="c1"># Otherwise create the new security group</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_security_group</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">SecurityGroup</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">security_group_name</span><span class="p">,</span>
                    <span class="n">vpc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_vpc</span>
                <span class="p">)</span>
                <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
                <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">get_config_file</span><span class="p">())</span>
                <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_pars_name</span><span class="p">,</span>
                    <span class="s1">&#39;security-group&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">security_group</span><span class="o">.</span><span class="n">security_group_id</span>
                <span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">get_config_file</span><span class="p">(),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;PARS </span><span class="si">{name:s}</span><span class="s1"> created security group </span><span class="si">{sgid:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">sgid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">security_group</span><span class="o">.</span><span class="n">security_group_id</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
            <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">get_config_file</span><span class="p">())</span>
            <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars_name</span><span class="p">,</span> <span class="s1">&#39;region&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">)</span>
            <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars_name</span><span class="p">,</span> <span class="s1">&#39;profile&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="p">)</span>

            <span class="c1"># Save config to file</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">get_config_file</span><span class="p">(),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Pars doesn&#39;t exist, use input names to adopt/create resources</span>
            <span class="c1"># Validate role name input</span>
            <span class="k">if</span> <span class="n">batch_service_role_name</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch_service_role_name</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;if provided, batch_service_role_name &#39;</span>
                                     <span class="s1">&#39;must be a string.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">batch_service_role_name</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;-cloudknot-batch-service-role&#39;</span>
                <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Create new role</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_batch_service_role</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">IamRole</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">batch_service_role_name</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;This AWS batch service role was &#39;</span>
                                <span class="s1">&#39;automatically generated by cloudknot.&#39;</span><span class="p">,</span>
                    <span class="n">service</span><span class="o">=</span><span class="s1">&#39;batch&#39;</span><span class="p">,</span>
                    <span class="n">policies</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;AWSBatchServiceRole&#39;</span><span class="p">,)</span> <span class="o">+</span> <span class="n">policies</span><span class="p">,</span>
                    <span class="n">add_instance_profile</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;PARS </span><span class="si">{name:s}</span><span class="s1"> created role </span><span class="si">{role:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">batch_service_role_name</span>
                <span class="p">))</span>
            <span class="k">except</span> <span class="n">aws</span><span class="o">.</span><span class="n">ResourceExistsException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># If it already exists, simply adopt it</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_batch_service_role</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">IamRole</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">resource_id</span><span class="p">)</span>
                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;PARS </span><span class="si">{name:s}</span><span class="s1"> adopted role </span><span class="si">{role:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">resource_id</span>
                <span class="p">))</span>

            <span class="c1"># Validate role name input</span>
            <span class="k">if</span> <span class="n">ecs_instance_role_name</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ecs_instance_role_name</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                    <span class="c1"># Clean up after ourselves and raise ValueError</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">batch_service_role</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;if provided, ecs_instance_role_name &#39;</span>
                                     <span class="s1">&#39;must be a string.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ecs_instance_role_name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;-cloudknot-ecs-instance-role&#39;</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Create new role</span>
                <span class="n">pols</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;AmazonEC2ContainerServiceforEC2Role&#39;</span><span class="p">,)</span> <span class="o">+</span> <span class="n">policies</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ecs_instance_role</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">IamRole</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">ecs_instance_role_name</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;This AWS ECS instance role was automatically &#39;</span>
                                <span class="s1">&#39;generated by cloudknot.&#39;</span><span class="p">,</span>
                    <span class="n">service</span><span class="o">=</span><span class="s1">&#39;ec2&#39;</span><span class="p">,</span>
                    <span class="n">policies</span><span class="o">=</span><span class="n">pols</span><span class="p">,</span>
                    <span class="n">add_instance_profile</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;PARS </span><span class="si">{name:s}</span><span class="s1"> created role </span><span class="si">{role:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">ecs_instance_role_name</span>
                <span class="p">))</span>
            <span class="k">except</span> <span class="n">aws</span><span class="o">.</span><span class="n">ResourceExistsException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># If it already exists, simply adopt it</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ecs_instance_role</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">IamRole</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">resource_id</span><span class="p">)</span>
                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;PARS </span><span class="si">{name:s}</span><span class="s1"> adopted role </span><span class="si">{role:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">resource_id</span>
                <span class="p">))</span>

            <span class="c1"># Validate role name input</span>
            <span class="k">if</span> <span class="n">ecs_task_role_name</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ecs_task_role_name</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                    <span class="c1"># Clean up after ourselves and raise ValueError</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">batch_service_role</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ecs_instance_role</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;if provided, ecs_instance_role_name &#39;</span>
                                     <span class="s1">&#39;must be a string.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ecs_task_role_name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;-cloudknot-ecs-task-role&#39;</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Create new role</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ecs_task_role</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">IamRole</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">ecs_task_role_name</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;This AWS ECS task role was automatically &#39;</span>
                                <span class="s1">&#39;generated by cloudknot.&#39;</span><span class="p">,</span>
                    <span class="n">service</span><span class="o">=</span><span class="s1">&#39;ecs-tasks&#39;</span><span class="p">,</span>
                    <span class="n">policies</span><span class="o">=</span><span class="n">policies</span><span class="p">,</span>
                    <span class="n">add_instance_profile</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;PARS </span><span class="si">{name:s}</span><span class="s1"> created role </span><span class="si">{role:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">ecs_task_role_name</span>
                <span class="p">))</span>
            <span class="k">except</span> <span class="n">aws</span><span class="o">.</span><span class="n">ResourceExistsException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># If it already exists, simply adopt it</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ecs_task_role</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">IamRole</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">resource_id</span><span class="p">)</span>
                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;PARS </span><span class="si">{name:s}</span><span class="s1"> adopted role </span><span class="si">{role:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">resource_id</span>
                <span class="p">))</span>

            <span class="c1"># Validate role name input</span>
            <span class="k">if</span> <span class="n">spot_fleet_role_name</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spot_fleet_role_name</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                    <span class="c1"># Clean up after ourselves and raise ValueError</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">batch_service_role</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ecs_instance_role</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ecs_task_role</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;if provided, spot_fleet_role_name must &#39;</span>
                                     <span class="s1">&#39;be a string.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">spot_fleet_role_name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;-cloudknot-spot-fleet-role&#39;</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Create new role</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_spot_fleet_role</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">IamRole</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">spot_fleet_role_name</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;This AWS spot fleet role was automatically &#39;</span>
                                <span class="s1">&#39;generated by cloudknot.&#39;</span><span class="p">,</span>
                    <span class="n">service</span><span class="o">=</span><span class="s1">&#39;spotfleet&#39;</span><span class="p">,</span>
                    <span class="n">policies</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;AmazonEC2SpotFleetRole&#39;</span><span class="p">,)</span> <span class="o">+</span> <span class="n">policies</span><span class="p">,</span>
                    <span class="n">add_instance_profile</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;PARS </span><span class="si">{name:s}</span><span class="s1"> created role </span><span class="si">{role:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">spot_fleet_role_name</span>
                <span class="p">))</span>
            <span class="k">except</span> <span class="n">aws</span><span class="o">.</span><span class="n">ResourceExistsException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># If it already exists, simply adopt it</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_spot_fleet_role</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">IamRole</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">resource_id</span><span class="p">)</span>
                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;PARS </span><span class="si">{name:s}</span><span class="s1"> adopted role </span><span class="si">{role:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">resource_id</span>
                <span class="p">))</span>

            <span class="k">if</span> <span class="n">vpc_id</span><span class="p">:</span>
                <span class="c1"># Validate vpc_id input</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vpc_id</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                    <span class="c1"># Clean up after ourselves and raise ValueError</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">batch_service_role</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ecs_instance_role</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ecs_task_role</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">spot_fleet_role</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;if provided, vpc_id must be a string&#39;</span><span class="p">)</span>

                <span class="c1"># Adopt the VPC</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_vpc</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">Vpc</span><span class="p">(</span><span class="n">vpc_id</span><span class="o">=</span><span class="n">vpc_id</span><span class="p">)</span>
                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;PARS </span><span class="si">{name:s}</span><span class="s1"> adopted VPC </span><span class="si">{vpcid:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">vpcid</span><span class="o">=</span><span class="n">vpc_id</span>
                <span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">use_default_vpc</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_vpc</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">Vpc</span><span class="p">(</span><span class="n">use_default_vpc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">except</span> <span class="n">aws</span><span class="o">.</span><span class="n">CannotCreateResourceException</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_vpc</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">Vpc</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">vpc_name</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_vpc</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">Vpc</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">vpc_name</span><span class="p">)</span>

                    <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s1">&#39;PARS </span><span class="si">{name:s}</span><span class="s1"> created VPC </span><span class="si">{vpcid:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">vpcid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vpc</span><span class="o">.</span><span class="n">vpc_id</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="n">aws</span><span class="o">.</span><span class="n">ResourceExistsException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c1"># If it already exists, simply adopt it</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_vpc</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">Vpc</span><span class="p">(</span><span class="n">vpc_id</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">resource_id</span><span class="p">)</span>
                    <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s1">&#39;PARS </span><span class="si">{name:s}</span><span class="s1"> adopted VPC </span><span class="si">{vpcid:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">vpcid</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">resource_id</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="n">security_group_id</span><span class="p">:</span>
                <span class="c1"># Validate security_group_id input</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">security_group_id</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                    <span class="c1"># Clean up after ourselves and raise ValueError</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">batch_service_role</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ecs_instance_role</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ecs_task_role</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">spot_fleet_role</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vpc</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;if provided, security_group_id must &#39;</span>
                                     <span class="s1">&#39;be a string&#39;</span><span class="p">)</span>

                <span class="c1"># Adopt the security group</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_security_group</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">SecurityGroup</span><span class="p">(</span>
                    <span class="n">security_group_id</span><span class="o">=</span><span class="n">security_group_id</span>
                <span class="p">)</span>
                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;PARS </span><span class="si">{name:s}</span><span class="s1"> adopted security group </span><span class="si">{sgid:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">sgid</span><span class="o">=</span><span class="n">security_group_id</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Create new security group</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_security_group</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">SecurityGroup</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">security_group_name</span><span class="p">,</span>
                        <span class="n">vpc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vpc</span>
                    <span class="p">)</span>
                    <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s1">&#39;PARS </span><span class="si">{name:s}</span><span class="s1"> created security group </span><span class="si">{sgid:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">sgid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">security_group</span><span class="o">.</span><span class="n">security_group_id</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="n">aws</span><span class="o">.</span><span class="n">ResourceExistsException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c1"># If it already exists, simply adopt it</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_security_group</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">SecurityGroup</span><span class="p">(</span>
                        <span class="n">security_group_id</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">resource_id</span>
                    <span class="p">)</span>
                    <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s1">&#39;PARS </span><span class="si">{name:s}</span><span class="s1"> adopted security group </span><span class="si">{sgid:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">sgid</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">resource_id</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

            <span class="c1"># Save the new pars resources in config object</span>
            <span class="c1"># Use config.set() for python 2.7 compatibility</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
            <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">get_config_file</span><span class="p">())</span>
            <span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars_name</span><span class="p">)</span>
            <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars_name</span><span class="p">,</span> <span class="s1">&#39;region&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">)</span>
            <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars_name</span><span class="p">,</span> <span class="s1">&#39;profile&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="p">)</span>
            <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pars_name</span><span class="p">,</span>
                <span class="s1">&#39;batch-service-role&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_service_role</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>
            <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pars_name</span><span class="p">,</span>
                <span class="s1">&#39;ecs-instance-role&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ecs_instance_role</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>
            <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pars_name</span><span class="p">,</span>
                <span class="s1">&#39;ecs-task-role&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ecs_task_role</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>
            <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pars_name</span><span class="p">,</span> <span class="s1">&#39;spot-fleet-role&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spot_fleet_role</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>
            <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars_name</span><span class="p">,</span> <span class="s1">&#39;vpc&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vpc</span><span class="o">.</span><span class="n">vpc_id</span><span class="p">)</span>
            <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pars_name</span><span class="p">,</span>
                <span class="s1">&#39;security-group&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_security_group</span><span class="o">.</span><span class="n">security_group_id</span>
            <span class="p">)</span>

            <span class="c1"># Save config to file</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">get_config_file</span><span class="p">(),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pars_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The section name for this PARS in the cloudknot config file&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pars_name</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_role_setter</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Static method to return setter methods for new IamRoles&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">set_role</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_role</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Setter method to attach new IAM role to this PARS</span>

<span class="sd">            This method clobbers the old role and adopts the new one.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            new_role :</span>
<span class="sd">                new IamRole instance to attach to this Pars</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            None</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clobbered</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">aws</span><span class="o">.</span><span class="n">ResourceClobberedException</span><span class="p">(</span>
                    <span class="s1">&#39;This PARS has already been clobbered.&#39;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
                <span class="p">)</span>

            <span class="c1"># Verify input</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_role</span><span class="p">,</span> <span class="n">aws</span><span class="o">.</span><span class="n">IamRole</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;new role must be an instance of IamRole&#39;</span><span class="p">)</span>

            <span class="n">old_role</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">old_role</span><span class="o">.</span><span class="n">profile</span> <span class="o">!=</span> <span class="n">new_role</span><span class="o">.</span><span class="n">profile</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">aws</span><span class="o">.</span><span class="n">ProfileException</span><span class="p">(</span><span class="n">new_role</span><span class="o">.</span><span class="n">profile</span><span class="p">)</span>

            <span class="n">mod_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;You are setting a new role for PARS </span><span class="si">{name:s}</span><span class="s1">. The old &#39;</span>
                <span class="s1">&#39;role </span><span class="si">{role_name:s}</span><span class="s1"> will be clobbered.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">role_name</span><span class="o">=</span><span class="n">old_role</span><span class="o">.</span><span class="n">name</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># Delete the old role</span>
            <span class="n">old_role</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>

            <span class="c1"># Set the new role attribute</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">new_role</span><span class="p">)</span>

            <span class="c1"># Replace the appropriate line in the config file</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
            <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">get_config_file</span><span class="p">())</span>
            <span class="n">field_name</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
            <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars_name</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">new_role</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">get_config_file</span><span class="p">(),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

            <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;PARS </span><span class="si">{name:s}</span><span class="s1"> adopted new role </span><span class="si">{role_name:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">role_name</span><span class="o">=</span><span class="n">new_role</span><span class="o">.</span><span class="n">name</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">set_role</span>

    <span class="n">batch_service_role</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span>
        <span class="n">fget</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;_batch_service_role&#39;</span><span class="p">),</span>
        <span class="n">fset</span><span class="o">=</span><span class="n">_role_setter</span><span class="o">.</span><span class="vm">__func__</span><span class="p">(</span><span class="s1">&#39;_batch_service_role&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">ecs_instance_role</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span>
        <span class="n">fget</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;_ecs_instance_role&#39;</span><span class="p">),</span>
        <span class="n">fset</span><span class="o">=</span><span class="n">_role_setter</span><span class="o">.</span><span class="vm">__func__</span><span class="p">(</span><span class="s1">&#39;_ecs_instance_role&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">ecs_task_role</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span>
        <span class="n">fget</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;_ecs_task_role&#39;</span><span class="p">),</span>
        <span class="n">fset</span><span class="o">=</span><span class="n">_role_setter</span><span class="o">.</span><span class="vm">__func__</span><span class="p">(</span><span class="s1">&#39;_ecs_task_role&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">spot_fleet_role</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span>
        <span class="n">fget</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;_spot_fleet_role&#39;</span><span class="p">),</span>
        <span class="n">fset</span><span class="o">=</span><span class="n">_role_setter</span><span class="o">.</span><span class="vm">__func__</span><span class="p">(</span><span class="s1">&#39;_spot_fleet_role&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vpc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The Vpc instance attached to this PARS&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vpc</span>

    <span class="nd">@vpc</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">vpc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setter method to attach new VPC to this PARS</span>

<span class="sd">        This method clobbers the old VPC and adopts the new one.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        v : Vpc</span>
<span class="sd">            new Vpc instance to attach to this Pars</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clobbered</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">aws</span><span class="o">.</span><span class="n">ResourceClobberedException</span><span class="p">(</span>
                <span class="s1">&#39;This PARS has already been clobbered.&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">aws</span><span class="o">.</span><span class="n">Vpc</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;new vpc must be an instance of Vpc&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">region</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vpc</span><span class="o">.</span><span class="n">region</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">aws</span><span class="o">.</span><span class="n">RegionException</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">region</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">profile</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vpc</span><span class="o">.</span><span class="n">profile</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">aws</span><span class="o">.</span><span class="n">ProfileException</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">profile</span><span class="p">)</span>

        <span class="n">mod_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s1">&#39;You are setting a new VPC for PARS </span><span class="si">{name:s}</span><span class="s1">. The old &#39;</span>
            <span class="s1">&#39;VPC </span><span class="si">{vpc_id:s}</span><span class="s1"> will be clobbered.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">vpc_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vpc</span><span class="o">.</span><span class="n">vpc_id</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># We have to replace the security group too, since it depends on the</span>
        <span class="c1"># VPC. Create a new security group based on the new VPC but with the</span>
        <span class="c1"># old name and description.</span>
        <span class="n">sg_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">security_group</span><span class="o">.</span><span class="n">name</span>
        <span class="n">sg_desc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">security_group</span><span class="o">.</span><span class="n">description</span>

        <span class="c1"># The security group setter method will take care of clobbering the</span>
        <span class="c1"># old security group and updating config, etc.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">security_group</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">SecurityGroup</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">sg_name</span><span class="p">,</span> <span class="n">vpc</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">sg_desc</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vpc</span><span class="o">.</span><span class="n">is_default</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vpc</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_vpc</span> <span class="o">=</span> <span class="n">v</span>

        <span class="c1"># Replace the appropriate line in the config file</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
        <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">get_config_file</span><span class="p">())</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars_name</span><span class="p">,</span> <span class="s1">&#39;vpc&#39;</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">vpc_id</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">get_config_file</span><span class="p">(),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;PARS </span><span class="si">{name:s}</span><span class="s1"> adopted new VPC </span><span class="si">{vpcid:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">vpcid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vpc</span><span class="o">.</span><span class="n">vpc_id</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">security_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The SecurityGroup instance attached to this PARS&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_security_group</span>

    <span class="nd">@security_group</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">security_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setter method to attach new security group to this PARS</span>

<span class="sd">        This method clobbers the old security group and adopts the new one.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sg : SecurityGroup</span>
<span class="sd">            new SecurityGroup instance to attach to this Pars</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clobbered</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">aws</span><span class="o">.</span><span class="n">ResourceClobberedException</span><span class="p">(</span>
                <span class="s1">&#39;This PARS has already been clobbered.&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sg</span><span class="p">,</span> <span class="n">aws</span><span class="o">.</span><span class="n">SecurityGroup</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;new security group must be an instance of &#39;</span>
                             <span class="s1">&#39;SecurityGroup&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sg</span><span class="o">.</span><span class="n">region</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_security_group</span><span class="o">.</span><span class="n">region</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">aws</span><span class="o">.</span><span class="n">RegionException</span><span class="p">(</span><span class="n">sg</span><span class="o">.</span><span class="n">region</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sg</span><span class="o">.</span><span class="n">profile</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_security_group</span><span class="o">.</span><span class="n">profile</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">aws</span><span class="o">.</span><span class="n">ProfileException</span><span class="p">(</span><span class="n">sg</span><span class="o">.</span><span class="n">profile</span><span class="p">)</span>

        <span class="n">mod_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s1">&#39;You are setting a new security group for PARS </span><span class="si">{name:s}</span><span class="s1">. The old &#39;</span>
            <span class="s1">&#39;security group </span><span class="si">{sg_id:s}</span><span class="s1"> will be clobbered.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">sg_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">security_group</span><span class="o">.</span><span class="n">security_group_id</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">old_sg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_security_group</span>
        <span class="n">old_sg</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_security_group</span> <span class="o">=</span> <span class="n">sg</span>

        <span class="c1"># Replace the appropriate line in the config file</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
        <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">get_config_file</span><span class="p">())</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars_name</span><span class="p">,</span> <span class="s1">&#39;security-group&#39;</span><span class="p">,</span> <span class="n">sg</span><span class="o">.</span><span class="n">security_group_id</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">get_config_file</span><span class="p">(),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;PARS </span><span class="si">{name:s}</span><span class="s1"> adopted new security group </span><span class="si">{sgid:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">sgid</span><span class="o">=</span><span class="n">sg</span><span class="o">.</span><span class="n">security_group_id</span>
            <span class="p">)</span>
        <span class="p">)</span>

<div class="viewcode-block" id="Pars.clobber"><a class="viewcode-back" href="../../documentation.html#cloudknot.Pars.clobber">[docs]</a>    <span class="k">def</span> <span class="nf">clobber</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete associated AWS resources and remove section from config&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clobbered</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_profile_and_region</span><span class="p">()</span>

        <span class="c1"># Delete all associated AWS resources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_security_group</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vpc</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_spot_fleet_role</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ecs_task_role</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ecs_instance_role</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_batch_service_role</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>

        <span class="c1"># Remove this section from the config file</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
        <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">get_config_file</span><span class="p">())</span>
        <span class="n">config</span><span class="o">.</span><span class="n">remove_section</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pars_name</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">get_config_file</span><span class="p">(),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="c1"># Set the clobbered parameter to True,</span>
        <span class="c1"># preventing subsequent method calls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clobbered</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Clobbered PARS </span><span class="si">{name:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span></div></div>


<span class="c1"># noinspection PyPropertyAccess,PyAttributeOutsideInit</span>
<div class="viewcode-block" id="Knot"><a class="viewcode-back" href="../../documentation.html#cloudknot.Knot">[docs]</a><span class="k">class</span> <span class="nc">Knot</span><span class="p">(</span><span class="n">aws</span><span class="o">.</span><span class="n">NamedObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A collection of resources and methods to submit jobs to AWS Batch</span>

<span class="sd">    This object collects AWS resources that should be created once for each</span>
<span class="sd">    type of batch run. The resource set consists of a PARS; a docker image</span>
<span class="sd">    made from an input function or python script; a remote docker repo to</span>
<span class="sd">    house said image; and an AWS batch job definition, compute environment,</span>
<span class="sd">    and job queue. It also contains methods to submit batch jobs for a range</span>
<span class="sd">    of arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">pars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pars_policies</span><span class="o">=</span><span class="p">(),</span>
                 <span class="n">docker_image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">image_script_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">image_work_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">repo_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">image_tags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">job_definition_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">job_def_vcpus</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">retries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_environment_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">instance_types</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resource_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_vcpus</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">max_vcpus</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">desired_vcpus</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">image_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">ec2_key_pair</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ce_tags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bid_percentage</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">job_queue_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize a Knot instance</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str, optional</span>
<span class="sd">            The name for this knot</span>
<span class="sd">            Default=&#39;default&#39;</span>

<span class="sd">        pars : Pars, optional</span>
<span class="sd">            The PARS on which to base this knot&#39;s AWS resources</span>
<span class="sd">            Default: instance returned by Pars()</span>

<span class="sd">        pars_policies : tuple of strings</span>
<span class="sd">            tuple of names of AWS policies to attach to each role</span>
<span class="sd">            Default: ()</span>

<span class="sd">        docker_image : DockerImage, optional</span>
<span class="sd">            The pre-existing DockerImage instance to adopt</span>

<span class="sd">        func : function</span>
<span class="sd">            Python function to be dockerized</span>

<span class="sd">        image_script_path : str</span>
<span class="sd">            Path to file with python script to be dockerized</span>

<span class="sd">        image_work_dir : string</span>
<span class="sd">            Directory to store Dockerfile, requirements.txt, and python</span>
<span class="sd">            script with CLI</span>
<span class="sd">            Default: parent directory of script if `script_path` is provided</span>
<span class="sd">            else DockerImage creates a new directory, accessible by the</span>
<span class="sd">            `docker_image.build_path` property.</span>

<span class="sd">        username : string</span>
<span class="sd">            default username created in Dockerfile and in batch job definition</span>
<span class="sd">            Default: &#39;cloudknot-user&#39;</span>

<span class="sd">        repo_name : str, optional</span>
<span class="sd">            Name of the AWS ECR repository to store the created Docker image</span>
<span class="sd">            Default: &#39;cloudknot/&#39; + self.docker_image.images[0][&#39;name&#39;]</span>

<span class="sd">        image_tags : str or sequence of str</span>
<span class="sd">            Tags to be applied to this Docker image</span>

<span class="sd">        job_definition_name : str, optional</span>
<span class="sd">            Name for this knot&#39;s AWS Batch job definition</span>
<span class="sd">            Default: name + &#39;-cloudknot-compute-environment&#39;</span>

<span class="sd">        job_def_vcpus : int, optional</span>
<span class="sd">            number of virtual cpus to be used to this knot&#39;s job definition</span>
<span class="sd">            Default: 1</span>

<span class="sd">        memory : int, optional</span>
<span class="sd">            memory (MiB) to be used for this knot&#39;s job definition</span>
<span class="sd">            Default: 8000</span>

<span class="sd">        retries : int, optional</span>
<span class="sd">            number of times a job can be moved to &#39;RUNNABLE&#39; status.</span>
<span class="sd">            May be between 1 and 10</span>
<span class="sd">            Default: 1</span>

<span class="sd">        compute_environment_name : str</span>
<span class="sd">            Name for this knot&#39;s AWS Batch compute environment</span>
<span class="sd">            Default: name + &#39;-cloudknot-compute-environment&#39;</span>

<span class="sd">        instance_types : string or sequence of strings, optional</span>
<span class="sd">            Compute environment instance types</span>
<span class="sd">            Default: (&#39;optimal&#39;,)</span>

<span class="sd">        resource_type : &#39;EC2&#39; or &#39;SPOT&#39;</span>
<span class="sd">            Compute environment resource type, either &quot;EC2&quot; or &quot;SPOT&quot;</span>
<span class="sd">            Default: &#39;EC2&#39;</span>

<span class="sd">        min_vcpus : int, optional</span>
<span class="sd">            minimum number of virtual cpus for instances launched in this</span>
<span class="sd">            compute environment</span>
<span class="sd">            Default: 0</span>

<span class="sd">        max_vcpus : int, optional</span>
<span class="sd">            maximum number of virtual cpus for instances launched in this</span>
<span class="sd">            compute environment</span>
<span class="sd">            Default: 256</span>

<span class="sd">        desired_vcpus : int, optional</span>
<span class="sd">            desired number of virtual cpus for instances launched in this</span>
<span class="sd">            compute environment</span>
<span class="sd">            Default: 8</span>

<span class="sd">        image_id : string or None, optional</span>
<span class="sd">            optional AMI id used for instances launched in this compute</span>
<span class="sd">            environment</span>
<span class="sd">            Default: None</span>

<span class="sd">        ec2_key_pair : string or None, optional</span>
<span class="sd">            optional EC2 key pair used for instances launched in this compute</span>
<span class="sd">            environment</span>
<span class="sd">            Default: None</span>

<span class="sd">        tags : dictionary or None, optional</span>
<span class="sd">            optional key-value pair tags to be applied to resources in this</span>
<span class="sd">            compute environment</span>
<span class="sd">            Default: None</span>

<span class="sd">        bid_percentage : int, optional</span>
<span class="sd">            Compute environment bid percentage if using spot instances</span>
<span class="sd">            Default: 50</span>

<span class="sd">        job_queue_name : str, optional</span>
<span class="sd">            Name for this knot&#39;s AWS Batch job queue</span>
<span class="sd">            Default: name + &#39;-cloudknot-job-queue&#39;</span>

<span class="sd">        priority : int, optional</span>
<span class="sd">            Default priority for jobs in this knot&#39;s job queue</span>
<span class="sd">            Default: 1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate name input</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Knot name must be a string. You passed a &#39;</span>
                             <span class="s1">&#39;</span><span class="si">{t!s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Knot</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_knot_name</span> <span class="o">=</span> <span class="s1">&#39;knot &#39;</span> <span class="o">+</span> <span class="n">name</span>

        <span class="n">image_tags</span> <span class="o">=</span> <span class="n">image_tags</span> <span class="k">if</span> <span class="n">image_tags</span> <span class="k">else</span> <span class="p">[</span><span class="s1">&#39;cloudknot&#39;</span><span class="p">]</span>

        <span class="c1"># Check for existence of this pars in the config file</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
        <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">get_config_file</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_knot_name</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">sections</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span>
                <span class="n">pars</span><span class="p">,</span> <span class="n">pars_policies</span><span class="p">,</span> <span class="n">docker_image</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">image_script_path</span><span class="p">,</span>
                <span class="n">image_work_dir</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">repo_name</span><span class="p">,</span> <span class="n">job_definition_name</span><span class="p">,</span>
                <span class="n">job_def_vcpus</span><span class="p">,</span> <span class="n">memory</span><span class="p">,</span> <span class="n">retries</span><span class="p">,</span> <span class="n">compute_environment_name</span><span class="p">,</span>
                <span class="n">instance_types</span><span class="p">,</span> <span class="n">resource_type</span><span class="p">,</span> <span class="n">min_vcpus</span><span class="p">,</span> <span class="n">max_vcpus</span><span class="p">,</span>
                <span class="n">desired_vcpus</span><span class="p">,</span> <span class="n">image_id</span><span class="p">,</span> <span class="n">ec2_key_pair</span><span class="p">,</span> <span class="n">ce_tags</span><span class="p">,</span> <span class="n">bid_percentage</span><span class="p">,</span>
                <span class="n">job_queue_name</span><span class="p">,</span> <span class="n">priority</span>
            <span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You specified configuration arguments for &#39;</span>
                                 <span class="s1">&#39;a knot that already exists. To create a &#39;</span>
                                 <span class="s1">&#39;new knot, please choose a new name or &#39;</span>
                                 <span class="s1">&#39;clobber the pre-existing knot.&#39;</span><span class="p">)</span>

            <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Found knot </span><span class="si">{name:s}</span><span class="s1"> in config&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_region</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_knot_name</span><span class="p">,</span> <span class="s1">&#39;region&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_profile</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_knot_name</span><span class="p">,</span> <span class="s1">&#39;profile&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_profile_and_region</span><span class="p">()</span>

            <span class="n">pars_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_knot_name</span><span class="p">,</span> <span class="s1">&#39;pars&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pars</span> <span class="o">=</span> <span class="n">Pars</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">pars_name</span><span class="p">)</span>
            <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Knot </span><span class="si">{name:s}</span><span class="s1"> adopted PARS &#39;</span>
                            <span class="s1">&#39;</span><span class="si">{p:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

            <span class="n">image_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_knot_name</span><span class="p">,</span> <span class="s1">&#39;docker-image&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_docker_image</span> <span class="o">=</span> <span class="n">dockerimage</span><span class="o">.</span><span class="n">DockerImage</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">image_name</span><span class="p">)</span>
            <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Knot </span><span class="si">{name:s}</span><span class="s1"> adopted docker image </span><span class="si">{dr:s}</span><span class="s1">&#39;</span>
                            <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dr</span><span class="o">=</span><span class="n">image_name</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">docker_image</span><span class="o">.</span><span class="n">images</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">docker_image</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="n">image_tags</span><span class="p">)</span>
                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;knot </span><span class="si">{name:s}</span><span class="s1"> built docker image </span><span class="si">{i!s}</span><span class="s1">&#39;</span>
                    <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">docker_image</span><span class="o">.</span><span class="n">images</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">docker_image</span><span class="o">.</span><span class="n">repo_uri</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">repo_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_knot_name</span><span class="p">,</span> <span class="s1">&#39;docker-repo&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_docker_repo</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">DockerRepo</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">repo_name</span><span class="p">)</span>
                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Knot </span><span class="si">{name:s}</span><span class="s1"> adopted docker repository &#39;</span>
                                <span class="s1">&#39;</span><span class="si">{dr:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dr</span><span class="o">=</span><span class="n">repo_name</span><span class="p">))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">docker_image</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">repo</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">docker_repo</span><span class="p">)</span>
                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Knot </span><span class="si">{name:s}</span><span class="s1"> pushed docker image </span><span class="si">{dr:s}</span><span class="s1">&#39;</span>
                    <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">docker_image</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_docker_repo</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">jd_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_knot_name</span><span class="p">,</span> <span class="s1">&#39;job-definition&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_job_definition</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">JobDefinition</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">jd_name</span><span class="p">)</span>
            <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Knot </span><span class="si">{name:s}</span><span class="s1"> adopted job definition &#39;</span>
                            <span class="s1">&#39;</span><span class="si">{jd:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">jd</span><span class="o">=</span><span class="n">jd_name</span><span class="p">))</span>

            <span class="n">ce_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_knot_name</span><span class="p">,</span> <span class="s1">&#39;compute-environment&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compute_environment</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">ComputeEnvironment</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">ce_name</span><span class="p">)</span>
            <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Knot </span><span class="si">{name:s}</span><span class="s1"> adopted compute environment &#39;</span>
                            <span class="s1">&#39;</span><span class="si">{ce:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ce</span><span class="o">=</span><span class="n">ce_name</span><span class="p">))</span>

            <span class="n">jq_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_knot_name</span><span class="p">,</span> <span class="s1">&#39;job-queue&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_job_queue</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">JobQueue</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">jq_name</span><span class="p">)</span>
            <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Knot </span><span class="si">{name:s}</span><span class="s1"> adopted job queue </span><span class="si">{q:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="n">jq_name</span>
            <span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_job_ids</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_knot_name</span><span class="p">,</span> <span class="s1">&#39;job_ids&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_jobs</span> <span class="o">=</span> <span class="p">[</span><span class="n">aws</span><span class="o">.</span><span class="n">BatchJob</span><span class="p">(</span><span class="n">job_id</span><span class="o">=</span><span class="n">jid</span><span class="p">)</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_ids</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">job_definition_name</span> <span class="o">=</span> <span class="n">job_definition_name</span> <span class="k">if</span> <span class="n">job_definition_name</span> \
                <span class="k">else</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;-cloudknot-job-definition&#39;</span>
            <span class="n">compute_environment_name</span> <span class="o">=</span> <span class="n">compute_environment_name</span> \
                <span class="k">if</span> <span class="n">compute_environment_name</span> \
                <span class="k">else</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;-cloudknot-compute-environment&#39;</span>
            <span class="n">job_queue_name</span> <span class="o">=</span> <span class="n">job_queue_name</span> <span class="k">if</span> <span class="n">job_queue_name</span> \
                <span class="k">else</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;-cloudknot-job-queue&#39;</span>

            <span class="c1"># Validate and set the PARS</span>
            <span class="k">if</span> <span class="n">pars</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="n">Pars</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;pars must be a Pars instance.&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pars</span> <span class="o">=</span> <span class="n">pars</span>
                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;knot </span><span class="si">{name:s}</span><span class="s1"> adopted PARS </span><span class="si">{p:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="o">.</span><span class="n">name</span>
                <span class="p">))</span>
                <span class="n">pars_cleanup</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pars</span> <span class="o">=</span> <span class="n">Pars</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">policies</span><span class="o">=</span><span class="n">pars_policies</span><span class="p">)</span>
                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;knot </span><span class="si">{name:s}</span><span class="s1"> created PARS </span><span class="si">{p:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="o">.</span><span class="n">name</span>
                <span class="p">))</span>
                <span class="n">pars_cleanup</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">docker_image</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">func</span><span class="p">,</span> <span class="n">image_script_path</span><span class="p">,</span> <span class="n">image_work_dir</span><span class="p">]):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;you gave redundant, possibly conflicting input: &#39;</span>
                        <span class="s1">&#39;`docker_image` and one of [`func`, &#39;</span>
                        <span class="s1">&#39;`image_script_path`, `image_work_dir`]&#39;</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">docker_image</span><span class="p">,</span> <span class="n">dockerimage</span><span class="o">.</span><span class="n">DockerImage</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;docker_image must be a cloudknot &#39;</span>
                                     <span class="s1">&#39;DockerImage instance.&#39;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_docker_image</span> <span class="o">=</span> <span class="n">docker_image</span>
                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Knot </span><span class="si">{name:s}</span><span class="s1"> adopted docker image </span><span class="si">{i:s}</span><span class="s1">&#39;</span>
                                <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">docker_image</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Create and build the docker image</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_docker_image</span> <span class="o">=</span> <span class="n">dockerimage</span><span class="o">.</span><span class="n">DockerImage</span><span class="p">(</span>
                    <span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="p">,</span>
                    <span class="n">script_path</span><span class="o">=</span><span class="n">image_script_path</span><span class="p">,</span>
                    <span class="n">dir_name</span><span class="o">=</span><span class="n">image_work_dir</span><span class="p">,</span>
                    <span class="n">username</span><span class="o">=</span><span class="n">username</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">docker_image</span><span class="o">.</span><span class="n">images</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">docker_image</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="n">image_tags</span><span class="p">)</span>
                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;knot </span><span class="si">{name:s}</span><span class="s1"> built docker image </span><span class="si">{i!s}</span><span class="s1">&#39;</span>
                    <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">docker_image</span><span class="o">.</span><span class="n">images</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">docker_image</span><span class="o">.</span><span class="n">repo_uri</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Create the remote repo</span>
                <span class="n">repo_name</span> <span class="o">=</span> <span class="p">(</span><span class="n">repo_name</span> <span class="k">if</span> <span class="n">repo_name</span>
                             <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">docker_image</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>

                <span class="c1"># Later in __init__, we may abort this init because of</span>
                <span class="c1"># inconsistent job def, compute env, or job queue parameters</span>
                <span class="c1"># If we do that, we don&#39;t want to leave a bunch of newly</span>
                <span class="c1"># created resources around so keep track of whether this repo</span>
                <span class="c1"># was created or adopted.</span>
                <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s1">&#39;docker-repos&#39;</span><span class="p">,</span> <span class="n">repo_name</span><span class="p">):</span>
                    <span class="c1"># Pre-existing repo, no cleanup necessary</span>
                    <span class="n">repo_cleanup</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Freshly created repo, cleanup necessary</span>
                    <span class="n">repo_cleanup</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_docker_repo</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">DockerRepo</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">repo_name</span><span class="p">)</span>

                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;knot </span><span class="si">{name:s}</span><span class="s1"> created/adopted docker repo &#39;</span>
                    <span class="s1">&#39;</span><span class="si">{r:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">docker_repo</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="c1"># Push to remote repo</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">docker_image</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">repo</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">docker_repo</span><span class="p">)</span>

                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;knot </span><span class="si">{name:s}</span><span class="s2"> pushed it&#39;s docker image to the repo &quot;</span>
                    <span class="s2">&quot;</span><span class="si">{r:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">docker_repo</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">repo_cleanup</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_docker_repo</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Create job definition</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_job_definition</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">JobDefinition</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">job_definition_name</span><span class="p">,</span>
                    <span class="n">job_role</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="o">.</span><span class="n">ecs_task_role</span><span class="p">,</span>
                    <span class="n">docker_image</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">docker_image</span><span class="o">.</span><span class="n">repo_uri</span><span class="p">,</span>
                    <span class="n">vcpus</span><span class="o">=</span><span class="n">job_def_vcpus</span><span class="p">,</span>
                    <span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">,</span>
                    <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
                    <span class="n">retries</span><span class="o">=</span><span class="n">retries</span>
                <span class="p">)</span>

                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;knot </span><span class="si">{name:s}</span><span class="s1"> created job definition </span><span class="si">{jd:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">jd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_definition</span><span class="o">.</span><span class="n">name</span>
                    <span class="p">)</span>
                <span class="p">)</span>

                <span class="c1"># Later in __init__, we may abort this init because of</span>
                <span class="c1"># inconsistent compute env, or job queue parameters</span>
                <span class="c1"># If we do that, we don&#39;t want to leave a bunch of newly</span>
                <span class="c1"># created resources around so keep track of whether this job</span>
                <span class="c1"># def was created or adopted. Here, we created it, so cleanup</span>
                <span class="c1"># is needed</span>
                <span class="n">jd_cleanup</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="n">aws</span><span class="o">.</span><span class="n">ResourceExistsException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Job def already exists, retrieve it</span>
                <span class="n">jd</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">JobDefinition</span><span class="p">(</span><span class="n">arn</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">resource_id</span><span class="p">)</span>

                <span class="c1"># But confirm that all of the properties match the input</span>
                <span class="c1"># or that the input was unspecified (i.e. is None)</span>
                <span class="n">eq_role</span> <span class="o">=</span> <span class="n">jd</span><span class="o">.</span><span class="n">job_role_arn</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="o">.</span><span class="n">ecs_task_role</span><span class="o">.</span><span class="n">arn</span>
                <span class="n">eq_image</span> <span class="o">=</span> <span class="n">jd</span><span class="o">.</span><span class="n">docker_image</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">docker_image</span><span class="o">.</span><span class="n">repo_uri</span>
                <span class="n">eq_vcpus</span> <span class="o">=</span> <span class="n">job_def_vcpus</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">jd</span><span class="o">.</span><span class="n">vcpus</span> <span class="o">==</span> <span class="n">job_def_vcpus</span>
                <span class="n">eq_retries</span> <span class="o">=</span> <span class="n">retries</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">jd</span><span class="o">.</span><span class="n">retries</span> <span class="o">==</span> <span class="n">retries</span>
                <span class="n">eq_mem</span> <span class="o">=</span> <span class="n">memory</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">jd</span><span class="o">.</span><span class="n">memory</span> <span class="o">==</span> <span class="n">memory</span>
                <span class="n">eq_user</span> <span class="o">=</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">jd</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">username</span>

                <span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;job role matches&#39;</span><span class="p">:</span> <span class="n">eq_role</span><span class="p">,</span>
                    <span class="s1">&#39;docker image matches&#39;</span><span class="p">:</span> <span class="n">eq_image</span><span class="p">,</span>
                    <span class="s1">&#39;VCPUs match&#39;</span><span class="p">:</span> <span class="n">eq_vcpus</span><span class="p">,</span>
                    <span class="s1">&#39;retries match&#39;</span><span class="p">:</span> <span class="n">eq_retries</span><span class="p">,</span>
                    <span class="s1">&#39;memory matches&#39;</span><span class="p">:</span> <span class="n">eq_mem</span><span class="p">,</span>
                    <span class="s1">&#39;username matches&#39;</span><span class="p">:</span> <span class="n">eq_user</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">matches</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="n">repo_cleanup</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">docker_repo</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">pars_cleanup</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>

                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;The requested job definition already exists but &#39;</span>
                        <span class="s1">&#39;does not match the input parameters. &#39;</span>
                        <span class="s1">&#39;</span><span class="si">{matches!s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">matches</span><span class="o">=</span><span class="n">matches</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_job_definition</span> <span class="o">=</span> <span class="n">jd</span>
                <span class="c1"># jd_cleanup description is same as above. Here, we adopted it,</span>
                <span class="c1"># so cleanup isn&#39;t needed</span>
                <span class="n">jd_cleanup</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;knot </span><span class="si">{name:s}</span><span class="s1"> adopted job definition </span><span class="si">{jd:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">jd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_definition</span><span class="o">.</span><span class="n">name</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_definition</span><span class="o">.</span><span class="n">username</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">docker_image</span><span class="o">.</span><span class="n">username</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The username for this knot&#39;s job definition &quot;</span>
                                 <span class="s2">&quot;does not match the username for this knot&#39;s &quot;</span>
                                 <span class="s2">&quot;Docker image.&quot;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Create compute environment</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_compute_environment</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">ComputeEnvironment</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">compute_environment_name</span><span class="p">,</span>
                    <span class="n">batch_service_role</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="o">.</span><span class="n">batch_service_role</span><span class="p">,</span>
                    <span class="n">instance_role</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="o">.</span><span class="n">ecs_instance_role</span><span class="p">,</span>
                    <span class="n">vpc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="o">.</span><span class="n">vpc</span><span class="p">,</span>
                    <span class="n">security_group</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="o">.</span><span class="n">security_group</span><span class="p">,</span>
                    <span class="n">spot_fleet_role</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="o">.</span><span class="n">spot_fleet_role</span><span class="p">,</span>
                    <span class="n">instance_types</span><span class="o">=</span><span class="n">instance_types</span><span class="p">,</span>
                    <span class="n">resource_type</span><span class="o">=</span><span class="n">resource_type</span><span class="p">,</span>
                    <span class="n">min_vcpus</span><span class="o">=</span><span class="n">min_vcpus</span><span class="p">,</span>
                    <span class="n">max_vcpus</span><span class="o">=</span><span class="n">max_vcpus</span><span class="p">,</span>
                    <span class="n">desired_vcpus</span><span class="o">=</span><span class="n">desired_vcpus</span><span class="p">,</span>
                    <span class="n">image_id</span><span class="o">=</span><span class="n">image_id</span><span class="p">,</span>
                    <span class="n">ec2_key_pair</span><span class="o">=</span><span class="n">ec2_key_pair</span><span class="p">,</span>
                    <span class="n">tags</span><span class="o">=</span><span class="n">ce_tags</span><span class="p">,</span>
                    <span class="n">bid_percentage</span><span class="o">=</span><span class="n">bid_percentage</span>
                <span class="p">)</span>

                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;knot </span><span class="si">{name:s}</span><span class="s1"> created compute environment </span><span class="si">{ce:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ce</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_environment</span><span class="o">.</span><span class="n">name</span>
                    <span class="p">)</span>
                <span class="p">)</span>

                <span class="c1"># ce_cleanup logic same as for jd_cleanup</span>
                <span class="n">ce_cleanup</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="n">aws</span><span class="o">.</span><span class="n">ResourceExistsException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Compute environment already exists, retrieve it</span>
                <span class="n">ce</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">ComputeEnvironment</span><span class="p">(</span><span class="n">arn</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">resource_id</span><span class="p">)</span>

                <span class="c1"># But confirm that all of the properties match the input</span>
                <span class="c1"># or that the input was unspecified (i.e. is None)</span>
                <span class="n">eq_bsr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ce</span><span class="o">.</span><span class="n">batch_service_role_arn</span>
                          <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="o">.</span><span class="n">batch_service_role</span><span class="o">.</span><span class="n">arn</span><span class="p">)</span>
                <span class="n">eq_eir</span> <span class="o">=</span> <span class="p">(</span><span class="n">ce</span><span class="o">.</span><span class="n">instance_role_arn</span>
                          <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="o">.</span><span class="n">ecs_instance_role</span><span class="o">.</span><span class="n">instance_profile_arn</span><span class="p">)</span>
                <span class="n">eq_vpc</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ce</span><span class="o">.</span><span class="n">subnets</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="o">.</span><span class="n">vpc</span><span class="o">.</span><span class="n">subnet_ids</span><span class="p">)</span>
                <span class="n">eq_sg</span> <span class="o">=</span> <span class="p">(</span><span class="n">ce</span><span class="o">.</span><span class="n">security_group_ids</span>
                         <span class="o">==</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="o">.</span><span class="n">security_group</span><span class="o">.</span><span class="n">security_group_id</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">resource_type</span> <span class="o">==</span> <span class="s1">&#39;SPOT&#39;</span><span class="p">:</span>
                    <span class="n">eq_sfr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ce</span><span class="o">.</span><span class="n">spot_fleet_role_arn</span>
                              <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="o">.</span><span class="n">spot_fleet_role</span><span class="o">.</span><span class="n">arn</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">eq_sfr</span> <span class="o">=</span> <span class="n">ce</span><span class="o">.</span><span class="n">spot_fleet_role_arn</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="n">eq_it</span> <span class="o">=</span> <span class="p">(</span><span class="n">instance_types</span> <span class="ow">is</span> <span class="kc">None</span>
                         <span class="ow">or</span> <span class="n">ce</span><span class="o">.</span><span class="n">instance_types</span> <span class="o">==</span> <span class="n">instance_types</span><span class="p">)</span>
                <span class="n">eq_rt</span> <span class="o">=</span> <span class="p">(</span><span class="n">resource_type</span> <span class="ow">is</span> <span class="kc">None</span>
                         <span class="ow">or</span> <span class="n">ce</span><span class="o">.</span><span class="n">resource_type</span> <span class="o">==</span> <span class="n">resource_type</span><span class="p">)</span>
                <span class="n">eq_min_vcpus</span> <span class="o">=</span> <span class="n">min_vcpus</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ce</span><span class="o">.</span><span class="n">min_vcpus</span> <span class="o">==</span> <span class="n">min_vcpus</span>
                <span class="n">eq_max_vcpus</span> <span class="o">=</span> <span class="n">max_vcpus</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ce</span><span class="o">.</span><span class="n">max_vcpus</span> <span class="o">==</span> <span class="n">max_vcpus</span>
                <span class="n">eq_des_vcpus</span> <span class="o">=</span> <span class="p">(</span><span class="n">desired_vcpus</span> <span class="ow">is</span> <span class="kc">None</span>
                                <span class="ow">or</span> <span class="n">ce</span><span class="o">.</span><span class="n">desired_vcpus</span> <span class="o">==</span> <span class="n">desired_vcpus</span><span class="p">)</span>
                <span class="n">eq_image_id</span> <span class="o">=</span> <span class="n">image_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ce</span><span class="o">.</span><span class="n">image_id</span> <span class="o">==</span> <span class="n">image_id</span>
                <span class="n">eq_kp</span> <span class="o">=</span> <span class="n">ec2_key_pair</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ce</span><span class="o">.</span><span class="n">ec2_key_pair</span> <span class="o">==</span> <span class="n">ec2_key_pair</span>
                <span class="n">eq_tags</span> <span class="o">=</span> <span class="n">ce_tags</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ce</span><span class="o">.</span><span class="n">tags</span> <span class="o">==</span> <span class="n">ce_tags</span>
                <span class="n">eq_bp</span> <span class="o">=</span> <span class="p">(</span><span class="n">bid_percentage</span> <span class="ow">is</span> <span class="kc">None</span>
                         <span class="ow">or</span> <span class="n">ce</span><span class="o">.</span><span class="n">bid_percentage</span> <span class="o">==</span> <span class="n">bid_percentage</span><span class="p">)</span>

                <span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;batch service role matches&#39;</span><span class="p">:</span> <span class="n">eq_bsr</span><span class="p">,</span>
                    <span class="s1">&#39;instance profile matches&#39;</span><span class="p">:</span> <span class="n">eq_eir</span><span class="p">,</span>
                    <span class="s1">&#39;subnets match&#39;</span><span class="p">:</span> <span class="n">eq_vpc</span><span class="p">,</span>
                    <span class="s1">&#39;security groups match&#39;</span><span class="p">:</span> <span class="n">eq_sg</span><span class="p">,</span>
                    <span class="s1">&#39;spot fleet role matches&#39;</span><span class="p">:</span> <span class="n">eq_sfr</span><span class="p">,</span>
                    <span class="s1">&#39;instance types match&#39;</span><span class="p">:</span> <span class="n">eq_it</span><span class="p">,</span>
                    <span class="s1">&#39;resource type matches&#39;</span><span class="p">:</span> <span class="n">eq_rt</span><span class="p">,</span>
                    <span class="s1">&#39;min VCPUs match&#39;</span><span class="p">:</span> <span class="n">eq_min_vcpus</span><span class="p">,</span>
                    <span class="s1">&#39;max VCPUs match&#39;</span><span class="p">:</span> <span class="n">eq_max_vcpus</span><span class="p">,</span>
                    <span class="s1">&#39;desired VCPUs match&#39;</span><span class="p">:</span> <span class="n">eq_des_vcpus</span><span class="p">,</span>
                    <span class="s1">&#39;image ID matches&#39;</span><span class="p">:</span> <span class="n">eq_image_id</span><span class="p">,</span>
                    <span class="s1">&#39;EC2 key pair matches&#39;</span><span class="p">:</span> <span class="n">eq_kp</span><span class="p">,</span>
                    <span class="s1">&#39;tags match&#39;</span><span class="p">:</span> <span class="n">eq_tags</span><span class="p">,</span>
                    <span class="s1">&#39;bid percentage matches&#39;</span><span class="p">:</span> <span class="n">eq_bp</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">matches</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="n">repo_cleanup</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">docker_repo</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">jd_cleanup</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">job_definition</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">pars_cleanup</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>

                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;The requested compute environment already exists &#39;</span>
                        <span class="s1">&#39;but does not match the input parameters. &#39;</span>
                        <span class="s1">&#39;</span><span class="si">{matches!s}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">matches</span><span class="o">=</span><span class="n">matches</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_compute_environment</span> <span class="o">=</span> <span class="n">ce</span>
                <span class="c1"># ce_cleanup logic same as for jd_cleanup</span>
                <span class="n">ce_cleanup</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;knot </span><span class="si">{name:s}</span><span class="s1"> adopted compute environment </span><span class="si">{ce:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ce</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_environment</span><span class="o">.</span><span class="n">name</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Create job queue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_job_queue</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">JobQueue</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">job_queue_name</span><span class="p">,</span>
                    <span class="n">compute_environments</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_environment</span><span class="p">,</span>
                    <span class="n">priority</span><span class="o">=</span><span class="n">priority</span>
                <span class="p">)</span>

                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;knot </span><span class="si">{name:s}</span><span class="s1"> created job queue &#39;</span>
                    <span class="s1">&#39;</span><span class="si">{jq:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">jq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_queue</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">aws</span><span class="o">.</span><span class="n">ResourceExistsException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Job queue already exists, retrieve it</span>
                <span class="n">jq</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">JobQueue</span><span class="p">(</span><span class="n">arn</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">resource_id</span><span class="p">)</span>

                <span class="c1"># But confirm that all of the properties match the input</span>
                <span class="c1"># or that the input was unspecified (i.e. is None)</span>
                <span class="n">ce_arns</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;computeEnvironment&#39;</span><span class="p">]</span>
                           <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">jq</span><span class="o">.</span><span class="n">compute_environment_arns</span><span class="p">]</span>
                <span class="n">eq_ce</span> <span class="o">=</span> <span class="n">ce_arns</span> <span class="o">==</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_environment</span><span class="o">.</span><span class="n">arn</span><span class="p">]</span>
                <span class="n">eq_priority</span> <span class="o">=</span> <span class="n">priority</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">jq</span><span class="o">.</span><span class="n">priority</span> <span class="o">==</span> <span class="n">priority</span>

                <span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;compute environment ARNS match&#39;</span><span class="p">:</span> <span class="n">eq_ce</span><span class="p">,</span>
                    <span class="s1">&#39;priority matches&#39;</span><span class="p">:</span> <span class="n">eq_priority</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">matches</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="n">repo_cleanup</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">docker_repo</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">jd_cleanup</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">job_definition</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">ce_cleanup</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">compute_environment</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">pars_cleanup</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>

                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;The requested job queue already exists &#39;</span>
                        <span class="s1">&#39;but does not match the input parameters. &#39;</span>
                        <span class="s1">&#39;</span><span class="si">{matches!s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">matches</span><span class="o">=</span><span class="n">matches</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_job_queue</span> <span class="o">=</span> <span class="n">jq</span>
                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;knot </span><span class="si">{name:s}</span><span class="s1"> adopted job queue &#39;</span>
                    <span class="s1">&#39;</span><span class="si">{jq:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">jq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_queue</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_jobs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_job_ids</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Save the new Knot resources in config object</span>
            <span class="c1"># Use config.set() for python 2.7 compatibility</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
            <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">get_config_file</span><span class="p">())</span>
            <span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_knot_name</span><span class="p">)</span>
            <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_knot_name</span><span class="p">,</span> <span class="s1">&#39;region&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">)</span>
            <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_knot_name</span><span class="p">,</span> <span class="s1">&#39;profile&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="p">)</span>
            <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_knot_name</span><span class="p">,</span> <span class="s1">&#39;pars&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_knot_name</span><span class="p">,</span> <span class="s1">&#39;docker-image&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">docker_image</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_knot_name</span><span class="p">,</span> <span class="s1">&#39;docker-repo&#39;</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">docker_repo</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">docker_repo</span> <span class="k">else</span> <span class="s1">&#39;None&#39;</span><span class="p">)</span>
            <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_knot_name</span><span class="p">,</span> <span class="s1">&#39;job-definition&#39;</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">job_definition</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_knot_name</span><span class="p">,</span> <span class="s1">&#39;compute-environment&#39;</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">compute_environment</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_knot_name</span><span class="p">,</span> <span class="s1">&#39;job-queue&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_queue</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_knot_name</span><span class="p">,</span> <span class="s1">&#39;job_ids&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="c1"># Save config to file</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">get_config_file</span><span class="p">(),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="c1"># Declare read-only properties</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">knot_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The section name for this knot in the cloudknot config file&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_knot_name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The Pars instance attached to this knot&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pars</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">docker_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The DockerImage instance attached to this knot&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_docker_image</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">docker_repo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The DockerRepo instance attached to this knot&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_docker_repo</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">job_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The JobDefinition instance attached to this knot&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job_definition</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">job_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The JobQueue instance attached to this knot&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job_queue</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">compute_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The ComputeEnvironment instance attached to this knot&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_environment</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of BatchJob instances that this knot has launched&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jobs</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">job_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of batch job IDs that this knot has launched&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job_ids</span>

<div class="viewcode-block" id="Knot.map"><a class="viewcode-back" href="../../documentation.html#cloudknot.Knot.map">[docs]</a>    <span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commands</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">env_vars</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Submit batch jobs for a range of commands and environment vars</span>

<span class="sd">        map returns a list of futures, which can return their result when</span>
<span class="sd">        the jobs are complete.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        commands : sequence of sequence of strings</span>
<span class="sd">            Sequence of commands. This method will submit one batch job for</span>
<span class="sd">            each command in the sequence. Each individual command must be a</span>
<span class="sd">            sequence of strings since the command eventaully becomes arguments</span>
<span class="sd">            to the `docker run` command. For example, if you wanted to pass</span>
<span class="sd">            the commands `echo 1`, `echo 2`, `echo 3`, then then you would use</span>
<span class="sd">            `submit(commands=[[&quot;echo&quot;, &quot;1&quot;], [&quot;echo&quot;, &quot;2&quot;], [&quot;echo&quot;, &quot;3&quot;]])`</span>

<span class="sd">        env_vars : sequence of sequence of strings</span>
<span class="sd">            Sequence of environment variables. This method will submit one</span>
<span class="sd">            batch job for each environment variable set in the sequence</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        map : list of futures</span>
<span class="sd">            A list of futures for each job</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clobbered</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">aws</span><span class="o">.</span><span class="n">ResourceClobberedException</span><span class="p">(</span>
                <span class="s1">&#39;This Knot has already been clobbered.&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_profile_and_region</span><span class="p">()</span>

        <span class="c1"># User must supply either commands or env_vars</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">commands</span> <span class="ow">or</span> <span class="n">env_vars</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You must supply either commands or env_vars.&#39;</span><span class="p">)</span>

        <span class="c1"># commands should be a sequence of sequences of strings</span>
        <span class="k">if</span> <span class="n">commands</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;commands must be a sequence of &#39;</span>
                             <span class="s1">&#39;sequences of strings&#39;</span><span class="p">)</span>

        <span class="c1"># env_vars should be a sequence of sequences of dicts</span>
        <span class="k">if</span> <span class="n">env_vars</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">env_vars</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;env_vars must be a sequence of &#39;</span>
                             <span class="s1">&#39;sequences of dicts&#39;</span><span class="p">)</span>

        <span class="c1"># and each dict should have only &#39;name&#39; and &#39;value&#39; keys</span>
        <span class="k">if</span> <span class="n">env_vars</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">all</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">}</span>
                                    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">env_vars</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;each dict in env_vars must have keys &quot;name&quot; &#39;</span>
                             <span class="s1">&#39;and &quot;value&quot;&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">commands</span> <span class="ow">and</span> <span class="n">env_vars</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">env_vars</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;commands and env_vars must be the same length&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">commands</span><span class="p">:</span>
            <span class="n">commands</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">env_vars</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">env_vars</span><span class="p">:</span>
            <span class="n">env_vars</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>

        <span class="n">these_jobs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">command</span><span class="p">,</span> <span class="n">env</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">commands</span><span class="p">,</span> <span class="n">env_vars</span><span class="p">):</span>
            <span class="n">job</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="n">BatchJob</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{n:s}</span><span class="s1">-</span><span class="si">{i:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_ids</span><span class="p">)),</span>
                <span class="n">job_queue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_queue</span><span class="p">,</span>
                <span class="n">job_definition</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_definition</span><span class="p">,</span>
                <span class="n">commands</span><span class="o">=</span><span class="n">command</span><span class="p">,</span>
                <span class="n">environment_variables</span><span class="o">=</span><span class="n">env</span>
            <span class="p">)</span>

            <span class="n">these_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_job_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>

        <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
        <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">get_config_file</span><span class="p">())</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_knot_name</span><span class="p">,</span> <span class="s1">&#39;job_ids&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_ids</span><span class="p">))</span>
        <span class="c1"># Save config to file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">get_config_file</span><span class="p">(),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">commands</span><span class="p">))</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">ex</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="k">lambda</span> <span class="n">j</span><span class="p">:</span> <span class="n">j</span><span class="o">.</span><span class="n">result</span><span class="p">(),</span> <span class="n">jb</span><span class="p">)</span> <span class="k">for</span> <span class="n">jb</span> <span class="ow">in</span> <span class="n">these_jobs</span><span class="p">]</span></div>

<div class="viewcode-block" id="Knot.get_jobs"><a class="viewcode-back" href="../../documentation.html#cloudknot.Knot.get_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">get_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of dictionaries containing job instances and info</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        jobs_info: list</span>
<span class="sd">            A list of dicts [{&#39;job&#39;: BatchJob instance, &#39;name&#39;: BatchJob.name,</span>
<span class="sd">            &#39;status&#39;: BatchJob.status, &#39;id&#39;: BatchJob.job_id},]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clobbered</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">aws</span><span class="o">.</span><span class="n">ResourceClobberedException</span><span class="p">(</span>
                <span class="s1">&#39;This Knot has already been clobbered.&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_profile_and_region</span><span class="p">()</span>

        <span class="n">jobs_info</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;job&#39;</span><span class="p">:</span> <span class="n">job</span><span class="p">,</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">],</span>
                <span class="s1">&#39;attempts&#39;</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;attempts&#39;</span><span class="p">],</span>
                <span class="s1">&#39;status-reason&#39;</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;statusReason&#39;</span><span class="p">],</span>
                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">job_id</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="n">jobs_info</span></div>

<div class="viewcode-block" id="Knot.view_jobs"><a class="viewcode-back" href="../../documentation.html#cloudknot.Knot.view_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">view_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print the job_id, name, and status of all jobs in self.jobs&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clobbered</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">aws</span><span class="o">.</span><span class="n">ResourceClobberedException</span><span class="p">(</span>
                <span class="s1">&#39;This Knot has already been clobbered.&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_profile_and_region</span><span class="p">()</span>

        <span class="n">order</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SUBMITTED&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;PENDING&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;RUNNABLE&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;STARTING&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                 <span class="s1">&#39;RUNNING&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;FAILED&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;SUCCEEDED&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">}</span>
        <span class="n">job_info</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_jobs</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">j</span><span class="p">:</span> <span class="n">order</span><span class="p">[</span><span class="n">j</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]])</span>

        <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{id:12s}</span><span class="s1">        </span><span class="si">{name:20s}</span><span class="s1">        </span><span class="si">{status:9s}</span><span class="s1">&#39;</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;Job ID&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;Status&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">job_info</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">job</span><span class="p">))</span></div>

<div class="viewcode-block" id="Knot.clobber"><a class="viewcode-back" href="../../documentation.html#cloudknot.Knot.clobber">[docs]</a>    <span class="k">def</span> <span class="nf">clobber</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clobber_pars</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">clobber_repo</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">clobber_image</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete associated AWS resources and remove section from config</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        clobber_pars : boolean</span>
<span class="sd">            If true, clobber the associated Pars instance</span>
<span class="sd">            Default: False</span>

<span class="sd">        clobber_repo : boolean</span>
<span class="sd">            If true, clobber the associated DockerRepo instance</span>
<span class="sd">            Default: False</span>

<span class="sd">        clobber_image : boolean</span>
<span class="sd">            If true, clobber the associated DockerImage instance</span>
<span class="sd">            Default: False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clobbered</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_profile_and_region</span><span class="p">()</span>

        <span class="c1"># Delete all associated AWS resources</span>
        <span class="c1"># Iterate over copy of self.jobs since we are removing from</span>
        <span class="c1"># the list while iterating</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">):</span>
            <span class="n">job</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_jobs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">job_queue</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compute_environment</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_definition</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">clobber_repo</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">docker_repo</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">docker_repo</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">clobber_image</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">docker_image</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">clobber_pars</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="o">.</span><span class="n">clobber</span><span class="p">()</span>
            <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Knot </span><span class="si">{name:s}</span><span class="s1"> clobbered PARS </span><span class="si">{pars:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pars</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="o">.</span><span class="n">name</span>
            <span class="p">))</span>

        <span class="c1"># Remove this section from the config file</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
        <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">get_config_file</span><span class="p">())</span>
        <span class="n">config</span><span class="o">.</span><span class="n">remove_section</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_knot_name</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">get_config_file</span><span class="p">(),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="c1"># Set the clobbered parameter to True,</span>
        <span class="c1"># preventing subsequent method calls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clobbered</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Clobbered Knot </span><span class="si">{name:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    
    <div class="footer">
      &copy;2017, Adam Richie-Halford, Ariel Rokem.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
    <script type="text/javascript">
        $(document).ready(function() {
            $(".toggle > *").hide();
            $(".toggle .header").show();
            $(".toggle .header").click(function() {
                $(this).parent().children().not(".header").toggle(400);
                $(this).parent().children(".header").toggleClass("open");
            })
        });
    </script>

  </body>
</html>