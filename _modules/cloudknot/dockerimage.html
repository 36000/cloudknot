
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>cloudknot.dockerimage &#8212; cloudknot 0.1 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/collapsible.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">cloudknot</a></h1>



<p class="blurb">Run your existing python code on AWS Batch</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=richford&repo=cloudknot&type=star&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../documentation.html">documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq.html">faq</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/richford/cloudknot/tree/master/examples">examples</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/richford/cloudknot">code</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/richford/cloudknot/issues">bugs</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for cloudknot.dockerimage</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">configparser</span>
<span class="kn">import</span> <span class="nn">docker</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">pipreqs</span> <span class="k">import</span> <span class="n">pipreqs</span>
<span class="kn">from</span> <span class="nn">string</span> <span class="k">import</span> <span class="n">Template</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">aws</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">config</span> <span class="k">as</span> <span class="n">ckconfig</span>
<span class="kn">from</span> <span class="nn">.aws.base_classes</span> <span class="k">import</span> <span class="n">get_region</span><span class="p">,</span> <span class="n">get_profile</span><span class="p">,</span> \
    <span class="n">ResourceDoesNotExistException</span><span class="p">,</span> <span class="n">ResourceClobberedException</span><span class="p">,</span> \
    <span class="n">CloudknotInputError</span><span class="p">,</span> <span class="n">CloudknotConfigurationError</span>
<span class="kn">from</span> <span class="nn">.config</span> <span class="k">import</span> <span class="n">get_config_file</span><span class="p">,</span> <span class="n">rlock</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;DockerImage&quot;</span><span class="p">]</span>

<span class="n">mod_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># noinspection PyPropertyAccess,PyAttributeOutsideInit</span>
<div class="viewcode-block" id="DockerImage"><a class="viewcode-back" href="../../documentation.html#cloudknot.DockerImage">[docs]</a><span class="k">class</span> <span class="nc">DockerImage</span><span class="p">(</span><span class="n">aws</span><span class="o">.</span><span class="n">NamedObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class for dockerizing a python script or function</span>

<span class="sd">    On `__init__`, if given a python function, DockerImage will create a CLI</span>
<span class="sd">    version for that function, write a requirements.txt file for all import</span>
<span class="sd">    statements in the function, and write a Dockerfile to containerize that</span>
<span class="sd">    python script. If given a path to a python script, DockerImage will assume</span>
<span class="sd">    it has a CLI and will skip the first step, building a requirements.txt file</span>
<span class="sd">    and a Dockerfile as before.</span>

<span class="sd">    If the input script or function contains imports that cannot be identified</span>
<span class="sd">    by pipreqs (i.e. cannot be installed with `pip install package`, those</span>
<span class="sd">    packages will not be included in requirements.txt, DockerImage will throw</span>
<span class="sd">    a warning, and the user must install those packages by hand in the</span>
<span class="sd">    Dockerfile.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">script_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">dir_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">base_image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">github_installs</span><span class="o">=</span><span class="p">(),</span> <span class="n">username</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize a DockerImage instance</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of DockerImage, only used to retrieve DockerImage from</span>
<span class="sd">            config file info. Do not use to create new DockerImage</span>

<span class="sd">        func : function</span>
<span class="sd">            Python function to be dockerized</span>

<span class="sd">        script_path : string</span>
<span class="sd">            Path to file with python script to be dockerized</span>

<span class="sd">        dir_name : string</span>
<span class="sd">            Directory to store Dockerfile, requirements.txt, and python</span>
<span class="sd">            script with CLI</span>
<span class="sd">            Default: parent directory of script if `script_path` is provided</span>
<span class="sd">            else DockerImage creates a new directory, accessible by the</span>
<span class="sd">            `build_path` property.</span>

<span class="sd">        base_image : string</span>
<span class="sd">            Docker base image on which to base this Dockerfile</span>
<span class="sd">            Default: None will use the python base image for the</span>
<span class="sd">            current version of python</span>

<span class="sd">        github_installs : string or sequence of strings</span>
<span class="sd">            Github addresses for packages to install from github rather than</span>
<span class="sd">            PyPI (e.g. git://github.com/richford/cloudknot.git or</span>
<span class="sd">            git://github.com/richford/cloudknot.git@newfeaturebranch)</span>
<span class="sd">            Default: ()</span>

<span class="sd">        username : string</span>
<span class="sd">            Default user created in the Dockerfile</span>
<span class="sd">            Default: &#39;cloudknot-user&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check for redundant input</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">([</span><span class="n">func</span><span class="p">,</span> <span class="n">script_path</span><span class="p">,</span> <span class="n">dir_name</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span>
                         <span class="n">base_image</span><span class="p">,</span> <span class="n">github_installs</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span>
                <span class="s2">&quot;You specified a name plus other stuff. The name parameter is &quot;</span>
                <span class="s2">&quot;only used to retrieve a pre-existing DockerImage instance. &quot;</span>
                <span class="s2">&quot;If you&#39;d like to create a new one, do not provide a name &quot;</span>
                <span class="s2">&quot;argument.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># User must specify at least `func` or `script_path`</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">script_path</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span><span class="s1">&#39;You must suppy either `name`, `func` &#39;</span>
                                      <span class="s1">&#39;or `script_path`.&#39;</span><span class="p">)</span>

        <span class="c1"># If both `func` and `script_path` are specified,</span>
        <span class="c1"># input is over-specified</span>
        <span class="k">if</span> <span class="n">script_path</span> <span class="ow">and</span> <span class="n">func</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span><span class="s1">&#39;You provided `script_path` and other &#39;</span>
                                      <span class="s1">&#39;redundant arguments, either `func` or &#39;</span>
                                      <span class="s1">&#39;`dir_name`. &#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
            <span class="c1"># Validate name input</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span><span class="s1">&#39;Docker image name must be a &#39;</span>
                                          <span class="s1">&#39;string. You passed a </span><span class="si">{t!s}</span><span class="s1">&#39;</span>
                                          <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span>

            <span class="nb">super</span><span class="p">(</span><span class="n">DockerImage</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

            <span class="n">section_name</span> <span class="o">=</span> <span class="s1">&#39;docker-image &#39;</span> <span class="o">+</span> <span class="n">name</span>

            <span class="n">config_file</span> <span class="o">=</span> <span class="n">get_config_file</span><span class="p">()</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>

            <span class="k">with</span> <span class="n">rlock</span><span class="p">:</span>
                <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">section_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">sections</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">ResourceDoesNotExistException</span><span class="p">(</span>
                    <span class="s1">&#39;Could not find </span><span class="si">{name:s}</span><span class="s1"> in config_file &#39;</span>
                    <span class="s1">&#39;</span><span class="si">{file:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">section_name</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">config_file</span><span class="p">),</span>
                    <span class="n">resource_id</span><span class="o">=</span><span class="n">name</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_func</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_build_path</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s1">&#39;build-path&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_script_path</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s1">&#39;script-path&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_docker_path</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s1">&#39;docker-path&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_req_path</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s1">&#39;req-path&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_base_image</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s1">&#39;base-image&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_github_installs</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span>
                                               <span class="s1">&#39;github-imports&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_username</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_clobber_script</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span>
                                                     <span class="s1">&#39;clobber-script&#39;</span><span class="p">)</span>

            <span class="n">images_str</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s1">&#39;images&#39;</span><span class="p">)</span>
            <span class="n">images_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">images_str</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_images</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">images_list</span><span class="p">]</span>

            <span class="n">uri</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s1">&#39;repo-uri&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_repo_uri</span> <span class="o">=</span> <span class="n">uri</span> <span class="k">if</span> <span class="n">uri</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="c1"># Set self.pip_imports and self.missing_imports</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_imports</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_func</span> <span class="o">=</span> <span class="n">func</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_username</span> <span class="o">=</span> <span class="n">username</span> <span class="k">if</span> <span class="n">username</span> <span class="k">else</span> <span class="s1">&#39;cloudknot-user&#39;</span>

            <span class="k">if</span> <span class="n">base_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_base_image</span> <span class="o">=</span> <span class="n">base_image</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">py_ver</span> <span class="o">=</span> <span class="s1">&#39;3&#39;</span> <span class="k">if</span> <span class="n">six</span><span class="o">.</span><span class="n">PY3</span> <span class="k">else</span> <span class="s1">&#39;2&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_base_image</span> <span class="o">=</span> <span class="s1">&#39;python:&#39;</span> <span class="o">+</span> <span class="n">py_ver</span>

            <span class="c1"># Validate dir_name input</span>
            <span class="k">if</span> <span class="n">dir_name</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dir_name</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span><span class="s1">&#39;`dir_name` is not an existing &#39;</span>
                                          <span class="s1">&#39;directory&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">script_path</span><span class="p">:</span>
                <span class="c1"># User supplied a pre-existing python script.</span>
                <span class="c1"># Ensure we don&#39;t clobber it later</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_clobber_script</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># Check that it is a valid path</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">script_path</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span>
                        <span class="s1">&#39;If provided, `script_path` must be an existing &#39;</span>
                        <span class="s1">&#39;regular file.&#39;</span>
                    <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_script_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">script_path</span><span class="p">)</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">DockerImage</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">script_path</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="c1"># Set the parent directory</span>
                <span class="k">if</span> <span class="n">dir_name</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_build_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">dir_name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_build_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">script_path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># We will create the script, Dockerfile, and requirements.txt</span>
                <span class="c1"># in a new directory</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_clobber_script</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">DockerImage</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">dir_name</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_build_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">dir_name</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_script_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_path</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>

                    <span class="c1"># Confirm that we will not overwrite an existing script</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_script_path</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span>
                            <span class="s1">&#39;There is a pre-existing python script in the &#39;</span>
                            <span class="s1">&#39;directory that you provided. Either specify a &#39;</span>
                            <span class="s1">&#39;new directory, move the python script `</span><span class="si">{file:s}</span><span class="s1">` &#39;</span>
                            <span class="s1">&#39;to a new directory, or delete the existing &#39;</span>
                            <span class="s1">&#39;python script if it is no longer &#39;</span>
                            <span class="s1">&#39;necessary.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">script_path</span><span class="p">)</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Create a new unique directory name</span>
                    <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;cloudknot_docker_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_build_path</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span>
                                                        <span class="nb">dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>

                    <span class="c1"># Store the script in the new directory</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_script_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_path</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_write_script</span><span class="p">()</span>

            <span class="c1"># Create the Dockerfile and requirements.txt in the parent dir</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_docker_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_path</span><span class="p">,</span> <span class="s1">&#39;Dockerfile&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_req_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_path</span><span class="p">,</span> <span class="s1">&#39;requirements.txt&#39;</span><span class="p">)</span>

            <span class="c1"># Confirm that we won&#39;t overwrite an existing Dockerfile</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_docker_path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span>
                    <span class="s1">&#39;There is a pre-existing Dockerfile in the same directory &#39;</span>
                    <span class="s1">&#39;as the python script you provided or in the directory &#39;</span>
                    <span class="s1">&#39;name that you provided. Either specify a new directory, &#39;</span>
                    <span class="s1">&#39;move the Dockerfile `</span><span class="si">{file:s}</span><span class="s1">` to a new directory, or &#39;</span>
                    <span class="s1">&#39;delete the existing Dockerfile if it is no longer &#39;</span>
                    <span class="s1">&#39;necessary.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">docker_path</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="c1"># Confirm that we won&#39;t overwrite an existing requirements.txt</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_req_path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span>
                    <span class="s1">&#39;There is a pre-existing requirements.txt in the same &#39;</span>
                    <span class="s1">&#39;directory as the python script you provided or in the &#39;</span>
                    <span class="s1">&#39;directory name that you provided. Either specify a new &#39;</span>
                    <span class="s1">&#39;directory, move the requirements file`</span><span class="si">{file:s}</span><span class="s1">` to its &#39;</span>
                    <span class="s1">&#39;own directory or delete the existing requirements file &#39;</span>
                    <span class="s1">&#39;if it is no longer needed.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">req_path</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="c1"># Validate github installs before building Dockerfile</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">github_installs</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_github_installs</span> <span class="o">=</span> <span class="p">[</span><span class="n">github_installs</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">github_installs</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_github_installs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">github_installs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span><span class="s1">&#39;github_installs must be a string &#39;</span>
                                          <span class="s1">&#39;or a sequence of strings.&#39;</span><span class="p">)</span>

            <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;(https|git)(://github.com/).*/.*\.git($|@.*$)&#39;</span>
            <span class="k">for</span> <span class="n">install</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_github_installs</span><span class="p">:</span>
                <span class="n">match_obj</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">install</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match_obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span>
                        <span class="s1">&#39;One of your github_installs, </span><span class="si">{i:s}</span><span class="s1"> is not formatted &#39;</span>
                        <span class="s1">&#39;correctly. It should look something like &#39;</span>
                        <span class="s1">&#39;git://github.com/user/repo.git, &#39;</span>
                        <span class="s1">&#39;git://github.com/user/repo.git@branch, &#39;</span>
                        <span class="s1">&#39;https://github.com/user/repo.git, or &#39;</span>
                        <span class="s1">&#39;https://github.com/user/repo.git@branch, &#39;</span>
                    <span class="p">)</span>

            <span class="c1"># Set self.pip_imports and self.missing_imports</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_imports</span><span class="p">()</span>

            <span class="c1"># Write the requirements.txt file and Dockerfile</span>
            <span class="n">pipreqs</span><span class="o">.</span><span class="n">generate_requirements_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">req_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pip_imports</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_write_dockerfile</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_images</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_repo_uri</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Add to config file</span>
            <span class="n">section_name</span> <span class="o">=</span> <span class="s1">&#39;docker-image &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="n">ckconfig</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s1">&#39;build-path&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_path</span><span class="p">)</span>
            <span class="n">ckconfig</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span>
                <span class="n">section_name</span><span class="p">,</span> <span class="s1">&#39;script-path&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">script_path</span>
            <span class="p">)</span>
            <span class="n">ckconfig</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span>
                <span class="n">section_name</span><span class="p">,</span> <span class="s1">&#39;docker-path&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">docker_path</span>
            <span class="p">)</span>
            <span class="n">ckconfig</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s1">&#39;req-path&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">req_path</span><span class="p">)</span>
            <span class="n">ckconfig</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s1">&#39;base-image&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_image</span><span class="p">)</span>
            <span class="n">ckconfig</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s1">&#39;github-imports&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">github_installs</span><span class="p">))</span>
            <span class="n">ckconfig</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
            <span class="n">ckconfig</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s1">&#39;images&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">ckconfig</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s1">&#39;repo-uri&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">ckconfig</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span>
                <span class="n">section_name</span><span class="p">,</span> <span class="s1">&#39;clobber-script&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_clobber_script</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="c1"># Declare read-only properties</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Python function that was dockerized&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">build_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The build path for the docker image&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_path</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">script_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Path to the CLI version of the python function&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_script_path</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">docker_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Path to the generated Dockerfile&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_docker_path</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">req_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Path to the generated requirements.txt file&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_req_path</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pip_imports</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of packages in the requirements.txt file&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pip_imports</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">base_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Docker base image on which to base the docker image&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_image</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">github_installs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of packages installed from github rather than PyPI&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_github_installs</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">username</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Default username created in Dockerfile&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_username</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">missing_imports</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of required imports that are unavailable through pip install.</span>

<span class="sd">        The user must edit the Dockerfile by hand to install these packages</span>
<span class="sd">        before using the build or push methods.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_missing_imports</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">images</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of name, tag dicts for docker images built by this instance&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_images</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">repo_uri</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Location of remote repository to which the image was pushed&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repo_uri</span>

    <span class="k">def</span> <span class="nf">_write_script</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write this instance&#39;s function to a script with a CLI.</span>

<span class="sd">        Use the template file to insert the self.func source code and name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">script_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">template_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                <span class="s1">&#39;templates&#39;</span><span class="p">,</span>
                <span class="s1">&#39;script.template&#39;</span>
            <span class="p">))</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">template_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">template</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span>
                    <span class="n">func_source</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">),</span>
                    <span class="n">func_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="p">))</span>

        <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Wrote python function </span><span class="si">{func:s}</span><span class="s1"> to script </span><span class="si">{script:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">script</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">script_path</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_write_dockerfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write Dockerfile to containerize this instance&#39;s python function&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">docker_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">template_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                <span class="s1">&#39;templates&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Dockerfile.template&#39;</span>
            <span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">github_installs</span><span class="p">:</span>
                <span class="n">github_installs_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                    <span class="s1">&#39; </span><span class="se">\\\n</span><span class="s1">    &amp;&amp; pip install --no-cache-dir git+&#39;</span> <span class="o">+</span> <span class="n">install</span>
                    <span class="k">for</span> <span class="n">install</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">github_installs</span>
                <span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">github_installs_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">template_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">template</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span>
                    <span class="n">app_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
                    <span class="n">base_image</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_image</span><span class="p">,</span>
                    <span class="n">script_base_name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">script_path</span><span class="p">),</span>
                    <span class="n">github_installs_string</span><span class="o">=</span><span class="n">github_installs_string</span>
                <span class="p">))</span>

        <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Wrote Dockerfile </span><span class="si">{path:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">docker_path</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_imports</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set required imports for the python script at self.script_path&quot;&quot;&quot;</span>
        <span class="c1"># Get the names of packages imported in the script</span>
        <span class="n">import_names</span> <span class="o">=</span> <span class="n">pipreqs</span><span class="o">.</span><span class="n">get_all_imports</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">script_path</span>
        <span class="p">))</span>

        <span class="c1"># Of those names, store that ones that are available via pip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pip_imports</span> <span class="o">=</span> <span class="n">pipreqs</span><span class="o">.</span><span class="n">get_imports_info</span><span class="p">(</span><span class="n">import_names</span><span class="p">)</span>

        <span class="c1"># If some imports were left out, store their names</span>
        <span class="n">pip_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pip_imports</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_missing_imports</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">import_names</span><span class="p">)</span> <span class="o">-</span> <span class="n">pip_names</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">import_names</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pip_imports</span><span class="p">)</span>
                                 <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">github_installs</span><span class="p">)):</span>
            <span class="c1"># And warn the user</span>
            <span class="n">mod_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;Warning, some imports not found by pipreqs. You will &#39;</span>
                <span class="s1">&#39;need to edit the Dockerfile by hand, e.g by installing &#39;</span>
                <span class="s1">&#39;from github. You need to install the following packages &#39;</span>
                <span class="s1">&#39;</span><span class="si">{missing!s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">missing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">missing_imports</span><span class="p">)</span>
            <span class="p">)</span>

<div class="viewcode-block" id="DockerImage.build"><a class="viewcode-back" href="../../documentation.html#cloudknot.DockerImage.build">[docs]</a>    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">image_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build a DockerContainer image</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tags : str or sequence of str</span>
<span class="sd">            Tags to be applied to this Docker image</span>

<span class="sd">        image_name : str</span>
<span class="sd">            Name of Docker image to be built</span>
<span class="sd">            Default: &#39;cloudknot/&#39; + self.name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clobbered</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ResourceClobberedException</span><span class="p">(</span>
                <span class="s1">&#39;This docker image has already been clobbered.&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>

        <span class="c1"># Validate tags input</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">tags</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">):</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span><span class="s1">&#39;tags must be a string or a sequence &#39;</span>
                                      <span class="s1">&#39;of strings.&#39;</span><span class="p">)</span>

        <span class="c1"># Don&#39;t allow user to put &quot;latest&quot; in tags.</span>
        <span class="k">if</span> <span class="s1">&#39;latest&#39;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span><span class="s1">&#39;Any tag is allowed, except for &#39;</span>
                                      <span class="s1">&#39;&quot;latest.&quot;&#39;</span><span class="p">)</span>

        <span class="n">image_name</span> <span class="o">=</span> <span class="n">image_name</span> <span class="k">if</span> <span class="n">image_name</span> <span class="k">else</span> <span class="s1">&#39;cloudknot/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="n">images</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">image_name</span><span class="p">,</span> <span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="n">t</span><span class="p">}</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_images</span> <span class="o">+=</span> <span class="p">[</span><span class="n">im</span> <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">images</span> <span class="k">if</span> <span class="n">im</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">]</span>

        <span class="c1"># Use docker low-level APIClient</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">docker</span><span class="o">.</span><span class="n">from_env</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
            <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Building image </span><span class="si">{name:s}</span><span class="s1"> with tag </span><span class="si">{tag:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">]</span>
            <span class="p">))</span>

            <span class="n">c</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">build</span><span class="p">(</span>
                <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">build_path</span><span class="p">,</span>
                <span class="n">dockerfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">docker_path</span><span class="p">,</span>
                <span class="n">tag</span><span class="o">=</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">im</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="c1"># Update the config file images list</span>
        <span class="n">config_file</span> <span class="o">=</span> <span class="n">get_config_file</span><span class="p">()</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">rlock</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>

        <span class="c1"># Get list of images in config file</span>
        <span class="n">section_name</span> <span class="o">=</span> <span class="s1">&#39;docker-image &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">config_images_str</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s1">&#39;images&#39;</span><span class="p">)</span>

        <span class="c1"># Split config images into list</span>
        <span class="n">config_images_list</span> <span class="o">=</span> <span class="n">config_images_str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

        <span class="c1"># Convert images just build into list</span>
        <span class="n">current_images_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">images</span><span class="p">]</span>

        <span class="c1"># Get the union of the two lists</span>
        <span class="n">config_images</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">config_images_list</span><span class="p">)</span>
                             <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">current_images_list</span><span class="p">))</span>

        <span class="c1"># Convert back to space separated list string</span>
        <span class="n">config_images_str</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config_images</span><span class="p">)</span>

        <span class="c1"># Reload to config file</span>
        <span class="n">ckconfig</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s1">&#39;images&#39;</span><span class="p">,</span> <span class="n">config_images_str</span><span class="p">)</span></div>

<div class="viewcode-block" id="DockerImage.push"><a class="viewcode-back" href="../../documentation.html#cloudknot.DockerImage.push">[docs]</a>    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">repo_uri</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tag and push a DockerContainer image to a repository</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        repo : DockerRepo, optional</span>
<span class="sd">            DockerRepo instance to which to push this image</span>

<span class="sd">        repo_uri : string, optional</span>
<span class="sd">            URI for the docker repository to which to push this instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clobbered</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ResourceClobberedException</span><span class="p">(</span>
                <span class="s1">&#39;This docker image has already been clobbered.&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>

        <span class="c1"># User must supply either a repo object or the repo name and uri</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">repo</span> <span class="ow">or</span> <span class="n">repo_uri</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span><span class="s1">&#39;You must supply either `repo=&#39;</span>
                                      <span class="s1">&#39;&lt;DockerRepo instance&gt;` or `repo_uri`.&#39;</span><span class="p">)</span>

        <span class="c1"># User cannot supply both repo and repo_name or repo_uri</span>
        <span class="k">if</span> <span class="n">repo</span> <span class="ow">and</span> <span class="n">repo_uri</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span><span class="s1">&#39;You may not specify both a repo object &#39;</span>
                                      <span class="s1">&#39;and `repo_uri`.&#39;</span><span class="p">)</span>

        <span class="c1"># Make sure that the user has called build first or somehow set tags.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span>
                <span class="s1">&#39;The images property is empty, indicating that the build &#39;</span>
                <span class="s1">&#39;method has not yet been called. Call `build(tags=&lt;tags&gt;)` &#39;</span>
                <span class="s1">&#39;first before calling `tag()`.&#39;</span>
            <span class="p">)</span>

        <span class="n">fallback</span> <span class="o">=</span> <span class="s1">&#39;from_env&#39;</span>
        <span class="k">if</span> <span class="n">get_profile</span><span class="p">(</span><span class="n">fallback</span><span class="o">=</span><span class="n">fallback</span><span class="p">)</span> <span class="o">!=</span> <span class="n">fallback</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s1">&#39;aws&#39;</span><span class="p">,</span> <span class="s1">&#39;ecr&#39;</span><span class="p">,</span> <span class="s1">&#39;get-login&#39;</span><span class="p">,</span> <span class="s1">&#39;--no-include-email&#39;</span><span class="p">,</span>
                <span class="s1">&#39;--region&#39;</span><span class="p">,</span> <span class="n">get_region</span><span class="p">(),</span>
                <span class="s1">&#39;--profile&#39;</span><span class="p">,</span> <span class="n">get_profile</span><span class="p">(),</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s1">&#39;aws&#39;</span><span class="p">,</span> <span class="s1">&#39;ecr&#39;</span><span class="p">,</span> <span class="s1">&#39;get-login&#39;</span><span class="p">,</span> <span class="s1">&#39;--no-include-email&#39;</span><span class="p">,</span>
                <span class="s1">&#39;--region&#39;</span><span class="p">,</span> <span class="n">get_region</span><span class="p">(),</span>
            <span class="p">]</span>

        <span class="c1"># Refresh the aws ecr login credentials</span>
        <span class="n">login_cmd</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

        <span class="c1"># Login</span>
        <span class="n">login_cmd</span> <span class="o">=</span> <span class="n">login_cmd</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ASCII&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">fnull</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">login_result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">login_cmd</span><span class="p">,</span>
                                       <span class="n">stdout</span><span class="o">=</span><span class="n">fnull</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>

        <span class="c1"># If login failed, pass error to user</span>
        <span class="k">if</span> <span class="n">login_result</span><span class="p">:</span>  <span class="c1"># pragma: nocover</span>
            <span class="k">raise</span> <span class="n">CloudknotConfigurationError</span><span class="p">(</span>
                <span class="s1">&#39;Unable to login to AWS ECR using `</span><span class="si">{login:s}</span><span class="s1">`&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">login</span><span class="o">=</span><span class="n">login_cmd</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">repo</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="n">aws</span><span class="o">.</span><span class="n">DockerRepo</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span><span class="s1">&#39;repo must be of type DockerRepo.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_repo_uri</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">repo_uri</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">repo_uri</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span><span class="s1">&#39;`repo_uri` must be a string.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_repo_uri</span> <span class="o">=</span> <span class="n">repo_uri</span>

        <span class="c1"># Use docker low-level APIClient for tagging</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">docker</span><span class="o">.</span><span class="n">from_env</span><span class="p">()</span><span class="o">.</span><span class="n">api</span>
        <span class="c1"># And the image client for pushing</span>
        <span class="n">cli</span> <span class="o">=</span> <span class="n">docker</span><span class="o">.</span><span class="n">from_env</span><span class="p">()</span><span class="o">.</span><span class="n">images</span>
        <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">:</span>
            <span class="c1"># Log tagging info</span>
            <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Tagging image </span><span class="si">{name:s}</span><span class="s1"> with tag </span><span class="si">{tag:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">]</span>
            <span class="p">))</span>

            <span class="c1"># Tag it with the most recently added image_name</span>
            <span class="n">c</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">im</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">],</span>
                  <span class="n">repository</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repo_uri</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">])</span>

            <span class="c1"># Log push info</span>
            <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Pushing image </span><span class="si">{name:s}</span><span class="s1"> with tag </span><span class="si">{tag:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">]</span>
            <span class="p">))</span>

            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">cli</span><span class="o">.</span><span class="n">push</span><span class="p">(</span>
                    <span class="n">repository</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repo_uri</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">],</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">):</span>
                <span class="n">mod_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_repo_uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repo_uri</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;tag&#39;</span><span class="p">]</span>

        <span class="n">section_name</span> <span class="o">=</span> <span class="s1">&#39;docker-image &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">ckconfig</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">section_name</span><span class="p">,</span> <span class="s1">&#39;repo-uri&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo_uri</span><span class="p">)</span></div>

<div class="viewcode-block" id="DockerImage.clobber"><a class="viewcode-back" href="../../documentation.html#cloudknot.DockerImage.clobber">[docs]</a>    <span class="k">def</span> <span class="nf">clobber</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete all of the files associated with this instance</span>

<span class="sd">        Always delete the generated requirements.txt and Dockerfile. Only</span>
<span class="sd">        delete the script if it was auto-generated. Only delete the parent</span>
<span class="sd">        directory if it is empty.</span>

<span class="sd">        Also delete the local docker image</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clobbered</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clobber_script</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">script_path</span><span class="p">)</span>
            <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Removed </span><span class="si">{path:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">script_path</span><span class="p">))</span>

        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">docker_path</span><span class="p">)</span>
        <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Removed </span><span class="si">{path:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">docker_path</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">req_path</span><span class="p">)</span>
        <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Removed </span><span class="si">{path:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">req_path</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_path</span><span class="p">)</span>
            <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Removed </span><span class="si">{path:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">build_path</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="c1"># Directory is not empty. There&#39;s pre-existing stuff in there</span>
            <span class="c1"># that we shouldn&#39;t mess with.</span>
            <span class="k">pass</span>

        <span class="n">cli</span> <span class="o">=</span> <span class="n">docker</span><span class="o">.</span><span class="n">from_env</span><span class="p">()</span><span class="o">.</span><span class="n">images</span>
        <span class="c1"># Get local images first (lol stands for list_of_lists</span>
        <span class="n">local_image_lol</span> <span class="o">=</span> <span class="p">[</span><span class="n">im</span><span class="o">.</span><span class="n">tags</span> <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">cli</span><span class="o">.</span><span class="n">list</span><span class="p">()]</span>
        <span class="c1"># Flatten the list of lists</span>
        <span class="n">local_images</span> <span class="o">=</span> <span class="p">[</span><span class="n">im</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">local_image_lol</span> <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>

        <span class="c1"># Use docker image client to remove local images</span>
        <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">im</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">im</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">local_images</span><span class="p">:</span>
                <span class="c1"># Remove the local docker image, using the image name</span>
                <span class="n">cli</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span>
                    <span class="n">image</span><span class="o">=</span><span class="n">im</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">im</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">],</span>
                    <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">noprune</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
                <span class="c1"># Update local_images to prevent redundant image removal</span>
                <span class="n">local_image_lol</span> <span class="o">=</span> <span class="p">[</span><span class="n">im</span><span class="o">.</span><span class="n">tags</span> <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">cli</span><span class="o">.</span><span class="n">list</span><span class="p">()]</span>
                <span class="n">local_images</span> <span class="o">=</span> <span class="p">[</span><span class="n">im</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">local_image_lol</span>
                                <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo_uri</span><span class="p">:</span>
            <span class="n">cli</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span>
                <span class="n">image</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">repo_uri</span><span class="p">,</span>
                <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">noprune</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>

        <span class="c1"># Remove from the config file</span>
        <span class="n">config_file</span> <span class="o">=</span> <span class="n">get_config_file</span><span class="p">()</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">rlock</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>
            <span class="n">config</span><span class="o">.</span><span class="n">remove_section</span><span class="p">(</span><span class="s1">&#39;docker-image &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_clobbered</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Removed local docker images &#39;</span>
                        <span class="s1">&#39;</span><span class="si">{images!s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">images</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">))</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    
    <div class="footer">
      &copy;2017, Adam Richie-Halford, Ariel Rokem.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.11</a>
      
    </div>

    

    
    <script type="text/javascript">
        $(document).ready(function() {
            $(".toggle > *").hide();
            $(".toggle .header").show();
            $(".toggle .header").click(function() {
                $(this).parent().children().not(".header").toggle(400);
                $(this).parent().children(".header").toggleClass("open");
            })
        });
    </script>

  </body>
</html>