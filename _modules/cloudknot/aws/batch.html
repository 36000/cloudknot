
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>cloudknot.aws.batch &#8212; cloudknot 0.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/collapsible.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">cloudknot</a></h1>



<p class="blurb">Run your existing python code on AWS Batch</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=richford&repo=cloudknot&type=star&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation.html">documentation</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/richford/cloudknot/tree/master/examples">examples</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/richford/cloudknot">code</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/richford/cloudknot/issues">bugs</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for cloudknot.aws.batch</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">cloudknot.config</span>
<span class="kn">import</span> <span class="nn">cloudpickle</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">tenacity</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">namedtuple</span>

<span class="kn">from</span> <span class="nn">.base_classes</span> <span class="k">import</span> <span class="n">NamedObject</span><span class="p">,</span> <span class="n">ObjectWithArn</span><span class="p">,</span> \
    <span class="n">ObjectWithUsernameAndMemory</span><span class="p">,</span> <span class="n">clients</span><span class="p">,</span> \
    <span class="n">ResourceExistsException</span><span class="p">,</span> <span class="n">ResourceDoesNotExistException</span><span class="p">,</span> \
    <span class="n">ResourceClobberedException</span><span class="p">,</span> <span class="n">CannotDeleteResourceException</span><span class="p">,</span> \
    <span class="n">BatchJobFailedError</span><span class="p">,</span> <span class="n">CKTimeoutError</span><span class="p">,</span> \
    <span class="n">wait_for_job_queue</span><span class="p">,</span> <span class="n">get_s3_bucket</span>
<span class="kn">from</span> <span class="nn">.ec2</span> <span class="k">import</span> <span class="n">Vpc</span><span class="p">,</span> <span class="n">SecurityGroup</span>
<span class="kn">from</span> <span class="nn">.ecr</span> <span class="k">import</span> <span class="n">DockerRepo</span>
<span class="kn">from</span> <span class="nn">.iam</span> <span class="k">import</span> <span class="n">IamRole</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;JobDefinition&quot;</span><span class="p">,</span> <span class="s2">&quot;JobQueue&quot;</span><span class="p">,</span> <span class="s2">&quot;ComputeEnvironment&quot;</span><span class="p">,</span> <span class="s2">&quot;BatchJob&quot;</span><span class="p">]</span>

<span class="n">mod_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># noinspection PyPropertyAccess,PyAttributeOutsideInit</span>
<div class="viewcode-block" id="JobDefinition"><a class="viewcode-back" href="../../../api/_autosummary/cloudknot.aws.JobDefinition.html#cloudknot.aws.JobDefinition">[docs]</a><span class="k">class</span> <span class="nc">JobDefinition</span><span class="p">(</span><span class="n">ObjectWithUsernameAndMemory</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class for defining AWS Batch Job Definitions&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">job_role</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">docker_image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">vcpus</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize an AWS Batch job definition object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        arn : string</span>
<span class="sd">            ARN of the job definition to retrieve</span>

<span class="sd">        name : string</span>
<span class="sd">            Name of the job definition to retrieve or create</span>

<span class="sd">        job_role : IamRole</span>
<span class="sd">            IamRole instance for the AWS IAM job role to be used in this</span>
<span class="sd">            job definition</span>

<span class="sd">        docker_image : DockerRepo or string</span>
<span class="sd">            DockerRepo instance for the container to be used in this job</span>
<span class="sd">            definition</span>
<span class="sd">            or string containing location of docker image on Docker Hub or</span>
<span class="sd">            other repository</span>

<span class="sd">        vcpus : int</span>
<span class="sd">            number of virtual cpus to be used to this job definition</span>
<span class="sd">            Default: 1</span>

<span class="sd">        memory : int</span>
<span class="sd">            memory (MiB) to be used for this job definition</span>
<span class="sd">            Default: 8000</span>

<span class="sd">        username : string</span>
<span class="sd">            username for be used for this job definition</span>
<span class="sd">            Default: cloudknot-user</span>

<span class="sd">        retries : int</span>
<span class="sd">            number of times a job can be moved to &#39;RUNNABLE&#39; status.</span>
<span class="sd">            May be between 1 and 10</span>
<span class="sd">            Default: 1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate for minimum input</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">arn</span> <span class="ow">or</span> <span class="n">name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You must supply either an arn or name for this &#39;</span>
                             <span class="s1">&#39;job definition.&#39;</span><span class="p">)</span>

        <span class="c1"># Validate to prevent over-specified input</span>
        <span class="k">if</span> <span class="n">arn</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">([</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">job_role</span><span class="p">,</span> <span class="n">docker_image</span><span class="p">,</span> <span class="n">vcpus</span><span class="p">,</span> <span class="n">memory</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">retries</span>
        <span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You may supply either an arn or other job &#39;</span>
                             <span class="s1">&#39;definition details. Not both.&#39;</span><span class="p">)</span>

        <span class="c1"># Determine whether the user supplied only an arn or only a name</span>
        <span class="n">arn_or_name_only</span> <span class="o">=</span> <span class="p">(</span><span class="n">arn</span> <span class="ow">or</span> <span class="p">(</span><span class="n">name</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span>
            <span class="n">job_role</span><span class="p">,</span> <span class="n">docker_image</span><span class="p">,</span> <span class="n">vcpus</span><span class="p">,</span> <span class="n">memory</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">retries</span>
        <span class="p">])))</span>

        <span class="n">resource</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exists_already</span><span class="p">(</span><span class="n">arn</span><span class="o">=</span><span class="n">arn</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pre_existing</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">exists</span>

        <span class="k">if</span> <span class="n">resource</span><span class="o">.</span><span class="n">exists</span> <span class="ow">and</span> <span class="n">resource</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s1">&#39;INACTIVE&#39;</span><span class="p">:</span>
            <span class="c1"># Resource exists, if user tried to specify resource parameters</span>
            <span class="c1"># for an active job def, then throw error</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">job_role</span><span class="p">,</span> <span class="n">docker_image</span><span class="p">,</span> <span class="n">vcpus</span><span class="p">,</span> <span class="n">memory</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">retries</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="n">ResourceExistsException</span><span class="p">(</span>
                    <span class="s1">&#39;You provided input parameters for a job definition that &#39;</span>
                    <span class="s1">&#39;already exists. If you would like to create a new job &#39;</span>
                    <span class="s1">&#39;definition, please use a different name. If you would &#39;</span>
                    <span class="s1">&#39;like to retrieve the details of this job definition, use &#39;</span>
                    <span class="s1">&#39;JobDefinition(arn=</span><span class="si">{arn:s}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arn</span><span class="o">=</span><span class="n">resource</span><span class="o">.</span><span class="n">arn</span><span class="p">),</span>
                    <span class="n">resource</span><span class="o">.</span><span class="n">arn</span>
                <span class="p">)</span>

            <span class="c1"># Fill parameters with queried values</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">JobDefinition</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">resource</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="n">resource</span><span class="o">.</span><span class="n">memory</span><span class="p">,</span>
                <span class="n">username</span><span class="o">=</span><span class="n">resource</span><span class="o">.</span><span class="n">username</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_job_role</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_job_role_arn</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">job_role_arn</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_docker_image</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">docker_image</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vcpus</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">vcpus</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_retries</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">retries</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_arn</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">arn</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_output_bucket</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">output_bucket</span>

            <span class="c1"># Add to config file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_section_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_section_name</span><span class="p">(</span><span class="s1">&#39;job-definitions&#39;</span><span class="p">)</span>
            <span class="n">cloudknot</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_section_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">arn</span>
            <span class="p">)</span>

            <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Retrieved pre-existing job definition </span><span class="si">{name:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">exists</span> <span class="ow">and</span> <span class="n">resource</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;INACTIVE&#39;</span>
              <span class="ow">and</span> <span class="n">arn_or_name_only</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ResourceExistsException</span><span class="p">(</span>
                <span class="s1">&#39;You retrieved an inactive job definition and cloudknot &#39;</span>
                <span class="s1">&#39;has no way to reactivate it. Instead of retrieving the &#39;</span>
                <span class="s1">&#39;job definition using an ARN, create a new one with your &#39;</span>
                <span class="s1">&#39;desired properties.&#39;</span><span class="p">,</span>
                <span class="n">resource</span><span class="o">.</span><span class="n">arn</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If user supplied only a name or only an arn, expecting to</span>
            <span class="c1"># retrieve info on pre-existing job definition, throw error</span>
            <span class="k">if</span> <span class="n">arn</span> <span class="ow">or</span> <span class="p">(</span><span class="n">name</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">job_role</span><span class="p">,</span> <span class="n">docker_image</span><span class="p">])):</span>
                <span class="k">raise</span> <span class="n">ResourceDoesNotExistException</span><span class="p">(</span>
                    <span class="s1">&#39;The job definition you requested does not exist.&#39;</span><span class="p">,</span>
                    <span class="n">arn</span>
                <span class="p">)</span>

            <span class="c1"># Otherwise, validate input and set parameters</span>
            <span class="n">username</span> <span class="o">=</span> <span class="n">username</span> <span class="k">if</span> <span class="n">username</span> <span class="k">else</span> <span class="s1">&#39;cloudknot-user&#39;</span>
            <span class="n">memory</span> <span class="o">=</span> <span class="n">memory</span> <span class="k">if</span> <span class="n">memory</span> <span class="k">else</span> <span class="mi">8000</span>

            <span class="nb">super</span><span class="p">(</span><span class="n">JobDefinition</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span>
            <span class="p">)</span>

            <span class="c1"># Validate job role input</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">job_role</span><span class="p">,</span> <span class="n">IamRole</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;job_role must be an instance of IamRole&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_job_role</span> <span class="o">=</span> <span class="n">job_role</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_job_role_arn</span> <span class="o">=</span> <span class="n">job_role</span><span class="o">.</span><span class="n">arn</span>

            <span class="c1"># Validate docker_image input</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">docker_image</span><span class="p">,</span> <span class="n">DockerRepo</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">docker_image</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;docker_image must be an instance of DockerRepo &#39;</span>
                    <span class="s1">&#39;or a string&#39;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_docker_image</span> <span class="o">=</span> <span class="n">docker_image</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_output_bucket</span> <span class="o">=</span> <span class="n">get_s3_bucket</span><span class="p">()</span>

            <span class="c1"># Validate vcpus input</span>
            <span class="k">if</span> <span class="n">vcpus</span><span class="p">:</span>
                <span class="n">cpus</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">vcpus</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cpus</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;vcpus must be positive&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_vcpus</span> <span class="o">=</span> <span class="n">cpus</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_vcpus</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="c1"># Validate retries input</span>
            <span class="k">if</span> <span class="n">retries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">retries_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">retries</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">retries_int</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;retries must be positive&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">retries_int</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;retries must be less than 10&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_retries</span> <span class="o">=</span> <span class="n">retries_int</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_retries</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_arn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create</span><span class="p">()</span>

    <span class="c1"># Declare read-only parameters</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pre_existing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Boolean flag to indicate whether this resource was pre-existing</span>

<span class="sd">        True if resource was retrieved from AWS,</span>
<span class="sd">        False if it was created on __init__.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_existing</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">job_role</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;IAM job role for this job definition.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job_role</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">job_role_arn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The ARN for this job definition&#39;s IAM job role.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job_role_arn</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">docker_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;DockerRepo instance for the container to be used in this job</span>
<span class="sd">        definition or string containing location of docker image on Docker</span>
<span class="sd">        Hub or other repository</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_docker_image</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">output_bucket</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Amazon S3 bucket where output will be stored&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_bucket</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vcpus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The number of vCPUS for this job definition.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vcpus</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">retries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The number of times a job can be moved to &#39;RUNNABLE&#39; status.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retries</span>

    <span class="k">def</span> <span class="nf">_exists_already</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arn</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if an AWS Job Definition exists already</span>

<span class="sd">        If definition exists, return namedtuple with job definition info.</span>
<span class="sd">        Otherwise, set the namedtuple&#39;s `exists` field to `False`. The</span>
<span class="sd">        remaining fields default to `None`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        namedtuple RoleExists</span>
<span class="sd">            A namedtuple with fields</span>
<span class="sd">            [&#39;exists&#39;, &#39;name&#39;, &#39;status&#39;, &#39;job_role&#39;, &#39;output_bucket&#39;,</span>
<span class="sd">            &#39;docker_image&#39;, &#39;vcpus&#39;, &#39;memory&#39;, &#39;username&#39;, &#39;retries&#39;, &#39;arn&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># define a namedtuple for return value type</span>
        <span class="n">ResourceExists</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
            <span class="s1">&#39;ResourceExists&#39;</span><span class="p">,</span>
            <span class="p">[</span><span class="s1">&#39;exists&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;job_role_arn&#39;</span><span class="p">,</span> <span class="s1">&#39;docker_image&#39;</span><span class="p">,</span>
             <span class="s1">&#39;vcpus&#39;</span><span class="p">,</span> <span class="s1">&#39;memory&#39;</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;retries&#39;</span><span class="p">,</span> <span class="s1">&#39;arn&#39;</span><span class="p">,</span>
             <span class="s1">&#39;output_bucket&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># make all but the first value default to None</span>
        <span class="n">ResourceExists</span><span class="o">.</span><span class="fm">__new__</span><span class="o">.</span><span class="vm">__defaults__</span> <span class="o">=</span> \
            <span class="p">(</span><span class="kc">None</span><span class="p">,)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ResourceExists</span><span class="o">.</span><span class="n">_fields</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">arn</span><span class="p">:</span>
            <span class="c1"># Retrieve using ARN</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe_job_definitions</span><span class="p">(</span>
                <span class="n">jobDefinitions</span><span class="o">=</span><span class="p">[</span><span class="n">arn</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Retrieve using name</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe_job_definitions</span><span class="p">(</span>
                <span class="n">jobDefinitionName</span><span class="o">=</span><span class="n">name</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;jobDefinitions&#39;</span><span class="p">):</span>
            <span class="c1"># Get active job definitions</span>
            <span class="n">active_job_defs</span> <span class="o">=</span> <span class="p">[</span><span class="n">jd</span> <span class="k">for</span> <span class="n">jd</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;jobDefinitions&#39;</span><span class="p">)</span>
                               <span class="k">if</span> <span class="n">jd</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ACTIVE&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">active_job_defs</span><span class="p">:</span>
                <span class="n">job_def</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">active_job_defs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">j</span><span class="p">:</span> <span class="n">j</span><span class="p">[</span><span class="s1">&#39;revision&#39;</span><span class="p">],</span>
                                 <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">job_def</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;jobDefinitions&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Job def exists. Get job def details</span>
            <span class="n">job_def_name</span> <span class="o">=</span> <span class="n">job_def</span><span class="p">[</span><span class="s1">&#39;jobDefinitionName&#39;</span><span class="p">]</span>
            <span class="n">job_def_status</span> <span class="o">=</span> <span class="n">job_def</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span>
            <span class="n">job_def_arn</span> <span class="o">=</span> <span class="n">job_def</span><span class="p">[</span><span class="s1">&#39;jobDefinitionArn&#39;</span><span class="p">]</span>
            <span class="n">retries</span> <span class="o">=</span> <span class="n">job_def</span><span class="p">[</span><span class="s1">&#39;retryStrategy&#39;</span><span class="p">][</span><span class="s1">&#39;attempts&#39;</span><span class="p">]</span>

            <span class="n">container_properties</span> <span class="o">=</span> <span class="n">job_def</span><span class="p">[</span><span class="s1">&#39;containerProperties&#39;</span><span class="p">]</span>
            <span class="n">username</span> <span class="o">=</span> <span class="n">container_properties</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span>
            <span class="n">memory</span> <span class="o">=</span> <span class="n">container_properties</span><span class="p">[</span><span class="s1">&#39;memory&#39;</span><span class="p">]</span>
            <span class="n">vcpus</span> <span class="o">=</span> <span class="n">container_properties</span><span class="p">[</span><span class="s1">&#39;vcpus&#39;</span><span class="p">]</span>
            <span class="n">job_role_arn</span> <span class="o">=</span> <span class="n">container_properties</span><span class="p">[</span><span class="s1">&#39;jobRoleArn&#39;</span><span class="p">]</span>
            <span class="n">container_image</span> <span class="o">=</span> <span class="n">container_properties</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">environment</span> <span class="o">=</span> <span class="n">container_properties</span><span class="p">[</span><span class="s1">&#39;environment&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>  <span class="c1"># pragma: nocover</span>
                <span class="n">environment</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">bucket_envs</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">environment</span>
                           <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;CLOUDKNOT_JOBS_S3_BUCKET&#39;</span><span class="p">]</span>

            <span class="n">output_bucket</span> <span class="o">=</span> <span class="n">bucket_envs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">bucket_envs</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Job definition </span><span class="si">{name:s}</span><span class="s1"> already exists.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">job_def_name</span>
            <span class="p">))</span>

            <span class="k">return</span> <span class="n">ResourceExists</span><span class="p">(</span>
                <span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">job_def_name</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">job_def_status</span><span class="p">,</span>
                <span class="n">job_role_arn</span><span class="o">=</span><span class="n">job_role_arn</span><span class="p">,</span> <span class="n">docker_image</span><span class="o">=</span><span class="n">container_image</span><span class="p">,</span>
                <span class="n">vcpus</span><span class="o">=</span><span class="n">vcpus</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
                <span class="n">retries</span><span class="o">=</span><span class="n">retries</span><span class="p">,</span> <span class="n">arn</span><span class="o">=</span><span class="n">job_def_arn</span><span class="p">,</span> <span class="n">output_bucket</span><span class="o">=</span><span class="n">output_bucket</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ResourceExists</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create AWS job definition using instance parameters</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        string</span>
<span class="sd">            Amazon Resource Number (ARN) for the created job definition</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If docker_image is a string, assume it contains the image URI</span>
        <span class="c1"># Else it&#39;s a DockerRepo instance, get the uri property</span>
        <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">docker_image</span> \
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">docker_image</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span> \
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">docker_image</span><span class="o">.</span><span class="n">repo_uri</span>

        <span class="n">job_container_properties</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="n">image</span><span class="p">,</span>
            <span class="s1">&#39;vcpus&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">vcpus</span><span class="p">,</span>
            <span class="s1">&#39;memory&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">,</span>
            <span class="s1">&#39;command&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;jobRoleArn&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_role_arn</span><span class="p">,</span>
            <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
            <span class="s1">&#39;environment&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;CLOUDKNOT_JOBS_S3_BUCKET&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_bucket</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;CLOUDKNOT_S3_JOBDEF_KEY&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
                <span class="p">}</span>
            <span class="p">],</span>
        <span class="p">}</span>

        <span class="c1"># Register the job def</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">register_job_definition</span><span class="p">(</span>
            <span class="n">jobDefinitionName</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;container&#39;</span><span class="p">,</span>
            <span class="n">containerProperties</span><span class="o">=</span><span class="n">job_container_properties</span><span class="p">,</span>
            <span class="n">retryStrategy</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;attempts&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">retries</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="n">arn</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;jobDefinitionArn&#39;</span><span class="p">]</span>

        <span class="c1"># Add this job def to the list of job definitions in the config file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_section_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_section_name</span><span class="p">(</span><span class="s1">&#39;job-definitions&#39;</span><span class="p">)</span>
        <span class="n">cloudknot</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_section_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">arn</span><span class="p">)</span>

        <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Created AWS batch job definition </span><span class="si">{name:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="p">))</span>

        <span class="k">return</span> <span class="n">arn</span>

<div class="viewcode-block" id="JobDefinition.clobber"><a class="viewcode-back" href="../../../api/_autosummary/cloudknot.aws.JobDefinition.html#cloudknot.aws.JobDefinition.clobber">[docs]</a>    <span class="k">def</span> <span class="nf">clobber</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deregister this AWS batch job definition&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clobbered</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_profile_and_region</span><span class="p">()</span>

        <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">deregister_job_definition</span><span class="p">(</span><span class="n">jobDefinition</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">arn</span><span class="p">)</span>

        <span class="c1"># Remove this job def from the list of job defs in the config file</span>
        <span class="n">cloudknot</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">remove_resource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_section_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Set the clobbered parameter to True,</span>
        <span class="c1"># preventing subsequent method calls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clobbered</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Deregistered job definition </span><span class="si">{name:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="p">))</span></div></div>


<span class="c1"># noinspection PyPropertyAccess,PyAttributeOutsideInit</span>
<div class="viewcode-block" id="ComputeEnvironment"><a class="viewcode-back" href="../../../api/_autosummary/cloudknot.aws.ComputeEnvironment.html#cloudknot.aws.ComputeEnvironment">[docs]</a><span class="k">class</span> <span class="nc">ComputeEnvironment</span><span class="p">(</span><span class="n">ObjectWithArn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class for defining AWS Compute Environments&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_service_role</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">instance_role</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vpc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">security_group</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">spot_fleet_role</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">instance_types</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resource_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">min_vcpus</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_vcpus</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">desired_vcpus</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">image_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ec2_key_pair</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">bid_percentage</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize an AWS Batch job definition object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        arn : string</span>
<span class="sd">            Amazon Resource Number of this compute environment</span>

<span class="sd">        name : string</span>
<span class="sd">            Name of the compute environment</span>

<span class="sd">        batch_service_role : IamRole</span>
<span class="sd">            IamRole instance for the AWS IAM batch service role</span>

<span class="sd">        instance_role : IamRole</span>
<span class="sd">            IamRole instance for the AWS IAM instance role</span>

<span class="sd">        vpc: Vpc</span>
<span class="sd">            Vpc instance for the AWS virtual private cloud that this</span>
<span class="sd">            compute environment will use</span>

<span class="sd">        security_group: SecurityGroup</span>
<span class="sd">            SecurityGroup instance for the AWS security group that this</span>
<span class="sd">            compute environment will use</span>

<span class="sd">        spot_fleet_role : IamRole</span>
<span class="sd">            optional IamRole instance for the AWS IAM spot fleet role.</span>
<span class="sd">            Default: None</span>

<span class="sd">        instance_types : string or sequence of strings</span>
<span class="sd">            instance types that may be launched in this compute environment.</span>
<span class="sd">            Default: (&#39;optimal&#39;,)</span>

<span class="sd">        resource_type : string</span>
<span class="sd">            Resource type, either &quot;EC2&quot; or &quot;SPOT&quot;</span>

<span class="sd">        min_vcpus : int</span>
<span class="sd">            minimum number of virtual cpus for instances launched in this</span>
<span class="sd">            compute environment. CAREFUL HERE: If you specify min_vcpus</span>
<span class="sd">            greater than 0, your ECS cluster will keep instances spinning</span>
<span class="sd">            even when there is no work to do. We strongly recommend</span>
<span class="sd">            keeping min_vpucs set at 0.</span>
<span class="sd">            Default: 0</span>

<span class="sd">        max_vcpus : int</span>
<span class="sd">            maximum number of virtual cpus for instances launched in this</span>
<span class="sd">            compute environment.</span>
<span class="sd">            Default: 256</span>

<span class="sd">        desired_vcpus : int</span>
<span class="sd">            desired number of virtual cpus for instances launched in this</span>
<span class="sd">            compute environment.</span>
<span class="sd">            Default: 8</span>

<span class="sd">        image_id : string</span>
<span class="sd">            optional AMI id used for instances launched in this compute</span>
<span class="sd">            environment.</span>
<span class="sd">            Default: None</span>

<span class="sd">        ec2_key_pair : string</span>
<span class="sd">            optional EC2 key pair used for instances launched in this compute</span>
<span class="sd">            environment.</span>
<span class="sd">            Default: None</span>

<span class="sd">        tags : dictionary</span>
<span class="sd">            optional key-value pair tags to be applied to resources in this</span>
<span class="sd">            compute environment.</span>
<span class="sd">            Default: None</span>

<span class="sd">        bid_percentage : int</span>
<span class="sd">            bid percentage if using spot instances.</span>
<span class="sd">            Default: 50</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate for minimum input</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">arn</span> <span class="ow">or</span> <span class="n">name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;You must supply either an arn or name for this &#39;</span>
                <span class="s1">&#39;compute environment.&#39;</span>
            <span class="p">)</span>

        <span class="c1"># Validate in case of over-specified input</span>
        <span class="k">if</span> <span class="n">arn</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">([</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">batch_service_role</span><span class="p">,</span> <span class="n">instance_role</span><span class="p">,</span> <span class="n">vpc</span><span class="p">,</span> <span class="n">security_group</span><span class="p">,</span>
            <span class="n">spot_fleet_role</span><span class="p">,</span> <span class="n">instance_types</span><span class="p">,</span> <span class="n">resource_type</span><span class="p">,</span> <span class="n">min_vcpus</span><span class="p">,</span>
            <span class="n">max_vcpus</span><span class="p">,</span> <span class="n">desired_vcpus</span><span class="p">,</span> <span class="n">image_id</span><span class="p">,</span> <span class="n">ec2_key_pair</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span>
            <span class="n">bid_percentage</span>
        <span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;You may supply either an arn or compute &#39;</span>
                <span class="s1">&#39;environment parameters, but not both.&#39;</span>
            <span class="p">)</span>

        <span class="c1"># Check if this compute environment already exists</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exists_already</span><span class="p">(</span><span class="n">arn</span><span class="o">=</span><span class="n">arn</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pre_existing</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">exists</span>

        <span class="k">if</span> <span class="n">resource</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
            <span class="c1"># If pre-existing, then user supplied either arn or name. Above,</span>
            <span class="c1"># we raised error if user provided arn plus input parameters.</span>
            <span class="c1"># Now, check that they did not provide a pre-existing name plus</span>
            <span class="c1"># input parameters</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">([</span>
                <span class="n">batch_service_role</span><span class="p">,</span> <span class="n">instance_role</span><span class="p">,</span> <span class="n">vpc</span><span class="p">,</span> <span class="n">security_group</span><span class="p">,</span>
                <span class="n">spot_fleet_role</span><span class="p">,</span> <span class="n">instance_types</span><span class="p">,</span> <span class="n">resource_type</span><span class="p">,</span> <span class="n">min_vcpus</span><span class="p">,</span>
                <span class="n">max_vcpus</span><span class="p">,</span> <span class="n">desired_vcpus</span><span class="p">,</span> <span class="n">image_id</span><span class="p">,</span> <span class="n">ec2_key_pair</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span>
                <span class="n">bid_percentage</span>
            <span class="p">]):</span>
                <span class="k">raise</span> <span class="n">ResourceExistsException</span><span class="p">(</span>
                    <span class="s1">&#39;You provided input parameters for a compute environment &#39;</span>
                    <span class="s1">&#39;that already exists. If you would like to create a new &#39;</span>
                    <span class="s1">&#39;compute environment, please use a different name. If &#39;</span>
                    <span class="s1">&#39;you would like to retrieve the details of this compute &#39;</span>
                    <span class="s1">&#39;environment, use ComputeEnvironment(&#39;</span>
                    <span class="s1">&#39;arn=</span><span class="si">{arn:s}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arn</span><span class="o">=</span><span class="n">resource</span><span class="o">.</span><span class="n">arn</span><span class="p">),</span>
                    <span class="n">resource</span><span class="o">.</span><span class="n">arn</span>
                <span class="p">)</span>

            <span class="c1"># Fill parameters with queried values</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">ComputeEnvironment</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">resource</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_batch_service_role</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_batch_service_role_arn</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">batch_service_role_arn</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_instance_role</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_instance_role_arn</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">instance_role_arn</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_vpc</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_subnets</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">subnets</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_security_group</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_security_group_ids</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">security_group_ids</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_spot_fleet_role</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_spot_fleet_role_arn</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">spot_fleet_role_arn</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_instance_types</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">instance_types</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resource_type</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">resource_type</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_min_vcpus</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">min_vcpus</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_max_vcpus</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">max_vcpus</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_desired_vcpus</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">desired_vcpus</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_image_id</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">image_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ec2_key_pair</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">ec2_key_pair</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">tags</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bid_percentage</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">bid_percentage</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_arn</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">arn</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_section_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_section_name</span><span class="p">(</span><span class="s1">&#39;compute-environments&#39;</span><span class="p">)</span>
            <span class="n">cloudknot</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_section_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">arn</span>
            <span class="p">)</span>

            <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Retrieved pre-existing compute environment </span><span class="si">{name:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If user supplied only a name or only an arn, expecting to</span>
            <span class="c1"># retrieve info on pre-existing job queue, throw error</span>
            <span class="k">if</span> <span class="n">arn</span> <span class="ow">or</span> <span class="p">(</span><span class="n">name</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span>
                <span class="n">batch_service_role</span><span class="p">,</span> <span class="n">instance_role</span><span class="p">,</span> <span class="n">vpc</span><span class="p">,</span> <span class="n">security_group</span>
            <span class="p">])):</span>
                <span class="k">raise</span> <span class="n">ResourceDoesNotExistException</span><span class="p">(</span>
                    <span class="s1">&#39;The job queue you requested does not exist.&#39;</span><span class="p">,</span>
                    <span class="n">arn</span>
                <span class="p">)</span>

            <span class="c1"># Otherwise, validate input and set parameters</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">ComputeEnvironment</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

            <span class="c1"># If resource type is &#39;SPOT&#39;, user must also specify</span>
            <span class="c1"># a bid percentage and a spot fleet IAM role</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">bid_percentage</span> <span class="ow">and</span> <span class="n">resource_type</span> <span class="o">==</span> <span class="s1">&#39;SPOT&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;if resource_type is &quot;SPOT&quot;, bid_percentage &#39;</span>
                    <span class="s1">&#39;must be set.&#39;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">spot_fleet_role</span> <span class="ow">and</span> <span class="n">resource_type</span> <span class="o">==</span> <span class="s1">&#39;SPOT&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;if resource_type is &quot;SPOT&quot;, spot_fleet_role &#39;</span>
                    <span class="s1">&#39;must be set.&#39;</span>
                <span class="p">)</span>

            <span class="c1"># Validate batch_service_role is actually a batch role</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">batch_service_role</span><span class="p">,</span> <span class="n">IamRole</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="s1">&#39;batch&#39;</span> <span class="ow">in</span> <span class="n">batch_service_role</span><span class="o">.</span><span class="n">service</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;batch_service_role must be an IamRole &#39;</span>
                    <span class="s1">&#39;instance with service type &quot;batch&quot;&#39;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_batch_service_role</span> <span class="o">=</span> <span class="n">batch_service_role</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_batch_service_role_arn</span> <span class="o">=</span> <span class="n">batch_service_role</span><span class="o">.</span><span class="n">arn</span>

            <span class="c1"># Validate instance_role is actually an instance role</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">instance_role</span><span class="p">,</span> <span class="n">IamRole</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">instance_role</span><span class="o">.</span><span class="n">instance_profile_arn</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;instance_role must be an IamRole instance &#39;</span>
                    <span class="s1">&#39;with an instance profile ARN&#39;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_instance_role</span> <span class="o">=</span> <span class="n">instance_role</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_instance_role_arn</span> <span class="o">=</span> <span class="n">instance_role</span><span class="o">.</span><span class="n">instance_profile_arn</span>

            <span class="c1"># Validate vpc input</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vpc</span><span class="p">,</span> <span class="n">Vpc</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;vpc must be an instance of Vpc&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vpc</span> <span class="o">=</span> <span class="n">vpc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_subnets</span> <span class="o">=</span> <span class="n">vpc</span><span class="o">.</span><span class="n">subnet_ids</span>

            <span class="c1"># Validate security group input</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">security_group</span><span class="p">,</span> <span class="n">SecurityGroup</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;security_group must be an instance of &#39;</span>
                    <span class="s1">&#39;SecurityGroup&#39;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_security_group</span> <span class="o">=</span> <span class="n">security_group</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_security_group_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">security_group</span><span class="o">.</span><span class="n">security_group_id</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">spot_fleet_role</span><span class="p">:</span>
                <span class="c1"># Validate that spot_fleet_role is actually a spot fleet role</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">spot_fleet_role</span><span class="p">,</span> <span class="n">IamRole</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="s1">&#39;spotfleet&#39;</span> <span class="ow">in</span> <span class="n">spot_fleet_role</span><span class="o">.</span><span class="n">service</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;if provided, spot_fleet_role must be an &#39;</span>
                        <span class="s1">&#39;IamRole instance with service type &#39;</span>
                        <span class="s1">&#39;&quot;spotfleet&quot;&#39;</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_spot_fleet_role</span> <span class="o">=</span> <span class="n">spot_fleet_role</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_spot_fleet_role_arn</span> <span class="o">=</span> <span class="n">spot_fleet_role</span><span class="o">.</span><span class="n">arn</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_spot_fleet_role</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_spot_fleet_role_arn</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Default instance type is &#39;optimal&#39;</span>
            <span class="n">instance_types</span> <span class="o">=</span> <span class="n">instance_types</span> <span class="k">if</span> <span class="n">instance_types</span> <span class="k">else</span> <span class="p">[</span><span class="s1">&#39;optimal&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instance_types</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_instance_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">instance_types</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">instance_types</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_instance_types</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">instance_types</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;instance_types must be a string or a &#39;</span>
                    <span class="s1">&#39;sequence of strings.&#39;</span>
                <span class="p">)</span>

            <span class="c1"># Validate instance types</span>
            <span class="n">valid_instance_types</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;optimal&#39;</span><span class="p">,</span> <span class="s1">&#39;m3&#39;</span><span class="p">,</span> <span class="s1">&#39;m4&#39;</span><span class="p">,</span> <span class="s1">&#39;c3&#39;</span><span class="p">,</span> <span class="s1">&#39;c4&#39;</span><span class="p">,</span> <span class="s1">&#39;r3&#39;</span><span class="p">,</span> <span class="s1">&#39;i2&#39;</span><span class="p">,</span> <span class="s1">&#39;d2&#39;</span><span class="p">,</span> <span class="s1">&#39;g2&#39;</span><span class="p">,</span>
                <span class="s1">&#39;p2&#39;</span><span class="p">,</span> <span class="s1">&#39;x1&#39;</span><span class="p">,</span> <span class="s1">&#39;m3.medium&#39;</span><span class="p">,</span> <span class="s1">&#39;m3.large&#39;</span><span class="p">,</span> <span class="s1">&#39;m3.xlarge&#39;</span><span class="p">,</span> <span class="s1">&#39;m3.2xlarge&#39;</span><span class="p">,</span>
                <span class="s1">&#39;m4.large&#39;</span><span class="p">,</span> <span class="s1">&#39;m4.xlarge&#39;</span><span class="p">,</span> <span class="s1">&#39;m4.2xlarge&#39;</span><span class="p">,</span> <span class="s1">&#39;m4.4xlarge&#39;</span><span class="p">,</span>
                <span class="s1">&#39;m4.10xlarge&#39;</span><span class="p">,</span> <span class="s1">&#39;m4.16xlarge&#39;</span><span class="p">,</span> <span class="s1">&#39;c3.8xlarge&#39;</span><span class="p">,</span> <span class="s1">&#39;c3.4xlarge&#39;</span><span class="p">,</span>
                <span class="s1">&#39;c3.2xlarge&#39;</span><span class="p">,</span> <span class="s1">&#39;c3.xlarge&#39;</span><span class="p">,</span> <span class="s1">&#39;c3.large&#39;</span><span class="p">,</span> <span class="s1">&#39;c4.8xlarge&#39;</span><span class="p">,</span>
                <span class="s1">&#39;c4.4xlarge&#39;</span><span class="p">,</span> <span class="s1">&#39;c4.2xlarge&#39;</span><span class="p">,</span> <span class="s1">&#39;c4.xlarge&#39;</span><span class="p">,</span> <span class="s1">&#39;c4.large&#39;</span><span class="p">,</span>
                <span class="s1">&#39;r3.8xlarge&#39;</span><span class="p">,</span> <span class="s1">&#39;r3.4xlarge&#39;</span><span class="p">,</span> <span class="s1">&#39;r3.2xlarge&#39;</span><span class="p">,</span> <span class="s1">&#39;r3.xlarge&#39;</span><span class="p">,</span>
                <span class="s1">&#39;r3.large&#39;</span><span class="p">,</span> <span class="s1">&#39;i2.8xlarge&#39;</span><span class="p">,</span> <span class="s1">&#39;i2.4xlarge&#39;</span><span class="p">,</span> <span class="s1">&#39;i2.2xlarge&#39;</span><span class="p">,</span>
                <span class="s1">&#39;i2.xlarge&#39;</span><span class="p">,</span> <span class="s1">&#39;g2.2xlarge&#39;</span><span class="p">,</span> <span class="s1">&#39;g2.8xlarge&#39;</span><span class="p">,</span> <span class="s1">&#39;p2.large&#39;</span><span class="p">,</span>
                <span class="s1">&#39;p2.8xlarge&#39;</span><span class="p">,</span> <span class="s1">&#39;p2.16xlarge&#39;</span><span class="p">,</span> <span class="s1">&#39;d2.8xlarge&#39;</span><span class="p">,</span> <span class="s1">&#39;d2.4xlarge&#39;</span><span class="p">,</span>
                <span class="s1">&#39;d2.2xlarge&#39;</span><span class="p">,</span> <span class="s1">&#39;d2.xlarge&#39;</span><span class="p">,</span> <span class="s1">&#39;x1.32xlarge&#39;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_instance_types</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">valid_instance_types</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;instance_types must be a subset of </span><span class="si">{types!s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">types</span><span class="o">=</span><span class="n">valid_instance_types</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="c1"># Validate resource type, default to &#39;EC2&#39;</span>
            <span class="n">resource_type</span> <span class="o">=</span> <span class="n">resource_type</span> <span class="k">if</span> <span class="n">resource_type</span> <span class="k">else</span> <span class="s1">&#39;EC2&#39;</span>
            <span class="k">if</span> <span class="n">resource_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;EC2&#39;</span><span class="p">,</span> <span class="s1">&#39;SPOT&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;resource_type must be &quot;EC2&quot; or &quot;SPOT&quot;&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resource_type</span> <span class="o">=</span> <span class="n">resource_type</span>

            <span class="c1"># Validate min_vcpus, default to 0</span>
            <span class="n">min_vcpus</span> <span class="o">=</span> <span class="n">min_vcpus</span> <span class="k">if</span> <span class="n">min_vcpus</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">cpus</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">min_vcpus</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cpus</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;min_vcpus must be non-negative&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_min_vcpus</span> <span class="o">=</span> <span class="n">cpus</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_vcpus</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">mod_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s1">&#39;min_vcpus is greater than zero. This means that your &#39;</span>
                    <span class="s1">&#39;compute environment will maintain some EC2 vCPUs, &#39;</span>
                    <span class="s1">&#39;regardless of job demand, potentially resulting in &#39;</span>
                    <span class="s1">&#39;unnecessary AWS charges. We strongly recommend using &#39;</span>
                    <span class="s1">&#39;a compute environment with min_vcpus set to zero.&#39;</span>
                <span class="p">)</span>

            <span class="c1"># Validate max_vcpus, default to 256</span>
            <span class="n">max_vcpus</span> <span class="o">=</span> <span class="n">max_vcpus</span> <span class="k">if</span> <span class="n">max_vcpus</span> <span class="k">else</span> <span class="mi">256</span>
            <span class="n">cpus</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_vcpus</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cpus</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;max_vcpus must be non-negative&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_max_vcpus</span> <span class="o">=</span> <span class="n">cpus</span>

            <span class="c1"># Validate desired_vcpus input, default to 8</span>
            <span class="n">desired_vcpus</span> <span class="o">=</span> <span class="n">desired_vcpus</span> <span class="k">if</span> <span class="n">desired_vcpus</span> <span class="k">else</span> <span class="mi">8</span>
            <span class="n">cpus</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">desired_vcpus</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cpus</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;desired_vcpus must be non-negative&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_desired_vcpus</span> <span class="o">=</span> <span class="n">cpus</span>

            <span class="c1"># Validate image_id input</span>
            <span class="k">if</span> <span class="n">image_id</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image_id</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;if provided, image_id must be a string&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_image_id</span> <span class="o">=</span> <span class="n">image_id</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_image_id</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Validate ec2_key_pair input</span>
            <span class="k">if</span> <span class="n">ec2_key_pair</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ec2_key_pair</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;if provided, ec2_key_pair must be a string&#39;</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ec2_key_pair</span> <span class="o">=</span> <span class="n">ec2_key_pair</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ec2_key_pair</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Validate tags input</span>
            <span class="k">if</span> <span class="n">tags</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;if provided, tags must be an instance of dict&#39;</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_type</span> <span class="o">==</span> <span class="s1">&#39;SPOT&#39;</span><span class="p">:</span>
                    <span class="n">mod_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s1">&#39;Tags are not supported for compute environment of &#39;</span>
                        <span class="s1">&#39;type &quot;SPOT&quot;. Ignoring input tags&#39;</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span> <span class="o">=</span> <span class="n">tags</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Validate bid_percentage input</span>
            <span class="k">if</span> <span class="n">bid_percentage</span><span class="p">:</span>
                <span class="n">bp_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bid_percentage</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">bp_int</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_bid_percentage</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">elif</span> <span class="n">bp_int</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_bid_percentage</span> <span class="o">=</span> <span class="mi">100</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_bid_percentage</span> <span class="o">=</span> <span class="n">bp_int</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_bid_percentage</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_arn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create</span><span class="p">()</span>

    <span class="c1"># Declare read-only properties</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pre_existing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Boolean flag to indicate whether this resource was pre-existing</span>

<span class="sd">        True if resource was retrieved from AWS,</span>
<span class="sd">        False if it was created on __init__.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_existing</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">batch_service_role</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;IamRole instance for the AWS IAM batch service role&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_service_role</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">batch_service_role_arn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;ARN for this compute environment&#39;s IAM batch service role&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_service_role_arn</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">instance_role</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;IamRole instance for the AWS IAM instance role&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instance_role</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">instance_role_arn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;ARN for this compute environment&#39;s IAM instance role&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instance_role_arn</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vpc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Vpc instance that this compute environment will use&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vpc</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">subnets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;VPC subnets that this compute environment will use&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subnets</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">security_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;SecurityGroup instance that this compute environment will use&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_security_group</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">security_group_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Security group IDs for this compute environment&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_security_group_ids</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">spot_fleet_role</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;optional IamRole instance for the AWS IAM spot fleet role&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spot_fleet_role</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">spot_fleet_role_arn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;ARN for this compute environment&#39;s IAM spot fleet role&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spot_fleet_role_arn</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">instance_types</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Instance types that may be launched in this compute environment&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instance_types</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">resource_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Resource type, either &#39;EC2&#39; or &#39;SPOT&#39;&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource_type</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">min_vcpus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Minimum number of vCPUs for instances in this compute environment&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_vcpus</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">max_vcpus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Maximum number of vCPUs for instances in this compute environment&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_vcpus</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desired_vcpus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Desired number of vCPUs for instances in this compute environment&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_desired_vcpus</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">image_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Optional AMI id used for instances in this compute environment&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ec2_key_pair</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Optional EC2 key pair for instances in this compute environment&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ec2_key_pair</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Optional tags to apply to resources in this compute environment&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bid_percentage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Bid percentage if using spot instances&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bid_percentage</span>

    <span class="k">def</span> <span class="nf">_exists_already</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arn</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if a compute environment exists already</span>

<span class="sd">        If compute environment exists, return namedtuple with compute</span>
<span class="sd">        environment info. Otherwise, set the namedtuple&#39;s `exists` field to</span>
<span class="sd">        `False`. The remaining fields default to `None`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        namedtuple ResourceExists</span>
<span class="sd">            A namedtuple with fields</span>
<span class="sd">            [&#39;exists&#39;, &#39;name&#39;, &#39;batch_service_role_arn&#39;, &#39;instance_role_arn&#39;,</span>
<span class="sd">             &#39;subnets&#39;, &#39;security_group_ids&#39;, &#39;spot_fleet_role_arn&#39;,</span>
<span class="sd">             &#39;instance_types&#39;, &#39;resource_type&#39;, &#39;min_vcpus&#39;, &#39;max_vcpus&#39;,</span>
<span class="sd">             &#39;desired_vcpus&#39;, &#39;image_id&#39;, &#39;ec2_key_pair&#39;, &#39;tags&#39;,</span>
<span class="sd">             &#39;bid_percentage&#39;, &#39;arn&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># define a namedtuple for return value type</span>
        <span class="n">ResourceExists</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
            <span class="s1">&#39;ResourceExists&#39;</span><span class="p">,</span>
            <span class="p">[</span><span class="s1">&#39;exists&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;batch_service_role_arn&#39;</span><span class="p">,</span> <span class="s1">&#39;instance_role_arn&#39;</span><span class="p">,</span>
             <span class="s1">&#39;subnets&#39;</span><span class="p">,</span> <span class="s1">&#39;security_group_ids&#39;</span><span class="p">,</span> <span class="s1">&#39;spot_fleet_role_arn&#39;</span><span class="p">,</span>
             <span class="s1">&#39;instance_types&#39;</span><span class="p">,</span> <span class="s1">&#39;resource_type&#39;</span><span class="p">,</span> <span class="s1">&#39;min_vcpus&#39;</span><span class="p">,</span> <span class="s1">&#39;max_vcpus&#39;</span><span class="p">,</span>
             <span class="s1">&#39;desired_vcpus&#39;</span><span class="p">,</span> <span class="s1">&#39;image_id&#39;</span><span class="p">,</span> <span class="s1">&#39;ec2_key_pair&#39;</span><span class="p">,</span> <span class="s1">&#39;tags&#39;</span><span class="p">,</span>
             <span class="s1">&#39;bid_percentage&#39;</span><span class="p">,</span> <span class="s1">&#39;arn&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># make all but the first value default to None</span>
        <span class="n">ResourceExists</span><span class="o">.</span><span class="fm">__new__</span><span class="o">.</span><span class="vm">__defaults__</span> <span class="o">=</span> \
            <span class="p">(</span><span class="kc">None</span><span class="p">,)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ResourceExists</span><span class="o">.</span><span class="n">_fields</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">arn</span><span class="p">:</span>
            <span class="c1"># Search by ARN</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe_compute_environments</span><span class="p">(</span>
                <span class="n">computeEnvironments</span><span class="o">=</span><span class="p">[</span><span class="n">arn</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Search by name</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe_compute_environments</span><span class="p">(</span>
                <span class="n">computeEnvironments</span><span class="o">=</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;computeEnvironments&#39;</span><span class="p">):</span>
            <span class="n">ce</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;computeEnvironments&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ce_name</span> <span class="o">=</span> <span class="n">ce</span><span class="p">[</span><span class="s1">&#39;computeEnvironmentName&#39;</span><span class="p">]</span>
            <span class="n">batch_service_role_arn</span> <span class="o">=</span> <span class="n">ce</span><span class="p">[</span><span class="s1">&#39;serviceRole&#39;</span><span class="p">]</span>
            <span class="n">ce_arn</span> <span class="o">=</span> <span class="n">ce</span><span class="p">[</span><span class="s1">&#39;computeEnvironmentArn&#39;</span><span class="p">]</span>

            <span class="n">cr</span> <span class="o">=</span> <span class="n">ce</span><span class="p">[</span><span class="s1">&#39;computeResources&#39;</span><span class="p">]</span>
            <span class="n">instance_role_arn</span> <span class="o">=</span> <span class="n">cr</span><span class="p">[</span><span class="s1">&#39;instanceRole&#39;</span><span class="p">]</span>
            <span class="n">subnets</span> <span class="o">=</span> <span class="n">cr</span><span class="p">[</span><span class="s1">&#39;subnets&#39;</span><span class="p">]</span>
            <span class="n">security_group_ids</span> <span class="o">=</span> <span class="n">cr</span><span class="p">[</span><span class="s1">&#39;securityGroupIds&#39;</span><span class="p">]</span>
            <span class="n">instance_types</span> <span class="o">=</span> <span class="n">cr</span><span class="p">[</span><span class="s1">&#39;instanceTypes&#39;</span><span class="p">]</span>
            <span class="n">resource_type</span> <span class="o">=</span> <span class="n">cr</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
            <span class="n">min_vcpus</span> <span class="o">=</span> <span class="n">cr</span><span class="p">[</span><span class="s1">&#39;minvCpus&#39;</span><span class="p">]</span>
            <span class="n">max_vcpus</span> <span class="o">=</span> <span class="n">cr</span><span class="p">[</span><span class="s1">&#39;maxvCpus&#39;</span><span class="p">]</span>

            <span class="c1"># Some retrieved compute environments will be missing optional</span>
            <span class="c1"># parameters, so try/catch for KeyErrors for the following.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">desired_vcpus</span> <span class="o">=</span> <span class="n">cr</span><span class="p">[</span><span class="s1">&#39;desiredvCpus&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>  <span class="c1"># pragma: nocover</span>
                <span class="n">desired_vcpus</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">image_id</span> <span class="o">=</span> <span class="n">cr</span><span class="p">[</span><span class="s1">&#39;imageId&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">image_id</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">ec2_key_pair</span> <span class="o">=</span> <span class="n">cr</span><span class="p">[</span><span class="s1">&#39;ec2KeyPair&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">ec2_key_pair</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="n">cr</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>  <span class="c1"># pragma: nocover</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">bid_percentage</span> <span class="o">=</span> <span class="n">cr</span><span class="p">[</span><span class="s1">&#39;bidPercentage&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">bid_percentage</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">spot_fleet_role_arn</span> <span class="o">=</span> <span class="n">cr</span><span class="p">[</span><span class="s1">&#39;spotIamFleetRole&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">spot_fleet_role_arn</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Compute environment </span><span class="si">{name:s}</span><span class="s1"> already exists.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">ce_name</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="n">ResourceExists</span><span class="p">(</span>
                <span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">ce_name</span><span class="p">,</span>
                <span class="n">batch_service_role_arn</span><span class="o">=</span><span class="n">batch_service_role_arn</span><span class="p">,</span>
                <span class="n">instance_role_arn</span><span class="o">=</span><span class="n">instance_role_arn</span><span class="p">,</span> <span class="n">subnets</span><span class="o">=</span><span class="n">subnets</span><span class="p">,</span>
                <span class="n">security_group_ids</span><span class="o">=</span><span class="n">security_group_ids</span><span class="p">,</span>
                <span class="n">spot_fleet_role_arn</span><span class="o">=</span><span class="n">spot_fleet_role_arn</span><span class="p">,</span>
                <span class="n">instance_types</span><span class="o">=</span><span class="n">instance_types</span><span class="p">,</span>
                <span class="n">resource_type</span><span class="o">=</span><span class="n">resource_type</span><span class="p">,</span> <span class="n">min_vcpus</span><span class="o">=</span><span class="n">min_vcpus</span><span class="p">,</span>
                <span class="n">max_vcpus</span><span class="o">=</span><span class="n">max_vcpus</span><span class="p">,</span> <span class="n">desired_vcpus</span><span class="o">=</span><span class="n">desired_vcpus</span><span class="p">,</span>
                <span class="n">image_id</span><span class="o">=</span><span class="n">image_id</span><span class="p">,</span> <span class="n">ec2_key_pair</span><span class="o">=</span><span class="n">ec2_key_pair</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span>
                <span class="n">bid_percentage</span><span class="o">=</span><span class="n">bid_percentage</span><span class="p">,</span> <span class="n">arn</span><span class="o">=</span><span class="n">ce_arn</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ResourceExists</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create AWS compute environment using instance parameters</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        string</span>
<span class="sd">            Amazon Resource Number (ARN) for the created compute environment</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">compute_resources</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_type</span><span class="p">,</span>
            <span class="s1">&#39;minvCpus&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_vcpus</span><span class="p">,</span>
            <span class="s1">&#39;maxvCpus&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_vcpus</span><span class="p">,</span>
            <span class="s1">&#39;desiredvCpus&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">desired_vcpus</span><span class="p">,</span>
            <span class="s1">&#39;instanceTypes&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance_types</span><span class="p">,</span>
            <span class="s1">&#39;subnets&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">subnets</span><span class="p">,</span>
            <span class="s1">&#39;securityGroupIds&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">security_group_ids</span><span class="p">,</span>
            <span class="s1">&#39;instanceRole&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance_role_arn</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># If using spot instances, include the relevant key/value pairs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_type</span> <span class="o">==</span> <span class="s1">&#39;SPOT&#39;</span><span class="p">:</span>
            <span class="n">compute_resources</span><span class="p">[</span><span class="s1">&#39;bidPercentage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bid_percentage</span>
            <span class="n">compute_resources</span><span class="p">[</span><span class="s1">&#39;spotIamFleetRole&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot_fleet_role_arn</span>

        <span class="c1"># If tags, imageId, or ec2KeyPair are provided, include them too</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
            <span class="n">compute_resources</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_id</span><span class="p">:</span>
            <span class="n">compute_resources</span><span class="p">[</span><span class="s1">&#39;imageId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_id</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec2_key_pair</span><span class="p">:</span>
            <span class="n">compute_resources</span><span class="p">[</span><span class="s1">&#39;ec2KeyPair&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec2_key_pair</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create_compute_environment</span><span class="p">(</span>
            <span class="n">computeEnvironmentName</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;MANAGED&#39;</span><span class="p">,</span>
            <span class="n">state</span><span class="o">=</span><span class="s1">&#39;ENABLED&#39;</span><span class="p">,</span>
            <span class="n">computeResources</span><span class="o">=</span><span class="n">compute_resources</span><span class="p">,</span>
            <span class="n">serviceRole</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_service_role_arn</span>
        <span class="p">)</span>

        <span class="n">arn</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;computeEnvironmentArn&#39;</span><span class="p">]</span>

        <span class="c1"># Add this compute env to the list of compute envs in the config file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_section_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_section_name</span><span class="p">(</span><span class="s1">&#39;compute-environments&#39;</span><span class="p">)</span>
        <span class="n">cloudknot</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_section_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">arn</span><span class="p">)</span>

        <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Created compute environment </span><span class="si">{name:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="p">))</span>

        <span class="k">return</span> <span class="n">arn</span>

<div class="viewcode-block" id="ComputeEnvironment.clobber"><a class="viewcode-back" href="../../../api/_autosummary/cloudknot.aws.ComputeEnvironment.html#cloudknot.aws.ComputeEnvironment.clobber">[docs]</a>    <span class="k">def</span> <span class="nf">clobber</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete this compute environment&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clobbered</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_profile_and_region</span><span class="p">()</span>

        <span class="n">retry</span> <span class="o">=</span> <span class="n">tenacity</span><span class="o">.</span><span class="n">Retrying</span><span class="p">(</span>
            <span class="n">wait</span><span class="o">=</span><span class="n">tenacity</span><span class="o">.</span><span class="n">wait_exponential</span><span class="p">(</span><span class="nb">max</span><span class="o">=</span><span class="mi">16</span><span class="p">),</span>
            <span class="n">stop</span><span class="o">=</span><span class="n">tenacity</span><span class="o">.</span><span class="n">stop_after_delay</span><span class="p">(</span><span class="mi">180</span><span class="p">),</span>
            <span class="n">retry</span><span class="o">=</span><span class="n">tenacity</span><span class="o">.</span><span class="n">retry_if_exception_type</span><span class="p">(</span>
                <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientException</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># First set the state to disabled</span>
        <span class="n">retry</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update_compute_environment</span><span class="p">,</span>
            <span class="n">computeEnvironment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">arn</span><span class="p">,</span>
            <span class="n">state</span><span class="o">=</span><span class="s1">&#39;DISABLED&#39;</span>
        <span class="p">)</span>

        <span class="c1"># Now get the associated ECS cluster</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe_compute_environments</span><span class="p">(</span>
            <span class="n">computeEnvironments</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">arn</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">cluster_arn</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;computeEnvironments&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ecsClusterArn&#39;</span><span class="p">]</span>

        <span class="c1"># Get container instances</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ecs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">list_container_instances</span><span class="p">(</span>
            <span class="n">cluster</span><span class="o">=</span><span class="n">cluster_arn</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">instances</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;containerInstanceArns&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
            <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ecs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">deregister_container_instance</span><span class="p">(</span>
                <span class="n">cluster</span><span class="o">=</span><span class="n">cluster_arn</span><span class="p">,</span>
                <span class="n">containerInstance</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                <span class="n">force</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

        <span class="n">retry_if_exception</span> <span class="o">=</span> <span class="n">tenacity</span><span class="o">.</span><span class="n">Retrying</span><span class="p">(</span>
            <span class="n">wait</span><span class="o">=</span><span class="n">tenacity</span><span class="o">.</span><span class="n">wait_exponential</span><span class="p">(</span><span class="nb">max</span><span class="o">=</span><span class="mi">16</span><span class="p">),</span>
            <span class="n">stop</span><span class="o">=</span><span class="n">tenacity</span><span class="o">.</span><span class="n">stop_after_delay</span><span class="p">(</span><span class="mi">300</span><span class="p">),</span>
            <span class="n">retry</span><span class="o">=</span><span class="n">tenacity</span><span class="o">.</span><span class="n">retry_if_exception_type</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">retry_if_exception</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ecs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">delete_cluster</span><span class="p">,</span>
            <span class="n">cluster</span><span class="o">=</span><span class="n">cluster_arn</span>
        <span class="p">)</span>

        <span class="c1"># Wait for any associated job queues to finish updating</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe_job_queues</span><span class="p">()</span>
        <span class="n">associated_queues</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">q</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">arn</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="n">ce</span><span class="p">[</span><span class="s1">&#39;computeEnvironment&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ce</span>
                <span class="ow">in</span> <span class="n">q</span><span class="p">[</span><span class="s1">&#39;computeEnvironmentOrder&#39;</span><span class="p">]</span>
            <span class="p">],</span>
            <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;jobQueues&#39;</span><span class="p">)</span>
        <span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">retry</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
                <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">delete_compute_environment</span><span class="p">,</span>
                <span class="n">computeEnvironment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">arn</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientException</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;Error&#39;</span><span class="p">][</span><span class="s1">&#39;Message&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">error_message</span> <span class="o">==</span> <span class="s1">&#39;Cannot delete, found existing &#39;</span> \
                                <span class="s1">&#39;JobQueue relationship&#39;</span><span class="p">:</span>  <span class="c1"># pragma: nocover</span>
                <span class="k">raise</span> <span class="n">CannotDeleteResourceException</span><span class="p">(</span>
                    <span class="s1">&#39;Could not delete this compute environment &#39;</span>
                    <span class="s1">&#39;because it has job queue(s) associated with it. &#39;</span>
                    <span class="s1">&#39;If you want to delete this compute environment, &#39;</span>
                    <span class="s1">&#39;first delete the job queues with the following &#39;</span>
                    <span class="s1">&#39;ARNS: </span><span class="si">{queues!s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">queues</span><span class="o">=</span><span class="n">associated_queues</span><span class="p">),</span>
                    <span class="n">resource_id</span><span class="o">=</span><span class="n">associated_queues</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="n">tenacity</span><span class="o">.</span><span class="n">RetryError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">e</span><span class="o">.</span><span class="n">reraise</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientException</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                <span class="n">error_message</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;Error&#39;</span><span class="p">][</span><span class="s1">&#39;Message&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">error_message</span> <span class="o">==</span> <span class="s1">&#39;Cannot delete, found existing &#39;</span> \
                                    <span class="s1">&#39;JobQueue relationship&#39;</span><span class="p">:</span>  <span class="c1"># pragma: nocover</span>
                    <span class="k">raise</span> <span class="n">CannotDeleteResourceException</span><span class="p">(</span>
                        <span class="s1">&#39;Could not delete this compute environment &#39;</span>
                        <span class="s1">&#39;because it has job queue(s) associated with it. &#39;</span>
                        <span class="s1">&#39;If you want to delete this compute environment, &#39;</span>
                        <span class="s1">&#39;first delete the job queues with the following &#39;</span>
                        <span class="s1">&#39;ARNS: </span><span class="si">{queues!s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">queues</span><span class="o">=</span><span class="n">associated_queues</span><span class="p">),</span>
                        <span class="n">resource_id</span><span class="o">=</span><span class="n">associated_queues</span>
                    <span class="p">)</span>

        <span class="c1"># Remove this compute env from the list of compute envs in config file</span>
        <span class="n">cloudknot</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">remove_resource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_section_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Set the clobbered parameter to True,</span>
        <span class="c1"># preventing subsequent method calls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clobbered</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Clobbered compute environment </span><span class="si">{name:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="p">))</span></div></div>


<span class="c1"># noinspection PyPropertyAccess,PyAttributeOutsideInit</span>
<div class="viewcode-block" id="JobQueue"><a class="viewcode-back" href="../../../api/_autosummary/cloudknot.aws.JobQueue.html#cloudknot.aws.JobQueue">[docs]</a><span class="k">class</span> <span class="nc">JobQueue</span><span class="p">(</span><span class="n">ObjectWithArn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class for defining AWS Batch Job Queues&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compute_environments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">priority</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize an AWS Batch job definition object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        arn : string</span>
<span class="sd">            Amazon Resource Number of the job definition</span>

<span class="sd">        name : string</span>
<span class="sd">            Name of the job definition</span>

<span class="sd">        compute_environments : ComputeEnvironment or tuple(ComputeEnvironments)</span>
<span class="sd">            ComputeEnvironment instance or sequence of ComputeEnvironment</span>
<span class="sd">            instances (in order of priority) for this job queue to use</span>

<span class="sd">        priority : int</span>
<span class="sd">            priority for jobs in this queue</span>
<span class="sd">            Default: 1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Test for minimum input</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">arn</span> <span class="ow">or</span> <span class="n">name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;You must supply either an arn or name for this &#39;</span>
                <span class="s1">&#39;job queue.&#39;</span>
            <span class="p">)</span>

        <span class="c1"># Test for over-specified input</span>
        <span class="k">if</span> <span class="n">arn</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">([</span><span class="n">name</span><span class="p">,</span> <span class="n">compute_environments</span><span class="p">,</span> <span class="n">priority</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;You may supply either an arn or (name, &#39;</span>
                <span class="s1">&#39;compute_environments, and priority), but not &#39;</span>
                <span class="s1">&#39;both.&#39;</span>
            <span class="p">)</span>

        <span class="c1"># Check if this job queue already exists</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exists_already</span><span class="p">(</span><span class="n">arn</span><span class="o">=</span><span class="n">arn</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pre_existing</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">exists</span>

        <span class="k">if</span> <span class="n">resource</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
            <span class="c1"># If pre-existing, then user supplied either arn or name. Above,</span>
            <span class="c1"># we raised error if user provided arn plus input parameters.</span>
            <span class="c1"># Now, check that they did not provide a pre-existing name plus</span>
            <span class="c1"># input parameters</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">([</span><span class="n">compute_environments</span><span class="p">,</span> <span class="n">priority</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="n">ResourceExistsException</span><span class="p">(</span>
                    <span class="s1">&#39;You provided input parameters for a job queue that &#39;</span>
                    <span class="s1">&#39;already exists. If you would like to create a new job &#39;</span>
                    <span class="s1">&#39;queue, please use a different name. If you would like &#39;</span>
                    <span class="s1">&#39;to retrieve the details of this job queue, use JobQueue(&#39;</span>
                    <span class="s1">&#39;arn=</span><span class="si">{arn:s}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arn</span><span class="o">=</span><span class="n">resource</span><span class="o">.</span><span class="n">arn</span><span class="p">),</span>
                    <span class="n">resource</span><span class="o">.</span><span class="n">arn</span>
                <span class="p">)</span>

            <span class="c1"># Fill parameters with queried values</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">JobQueue</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">resource</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compute_environments</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compute_environment_arns</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">compute_environment_arns</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_priority</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">priority</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_arn</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">arn</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_section_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_section_name</span><span class="p">(</span><span class="s1">&#39;job-queues&#39;</span><span class="p">)</span>
            <span class="n">cloudknot</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_section_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">arn</span>
            <span class="p">)</span>

            <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Retrieved pre-existing job queue </span><span class="si">{name:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If user supplied only a name or only an arn, expecting to</span>
            <span class="c1"># retrieve info on pre-existing job queue, throw error</span>
            <span class="k">if</span> <span class="n">arn</span> <span class="ow">or</span> <span class="p">(</span><span class="n">name</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">compute_environments</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ResourceDoesNotExistException</span><span class="p">(</span>
                    <span class="s1">&#39;The job queue you requested does not exist.&#39;</span><span class="p">,</span>
                    <span class="n">arn</span>
                <span class="p">)</span>

            <span class="nb">super</span><span class="p">(</span><span class="n">JobQueue</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
            <span class="c1"># Otherwise, validate input and set parameters</span>
            <span class="c1"># Validate compute environments</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">compute_environments</span><span class="p">,</span> <span class="n">ComputeEnvironment</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_compute_environments</span> <span class="o">=</span> <span class="p">(</span><span class="n">compute_environments</span><span class="p">,)</span>
            <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ComputeEnvironment</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">compute_environments</span>
                     <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_compute_environments</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">compute_environments</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;compute_environments must be a &#39;</span>
                    <span class="s1">&#39;ComputeEnvironment instance or a sequence &#39;</span>
                    <span class="s1">&#39;of ComputeEnvironment instances.&#39;</span>
                <span class="p">)</span>

            <span class="c1"># Assign compute environment arns,</span>
            <span class="c1"># based on ComputeEnvironment input</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compute_environment_arns</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ce</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_compute_environments</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_compute_environment_arns</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
                    <span class="s1">&#39;computeEnvironment&#39;</span><span class="p">:</span> <span class="n">ce</span><span class="o">.</span><span class="n">arn</span>
                <span class="p">})</span>

            <span class="c1"># Validate priority</span>
            <span class="k">if</span> <span class="n">priority</span><span class="p">:</span>
                <span class="n">p_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">priority</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p_int</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;priority must be positive&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_priority</span> <span class="o">=</span> <span class="n">p_int</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_priority</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="c1"># Create job queue and assign arn</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_arn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create</span><span class="p">()</span>

    <span class="c1"># Declare properties</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pre_existing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Boolean flag to indicate whether this resource was pre-existing</span>

<span class="sd">        True if resource was retrieved from AWS,</span>
<span class="sd">        False if it was created on __init__.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_existing</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">compute_environments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;ComputeEnvironment instances for this job queue to use&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_environments</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">compute_environment_arns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dictionary of this queue&#39;s compute environments and priorities&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_environment_arns</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">priority</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Priority for jobs in this queue&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_priority</span>

    <span class="k">def</span> <span class="nf">_exists_already</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arn</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if an AWS job queue exists already</span>

<span class="sd">        If job queue exists, return namedtuple with job queue info.</span>
<span class="sd">        Otherwise, set the namedtuple&#39;s `exists` field to `False`.</span>
<span class="sd">        The remaining fields default to `None`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        namedtuple RoleExists</span>
<span class="sd">            A namedtuple with fields</span>
<span class="sd">            [&#39;exists&#39;, &#39;name&#39;, &#39;compute_environment_arns&#39;, &#39;priority&#39;, &#39;arn&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># define a namedtuple for return value type</span>
        <span class="n">ResourceExists</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
            <span class="s1">&#39;ResourceExists&#39;</span><span class="p">,</span>
            <span class="p">[</span><span class="s1">&#39;exists&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;compute_environment_arns&#39;</span><span class="p">,</span> <span class="s1">&#39;priority&#39;</span><span class="p">,</span> <span class="s1">&#39;arn&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># make all but the first value default to None</span>
        <span class="n">ResourceExists</span><span class="o">.</span><span class="fm">__new__</span><span class="o">.</span><span class="vm">__defaults__</span> <span class="o">=</span> \
            <span class="p">(</span><span class="kc">None</span><span class="p">,)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ResourceExists</span><span class="o">.</span><span class="n">_fields</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">arn</span><span class="p">:</span>
            <span class="c1"># Search by ARN</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe_job_queues</span><span class="p">(</span>
                <span class="n">jobQueues</span><span class="o">=</span><span class="p">[</span><span class="n">arn</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Search by name</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe_job_queues</span><span class="p">(</span>
                <span class="n">jobQueues</span><span class="o">=</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="n">q</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;jobQueues&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">q</span><span class="p">:</span>
            <span class="n">arn</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;jobQueueArn&#39;</span><span class="p">]</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;jobQueueName&#39;</span><span class="p">]</span>
            <span class="n">compute_environment_arns</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;computeEnvironmentOrder&#39;</span><span class="p">]</span>
            <span class="n">priority</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;priority&#39;</span><span class="p">]</span>

            <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Job Queue </span><span class="si">{name:s}</span><span class="s1"> already exists.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">name</span>
            <span class="p">))</span>

            <span class="k">return</span> <span class="n">ResourceExists</span><span class="p">(</span>
                <span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">arn</span><span class="o">=</span><span class="n">arn</span><span class="p">,</span>
                <span class="n">compute_environment_arns</span><span class="o">=</span><span class="n">compute_environment_arns</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ResourceExists</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create AWS batch job queue using instance parameters</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        string</span>
<span class="sd">            Amazon Resource Number (ARN) for the created job queue</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The job queue depends on a compute environment that may still be</span>
        <span class="c1"># updating or in the process of creation. Use tenacity.Retrying to</span>
        <span class="c1"># overcome this latency</span>
        <span class="n">retry</span> <span class="o">=</span> <span class="n">tenacity</span><span class="o">.</span><span class="n">Retrying</span><span class="p">(</span>
            <span class="n">wait</span><span class="o">=</span><span class="n">tenacity</span><span class="o">.</span><span class="n">wait_exponential</span><span class="p">(</span><span class="nb">max</span><span class="o">=</span><span class="mi">16</span><span class="p">),</span>
            <span class="n">stop</span><span class="o">=</span><span class="n">tenacity</span><span class="o">.</span><span class="n">stop_after_delay</span><span class="p">(</span><span class="mi">60</span><span class="p">),</span>
            <span class="n">retry</span><span class="o">=</span><span class="n">tenacity</span><span class="o">.</span><span class="n">retry_if_exception_type</span><span class="p">(</span>
                <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientException</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">retry</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create_job_queue</span><span class="p">,</span>
            <span class="n">jobQueueName</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">state</span><span class="o">=</span><span class="s1">&#39;ENABLED&#39;</span><span class="p">,</span>
            <span class="n">priority</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">priority</span><span class="p">,</span>
            <span class="n">computeEnvironmentOrder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_environment_arns</span>
        <span class="p">)</span>

        <span class="n">arn</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;jobQueueArn&#39;</span><span class="p">]</span>

        <span class="c1"># Wait for job queue to be in VALID state</span>
        <span class="n">wait_for_job_queue</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">max_wait_time</span><span class="o">=</span><span class="mi">180</span><span class="p">)</span>

        <span class="c1"># Add this job queue to the list of job queues in the config file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_section_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_section_name</span><span class="p">(</span><span class="s1">&#39;job-queues&#39;</span><span class="p">)</span>
        <span class="n">cloudknot</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_section_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">arn</span><span class="p">)</span>

        <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Created job queue </span><span class="si">{name:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">arn</span>

<div class="viewcode-block" id="JobQueue.get_jobs"><a class="viewcode-back" href="../../../api/_autosummary/cloudknot.aws.JobQueue.html#cloudknot.aws.JobQueue.get_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">get_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;ALL&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get jobs in this job queue</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        status : string</span>
<span class="sd">            The status on which to filter job results</span>
<span class="sd">            Default: &#39;ALL&#39;</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        job_ids : list</span>
<span class="sd">            A list of job-IDs for jobs in this queue</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clobbered</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ResourceClobberedException</span><span class="p">(</span>
                <span class="s1">&#39;This job queue has already been clobbered.&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">arn</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_profile_and_region</span><span class="p">()</span>

        <span class="c1"># Validate input</span>
        <span class="n">allowed_statuses</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ALL&#39;</span><span class="p">,</span> <span class="s1">&#39;SUBMITTED&#39;</span><span class="p">,</span> <span class="s1">&#39;PENDING&#39;</span><span class="p">,</span> <span class="s1">&#39;RUNNABLE&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;STARTING&#39;</span><span class="p">,</span> <span class="s1">&#39;RUNNING&#39;</span><span class="p">,</span> <span class="s1">&#39;SUCCEEDED&#39;</span><span class="p">,</span> <span class="s1">&#39;FAILED&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_statuses</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;status must be one of &#39;</span><span class="p">,</span> <span class="n">allowed_statuses</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;ALL&#39;</span><span class="p">:</span>
            <span class="c1"># status == &#39;ALL&#39; is equivalent to not specifying a status at all</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">list_jobs</span><span class="p">(</span><span class="n">jobQueue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">arn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># otherwise, filter on status</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">list_jobs</span><span class="p">(</span>
                <span class="n">jobQueue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">arn</span><span class="p">,</span> <span class="n">jobStatus</span><span class="o">=</span><span class="n">status</span>
            <span class="p">)</span>

        <span class="c1"># Return list of job_ids</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;jobSummaryList&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="JobQueue.clobber"><a class="viewcode-back" href="../../../api/_autosummary/cloudknot.aws.JobQueue.html#cloudknot.aws.JobQueue.clobber">[docs]</a>    <span class="k">def</span> <span class="nf">clobber</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete this batch job queue&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clobbered</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_profile_and_region</span><span class="p">()</span>

        <span class="c1"># First, disable submissions to the queue</span>
        <span class="n">retry</span> <span class="o">=</span> <span class="n">tenacity</span><span class="o">.</span><span class="n">Retrying</span><span class="p">(</span>
            <span class="n">wait</span><span class="o">=</span><span class="n">tenacity</span><span class="o">.</span><span class="n">wait_exponential</span><span class="p">(</span><span class="nb">max</span><span class="o">=</span><span class="mi">16</span><span class="p">),</span>
            <span class="n">stop</span><span class="o">=</span><span class="n">tenacity</span><span class="o">.</span><span class="n">stop_after_delay</span><span class="p">(</span><span class="mi">60</span><span class="p">),</span>
            <span class="n">retry</span><span class="o">=</span><span class="n">tenacity</span><span class="o">.</span><span class="n">retry_if_exception_type</span><span class="p">(</span>
                <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientException</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">retry</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update_job_queue</span><span class="p">,</span>
            <span class="n">jobQueue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">arn</span><span class="p">,</span>
            <span class="n">state</span><span class="o">=</span><span class="s1">&#39;DISABLED&#39;</span>
        <span class="p">)</span>

        <span class="c1"># Next, terminate all jobs that have not completed</span>
        <span class="k">for</span> <span class="n">status</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s1">&#39;SUBMITTED&#39;</span><span class="p">,</span> <span class="s1">&#39;PENDING&#39;</span><span class="p">,</span> <span class="s1">&#39;RUNNABLE&#39;</span><span class="p">,</span> <span class="s1">&#39;STARTING&#39;</span><span class="p">,</span> <span class="s1">&#39;RUNNING&#39;</span>
        <span class="p">]:</span>  <span class="c1"># pragma: nocover</span>
            <span class="c1"># No unit test coverage here since it costs money to submit,</span>
            <span class="c1"># and then terminate, batch jobs</span>
            <span class="n">jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_jobs</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
                <span class="n">jid</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;jobId&#39;</span><span class="p">]</span>
                <span class="n">retry</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
                    <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">terminate_job</span><span class="p">,</span>
                    <span class="n">jobId</span><span class="o">=</span><span class="n">jid</span><span class="p">,</span>
                    <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;Terminated to force job queue deletion&#39;</span>
                <span class="p">)</span>

                <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Terminated job </span><span class="si">{jid:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jid</span><span class="o">=</span><span class="n">jid</span><span class="p">))</span>

        <span class="c1"># Finally, delete the job queue</span>
        <span class="n">retry</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">delete_job_queue</span><span class="p">,</span> <span class="n">jobQueue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">arn</span><span class="p">)</span>

        <span class="c1"># Remove this job queue from the list of job queues in config file</span>
        <span class="n">cloudknot</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">remove_resource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_section_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Set the clobbered parameter to True,</span>
        <span class="c1"># preventing subsequent method calls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clobbered</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Clobbered job queue </span><span class="si">{name:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span></div></div>


<span class="c1"># noinspection PyPropertyAccess,PyAttributeOutsideInit</span>
<div class="viewcode-block" id="BatchJob"><a class="viewcode-back" href="../../../api/_autosummary/cloudknot.aws.BatchJob.html#cloudknot.aws.BatchJob">[docs]</a><span class="k">class</span> <span class="nc">BatchJob</span><span class="p">(</span><span class="n">NamedObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class for defining AWS Batch Job&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">job_queue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">job_definition</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">starmap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">environment_variables</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize an AWS Batch Job object.</span>

<span class="sd">        If requesting information on a pre-existing job, `job_id` is required.</span>
<span class="sd">        Otherwise, `name`, `job_queue`, and `job_definition` are required to</span>
<span class="sd">        submit a new job.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        job_id: string</span>
<span class="sd">            The AWS jobID, if requesting a job that already exists</span>

<span class="sd">        name : string</span>
<span class="sd">            Name of the job</span>

<span class="sd">        job_queue : JobQueue</span>
<span class="sd">            JobQueue instance specifying the job queue to which this job</span>
<span class="sd">            will be submitted</span>

<span class="sd">        job_definition : JobDefinition</span>
<span class="sd">            JobDefinition instance specifying the job definition on which</span>
<span class="sd">            to base this job</span>

<span class="sd">        input :</span>
<span class="sd">            The input to be pickled and sent to the batch job via S3</span>

<span class="sd">        starmap : bool</span>
<span class="sd">            If True, assume input is already grouped in</span>
<span class="sd">            tuples from a single iterable.</span>

<span class="sd">        environment_variables : list of dict</span>
<span class="sd">            list of key/value pairs representing environment variables</span>
<span class="sd">            sent to the container</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">has_input</span> <span class="o">=</span> <span class="nb">input</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">job_id</span> <span class="ow">or</span> <span class="nb">all</span><span class="p">([</span><span class="n">name</span><span class="p">,</span> <span class="n">job_queue</span><span class="p">,</span> <span class="n">has_input</span><span class="p">,</span> <span class="n">job_definition</span><span class="p">])):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You must supply either job_id or (name, &#39;</span>
                             <span class="s1">&#39;input, job_queue, and job_definition).&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">job_id</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">([</span><span class="n">name</span><span class="p">,</span> <span class="n">job_queue</span><span class="p">,</span> <span class="n">has_input</span><span class="p">,</span> <span class="n">job_definition</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You may supply either job_id or (name, &#39;</span>
                             <span class="s1">&#39;input, job_queue, and job_definition), &#39;</span>
                             <span class="s1">&#39;not both.&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_starmap</span> <span class="o">=</span> <span class="n">starmap</span>

        <span class="k">if</span> <span class="n">job_id</span><span class="p">:</span>
            <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exists_already</span><span class="p">(</span><span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ResourceDoesNotExistException</span><span class="p">(</span>
                    <span class="s1">&#39;jobId </span><span class="si">{id:s}</span><span class="s1"> does not exists&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">job_id</span><span class="p">),</span>
                    <span class="n">job_id</span>
                <span class="p">)</span>

            <span class="nb">super</span><span class="p">(</span><span class="n">BatchJob</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_job_queue</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_job_queue_arn</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">job_queue_arn</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_job_definition_arn</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">job_definition_arn</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_job_definition</span> <span class="o">=</span> <span class="n">JobDefinition</span><span class="p">(</span><span class="n">arn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_job_definition_arn</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_environment_variables</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">environment_variables</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_job_id</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">job_id</span>

            <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job_definition</span><span class="o">.</span><span class="n">output_bucket</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                <span class="s1">&#39;cloudknot.jobs&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_job_definition</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_job_id</span><span class="p">,</span>
                <span class="s1">&#39;input.pickle&#39;</span>
            <span class="p">])</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;s3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Body&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="s1">&#39;s3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">NoSuchBucket</span><span class="p">,</span>
                    <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;s3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">NoSuchKey</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_input</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_section_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_section_name</span><span class="p">(</span><span class="s1">&#39;batch-jobs&#39;</span><span class="p">)</span>
            <span class="n">cloudknot</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_section_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>

            <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Retrieved pre-existing batch job </span><span class="si">{id:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_id</span>
            <span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">BatchJob</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">job_queue</span><span class="p">,</span> <span class="n">JobQueue</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;job_queue must be a JobQueue instance&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_job_queue</span> <span class="o">=</span> <span class="n">job_queue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_job_queue_arn</span> <span class="o">=</span> <span class="n">job_queue</span><span class="o">.</span><span class="n">arn</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">job_definition</span><span class="p">,</span> <span class="n">JobDefinition</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;job_queue must be a JobQueue instance&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_job_definition</span> <span class="o">=</span> <span class="n">job_definition</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_job_definition_arn</span> <span class="o">=</span> <span class="n">job_definition</span><span class="o">.</span><span class="n">arn</span>

            <span class="k">if</span> <span class="n">environment_variables</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">environment_variables</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;if provided, environment_variables must &#39;</span>
                                     <span class="s1">&#39;be an instance of dict&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_environment_variables</span> <span class="o">=</span> <span class="n">environment_variables</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_environment_variables</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_input</span> <span class="o">=</span> <span class="nb">input</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_job_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">job_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;JobQueue instance to which this job will be submitted&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job_queue</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">job_queue_arn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;ARN for the job queue to which this job will be submitted&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job_queue_arn</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">job_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;JobDefinition instance on which to base this job&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job_definition</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">job_definition_arn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The ARN for the job definition on which to base this job&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job_definition_arn</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">environment_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Key/value pairs for environment variables sent to the container&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_environment_variables</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The input to be pickled and sent to the batch job via S3&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">starmap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Boolean flag to indicate whether input was &#39;pre-zipped&#39;&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_starmap</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">job_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This job&#39;s AWS jobID&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job_id</span>

    <span class="k">def</span> <span class="nf">_exists_already</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if an AWS batch job exists already</span>

<span class="sd">        If batch job exists, return namedtuple with batch job info.</span>
<span class="sd">        Otherwise, set the namedtuple&#39;s `exists` field to</span>
<span class="sd">        `False`. The remaining fields default to `None`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        namedtuple JobExists</span>
<span class="sd">            A namedtuple with fields</span>
<span class="sd">            [&#39;exists&#39;, &#39;name&#39;, &#39;job_id&#39;, &#39;job_queue_arn&#39;,</span>
<span class="sd">             &#39;job_definition_arn&#39;, &#39;environment_variables&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># define a namedtuple for return value type</span>
        <span class="n">JobExists</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
            <span class="s1">&#39;JobExists&#39;</span><span class="p">,</span>
            <span class="p">[</span><span class="s1">&#39;exists&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;job_id&#39;</span><span class="p">,</span> <span class="s1">&#39;job_queue_arn&#39;</span><span class="p">,</span>
             <span class="s1">&#39;job_definition_arn&#39;</span><span class="p">,</span> <span class="s1">&#39;environment_variables&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># make all but the first value default to None</span>
        <span class="n">JobExists</span><span class="o">.</span><span class="fm">__new__</span><span class="o">.</span><span class="vm">__defaults__</span> <span class="o">=</span> \
            <span class="p">(</span><span class="kc">None</span><span class="p">,)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">JobExists</span><span class="o">.</span><span class="n">_fields</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe_jobs</span><span class="p">(</span><span class="n">jobs</span><span class="o">=</span><span class="p">[</span><span class="n">job_id</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;jobs&#39;</span><span class="p">):</span>
            <span class="n">job</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;jobs&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;jobName&#39;</span><span class="p">]</span>
            <span class="n">job_queue_arn</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;jobQueue&#39;</span><span class="p">]</span>
            <span class="n">job_definition_arn</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;jobDefinition&#39;</span><span class="p">]</span>
            <span class="n">environment_variables</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;container&#39;</span><span class="p">][</span><span class="s1">&#39;environment&#39;</span><span class="p">]</span>

            <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Job </span><span class="si">{id:s}</span><span class="s1"> exists.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">job_id</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">JobExists</span><span class="p">(</span>
                <span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span>
                <span class="n">job_queue_arn</span><span class="o">=</span><span class="n">job_queue_arn</span><span class="p">,</span>
                <span class="n">job_definition_arn</span><span class="o">=</span><span class="n">job_definition_arn</span><span class="p">,</span>
                <span class="n">environment_variables</span><span class="o">=</span><span class="n">environment_variables</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JobExists</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># pragma: nocover</span>
        <span class="sd">&quot;&quot;&quot;Create AWS batch job using instance parameters</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        string</span>
<span class="sd">            job ID for the created batch job</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># no coverage since actually submitting a batch job for</span>
        <span class="c1"># unit testing would be expensive</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_definition</span><span class="o">.</span><span class="n">output_bucket</span>
        <span class="n">pickled_input</span> <span class="o">=</span> <span class="n">cloudpickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>

        <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">job_definition</span><span class="o">.</span><span class="n">output_bucket</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">starmap</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;--starmap&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">command</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_variables</span><span class="p">:</span>
            <span class="n">container_overrides</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;environment&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_variables</span><span class="p">,</span>
                <span class="s1">&#39;command&#39;</span><span class="p">:</span> <span class="n">command</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">container_overrides</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;command&#39;</span><span class="p">:</span> <span class="n">command</span>
            <span class="p">}</span>

        <span class="c1"># We have to submit before uploading the input in order to get the</span>
        <span class="c1"># jobID first.</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">submit_job</span><span class="p">(</span>
            <span class="n">jobName</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">jobQueue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_queue_arn</span><span class="p">,</span>
            <span class="n">jobDefinition</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_definition_arn</span><span class="p">,</span>
            <span class="n">containerOverrides</span><span class="o">=</span><span class="n">container_overrides</span>
        <span class="p">)</span>

        <span class="n">job_id</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;jobId&#39;</span><span class="p">]</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
            <span class="s1">&#39;cloudknot.jobs&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_definition</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="s1">&#39;input.pickle&#39;</span>
        <span class="p">])</span>

        <span class="c1"># Upload the input pickle</span>
        <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;s3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">put_object</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">Body</span><span class="o">=</span><span class="n">pickled_input</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>

        <span class="c1"># Add this job to the list of jobs in the config file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_section_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_section_name</span><span class="p">(</span><span class="s1">&#39;batch-jobs&#39;</span><span class="p">)</span>
        <span class="n">cloudknot</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_section_name</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span>

        <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Submitted batch job </span><span class="si">{name:s}</span><span class="s1"> with jobID &#39;</span>
            <span class="s1">&#39;</span><span class="si">{job_id:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">job_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Query AWS batch job status using instance parameter `self.job_id`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        status : dict</span>
<span class="sd">            dictionary with keys: {status, statusReason, attempts}</span>
<span class="sd">            for this AWS batch job</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clobbered</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ResourceClobberedException</span><span class="p">(</span>
                <span class="s1">&#39;This batch job has already been clobbered.&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_profile_and_region</span><span class="p">()</span>

        <span class="c1"># Query the job_id</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe_jobs</span><span class="p">(</span><span class="n">jobs</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">])</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;jobs&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Return only a subset of the job dictionary</span>
        <span class="n">status</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                  <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;statusReason&#39;</span><span class="p">,</span> <span class="s1">&#39;attempts&#39;</span><span class="p">)}</span>

        <span class="k">return</span> <span class="n">status</span>

    <span class="o">@</span> <span class="nb">property</span>
    <span class="k">def</span> <span class="nf">log_urls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the urls of the batch job logs on AWS Cloudwatch</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        log_urls : list</span>
<span class="sd">            A list of log urls for each attempt number. If the job has</span>
<span class="sd">            not yet run, this will return an empty list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attempts</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;attempts&#39;</span><span class="p">],</span>
                          <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span><span class="p">[</span><span class="s1">&#39;startedAt&#39;</span><span class="p">])</span>

        <span class="n">log_stream_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;container&#39;</span><span class="p">][</span><span class="s1">&#39;logStreamName&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attempts</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">log_name2url</span><span class="p">(</span><span class="n">log_name</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;https://console.aws.amazon.com/cloudwatch/home?region=&#39;</span> \
                   <span class="s1">&#39;</span><span class="si">{region:s}</span><span class="s1">#logEventViewer:group=/aws/batch/job;&#39;</span> \
                   <span class="s1">&#39;stream=</span><span class="si">{log_name:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">,</span>
                                                <span class="n">log_name</span><span class="o">=</span><span class="n">log_name</span><span class="p">)</span>

        <span class="n">log_urls</span> <span class="o">=</span> <span class="p">[</span><span class="n">log_name2url</span><span class="p">(</span><span class="n">log</span><span class="p">)</span> <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">log_stream_names</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">log_urls</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">done</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return True if the job is done.</span>

<span class="sd">        In this case, &quot;done&quot; means the job status is SUCCEEDED or that it is</span>
<span class="sd">        FAILED and the job has exceeded the max number of retry attempts</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span>
        <span class="n">done</span> <span class="o">=</span> <span class="p">(</span><span class="n">stat</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SUCCEEDED&#39;</span>
                <span class="ow">or</span> <span class="p">(</span><span class="n">stat</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;FAILED&#39;</span>
                    <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">stat</span><span class="p">[</span><span class="s1">&#39;attempts&#39;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_definition</span><span class="o">.</span><span class="n">retries</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">done</span>

<div class="viewcode-block" id="BatchJob.result"><a class="viewcode-back" href="../../../api/_autosummary/cloudknot.aws.BatchJob.html#cloudknot.aws.BatchJob.result">[docs]</a>    <span class="k">def</span> <span class="nf">result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the result of the latest attempt</span>

<span class="sd">        If the call hasn&#39;t yet completed then this method will wait up to</span>
<span class="sd">        timeout seconds. If the call hasn&#39;t completed in timeout seconds,</span>
<span class="sd">        then a CKTimeoutError is raised. If the batch job is in FAILED status</span>
<span class="sd">        then a BatchJobFailedError is raised.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        timeout: int or float</span>
<span class="sd">            timeout time in seconds. If timeout is not specified or None,</span>
<span class="sd">            there is no limit to the wait time.</span>
<span class="sd">            Default: None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        result:</span>
<span class="sd">            The result of the AWS Batch job</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set start time for timeout period</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">time_diff</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">done</span> <span class="ow">and</span> <span class="p">(</span><span class="n">timeout</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">time_diff</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CKTimeoutError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>

        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span>
        <span class="k">if</span> <span class="n">status</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;FAILED&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BatchJobFailedError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_definition</span><span class="o">.</span><span class="n">output_bucket</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                <span class="s1">&#39;cloudknot.jobs&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_definition</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">,</span>
                <span class="s1">&#39;</span><span class="si">{0:3d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;attempts&#39;</span><span class="p">])),</span> <span class="s1">&#39;output.pickle&#39;</span>
            <span class="p">])</span>

            <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;s3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Body&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span></div>

<div class="viewcode-block" id="BatchJob.terminate"><a class="viewcode-back" href="../../../api/_autosummary/cloudknot.aws.BatchJob.html#cloudknot.aws.BatchJob.terminate">[docs]</a>    <span class="k">def</span> <span class="nf">terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Kill AWS batch job using instance parameter `self.job_id`</span>

<span class="sd">        kill() combines the cancel and terminate AWS CLI commands. Jobs that</span>
<span class="sd">        are in the SUBMITTED, PENDING, or RUNNABLE state must be cancelled,</span>
<span class="sd">        while jobs that are in the STARTING or RUNNING state must be</span>
<span class="sd">        terminated.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        reason : string</span>
<span class="sd">            A message to attach to the job that explains the reason for</span>
<span class="sd">            cancelling/terminating it. This message is returned by future</span>
<span class="sd">            DescribeJobs operations on the job. This message is also recorded</span>
<span class="sd">            in the AWS Batch activity logs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clobbered</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ResourceClobberedException</span><span class="p">(</span>
                <span class="s1">&#39;This batch job has already been clobbered.&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_profile_and_region</span><span class="p">()</span>

        <span class="c1"># Require the user to supply a reason for job termination</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reason</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;reason must be a string.&#39;</span><span class="p">)</span>

        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;SUBMITTED&#39;</span><span class="p">,</span> <span class="s1">&#39;PENDING&#39;</span><span class="p">,</span> <span class="s1">&#39;RUNNABLE&#39;</span><span class="p">]:</span>
            <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cancel_job</span><span class="p">(</span><span class="n">jobId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="n">reason</span><span class="p">)</span>
            <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Cancelled job </span><span class="si">{name:s}</span><span class="s1"> with jobID </span><span class="si">{job_id:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">job_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_id</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">state</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;STARTING&#39;</span><span class="p">,</span> <span class="s1">&#39;RUNNING&#39;</span><span class="p">]:</span>
            <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">terminate_job</span><span class="p">(</span><span class="n">jobId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="n">reason</span><span class="p">)</span>
            <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Terminated job </span><span class="si">{name:s}</span><span class="s1"> with jobID </span><span class="si">{job_id:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">job_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_id</span>
                <span class="p">)</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="BatchJob.clobber"><a class="viewcode-back" href="../../../api/_autosummary/cloudknot.aws.BatchJob.html#cloudknot.aws.BatchJob.clobber">[docs]</a>    <span class="k">def</span> <span class="nf">clobber</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Kill an batch job and remove it&#39;s info from config&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clobbered</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_profile_and_region</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">terminate</span><span class="p">(</span><span class="n">reason</span><span class="o">=</span><span class="s1">&#39;Cloudknot job killed after calling &#39;</span>
                              <span class="s1">&#39;BatchJob.clobber()&#39;</span><span class="p">)</span>

        <span class="c1"># Set the clobbered parameter to True,</span>
        <span class="c1"># preventing subsequent method calls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clobbered</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Remove this job from the list of jobs in the config file</span>
        <span class="n">cloudknot</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">remove_resource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_section_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    
    <div class="footer">
      &copy;2017, Adam Richie-Halford, Ariel Rokem.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
    <script type="text/javascript">
        $(document).ready(function() {
            $(".toggle > *").hide();
            $(".toggle .header").show();
            $(".toggle .header").click(function() {
                $(this).parent().children().not(".header").toggle(400);
                $(this).parent().children(".header").toggleClass("open");
            })
        });
    </script>

  </body>
</html>