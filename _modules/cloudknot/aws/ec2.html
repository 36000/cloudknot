
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>cloudknot.aws.ec2 &#8212; cloudknot 0.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/collapsible.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">cloudknot</a></h1>



<p class="blurb">Run your existing python code on AWS Batch</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=richford&repo=cloudknot&type=star&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation.html">documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq.html">faq</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/richford/cloudknot/tree/master/examples">examples</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/richford/cloudknot">code</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/richford/cloudknot/issues">bugs</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for cloudknot.aws.ec2</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">botocore</span>
<span class="kn">import</span> <span class="nn">cloudknot.config</span>
<span class="kn">import</span> <span class="nn">ipaddress</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">tenacity</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">namedtuple</span>

<span class="kn">from</span> <span class="nn">.base_classes</span> <span class="k">import</span> <span class="n">clients</span><span class="p">,</span> <span class="n">NamedObject</span><span class="p">,</span> \
    <span class="n">ResourceExistsException</span><span class="p">,</span> <span class="n">ResourceDoesNotExistException</span><span class="p">,</span> \
    <span class="n">CannotCreateResourceException</span><span class="p">,</span> <span class="n">CannotDeleteResourceException</span><span class="p">,</span> \
    <span class="n">CloudknotInputError</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Vpc&quot;</span><span class="p">,</span> <span class="s2">&quot;SecurityGroup&quot;</span><span class="p">]</span>

<span class="n">mod_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># noinspection PyPropertyAccess,PyAttributeOutsideInit</span>
<div class="viewcode-block" id="Vpc"><a class="viewcode-back" href="../../../api/_autosummary/cloudknot.aws.Vpc.html#cloudknot.aws.Vpc">[docs]</a><span class="k">class</span> <span class="nc">Vpc</span><span class="p">(</span><span class="n">NamedObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class for defining an Amazon Virtual Private Cloud (VPC)&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vpc_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_default_vpc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">ipv4_cidr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">instance_tenancy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize a Vpc instance</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vpc_id : string</span>
<span class="sd">            VPC-ID for the VPC to be retrieved</span>

<span class="sd">        name : string</span>
<span class="sd">            Name of the VPC to be retrieved or created</span>

<span class="sd">        use_default_vpc : bool</span>
<span class="sd">            if True, create or retrieve the default VPC</span>
<span class="sd">            if False, use other input args to create a non-default VPC</span>

<span class="sd">        ipv4_cidr : string</span>
<span class="sd">            IPv4 CIDR block to be used for creation of a new VPC</span>

<span class="sd">        instance_tenancy : string</span>
<span class="sd">            Instance tenancy for this VPC, one of [&#39;default&#39;, &#39;dedicated&#39;]</span>
<span class="sd">            Default: &#39;default&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># User must supply vpc_id or name, or specify use_default_vpc</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">vpc_id</span> <span class="ow">or</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">use_default_vpc</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span><span class="s1">&#39;name or vpc_id is required.&#39;</span><span class="p">)</span>

        <span class="c1"># If user supplies vpc_id, then no other input is allowed</span>
        <span class="k">if</span> <span class="n">vpc_id</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">([</span><span class="n">name</span><span class="p">,</span> <span class="n">ipv4_cidr</span><span class="p">,</span> <span class="n">instance_tenancy</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span>
                <span class="s1">&#39;You must specify either a VPC id for an existing VPC or &#39;</span>
                <span class="s1">&#39;input parameters for a new VPC. You cannot do both.&#39;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">use_default_vpc</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">([</span>
            <span class="n">vpc_id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ipv4_cidr</span><span class="p">,</span> <span class="n">instance_tenancy</span>
        <span class="p">]):</span>
            <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span><span class="s1">&#39;You may not specify any other input if&#39;</span>
                                      <span class="s1">&#39;requesting the default VPC&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">use_default_vpc</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create_default_vpc</span><span class="p">()</span>
                <span class="n">vpc_id</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Vpc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;VpcId&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">error_code</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Error&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Code&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">error_code</span> <span class="o">==</span> <span class="s1">&#39;DefaultVpcAlreadyExists&#39;</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe_vpcs</span><span class="p">(</span><span class="n">Filters</span><span class="o">=</span><span class="p">[{</span>
                        <span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="s1">&#39;isDefault&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Values&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;true&#39;</span><span class="p">]</span>
                    <span class="p">}])</span>
                    <span class="n">vpc_id</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Vpcs&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;VpcId&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">error_code</span> <span class="o">==</span> <span class="s1">&#39;UnauthorizedOperation&#39;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">CannotCreateResourceException</span><span class="p">(</span>
                        <span class="s1">&#39;Cannot create a default VPC because this is an &#39;</span>
                        <span class="s1">&#39;unauthorized operation. You may not have the proper &#39;</span>
                        <span class="s1">&#39;permissions to create a default VPC.&#39;</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">error_code</span> <span class="o">==</span> <span class="s1">&#39;OperationNotPermitted&#39;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">CannotCreateResourceException</span><span class="p">(</span>
                        <span class="s1">&#39;Cannot create a default VPC because this is an &#39;</span>
                        <span class="s1">&#39;unauthorized operation. You might have resources in &#39;</span>
                        <span class="s1">&#39;EC2-Classic in the current region.&#39;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>

        <span class="c1"># Check for pre-existence based on vpc_id or name</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exists_already</span><span class="p">(</span><span class="n">vpc_id</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pre_existing</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">exists</span>

        <span class="k">if</span> <span class="n">resource</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
            <span class="c1"># If resource exists and user supplied an ipv4, abort</span>
            <span class="k">if</span> <span class="n">ipv4_cidr</span> <span class="ow">or</span> <span class="n">instance_tenancy</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ResourceExistsException</span><span class="p">(</span>
                    <span class="s1">&#39;The specified ipv4 CIDR block is already in use by &#39;</span>
                    <span class="s1">&#39;vpc </span><span class="si">{id:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">resource</span><span class="o">.</span><span class="n">vpc_id</span><span class="p">),</span>
                    <span class="n">resource_id</span><span class="o">=</span><span class="n">resource</span><span class="o">.</span><span class="n">vpc_id</span>
                <span class="p">)</span>

            <span class="nb">super</span><span class="p">(</span><span class="n">Vpc</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">resource</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_vpc_id</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">vpc_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ipv4_cidr</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">ipv4_cidr</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_instance_tenancy</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">instance_tenancy</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_subnet_ids</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">subnet_ids</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_default</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">is_default</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_section_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_section_name</span><span class="p">(</span><span class="s1">&#39;vpc&#39;</span><span class="p">)</span>
            <span class="n">cloudknot</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_section_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vpc_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_id</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">internet_gateway_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_network_acl_ids</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">net_acl_ids</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_route_table_ids</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">route_table_ids</span>

            <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Retrieved pre-existing VPC </span><span class="si">{id:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vpc_id</span>
            <span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vpc_id</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ResourceDoesNotExistException</span><span class="p">(</span>
                    <span class="s1">&#39;You specified a vpc_id that does not exist.&#39;</span><span class="p">,</span>
                    <span class="n">vpc_id</span>
                <span class="p">)</span>

            <span class="nb">super</span><span class="p">(</span><span class="n">Vpc</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

            <span class="c1"># Check that ipv4 is a valid network range or set the default value</span>
            <span class="k">if</span> <span class="n">ipv4_cidr</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ipv4_cidr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ipaddress</span><span class="o">.</span><span class="n">IPv4Network</span><span class="p">(</span>
                        <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">ipv4_cidr</span><span class="p">)</span>
                    <span class="p">))</span>
                <span class="k">except</span> <span class="p">(</span><span class="n">ipaddress</span><span class="o">.</span><span class="n">AddressValueError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span>
                        <span class="s1">&#39;If provided, ipv4_cidr must be a valid IPv4 network &#39;</span>
                        <span class="s1">&#39;range.&#39;</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ipv4_cidr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ipaddress</span><span class="o">.</span><span class="n">IPv4Network</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;172.31.0.0/16&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">instance_tenancy</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">instance_tenancy</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;dedicated&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_instance_tenancy</span> <span class="o">=</span> <span class="n">instance_tenancy</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span>
                        <span class="s1">&#39;If provided, instance tenancy must be &#39;</span>
                        <span class="s1">&#39;one of (&quot;default&quot;, &quot;dedicated&quot;).&#39;</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_instance_tenancy</span> <span class="o">=</span> <span class="s1">&#39;default&#39;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_vpc_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_subnet_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_subnets</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_default</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Declare read-only properties</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pre_existing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Boolean flag to indicate whether this resource was pre-existing</span>

<span class="sd">        True if resource was retrieved from AWS,</span>
<span class="sd">        False if it was created on __init__.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_existing</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if this is the default VPC, False otherwise&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_default</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ipv4_cidr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;IPv4 CIDR block assigned to this VPC&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ipv4_cidr</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">instance_tenancy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Instance tenancy for this VPC, one of [&#39;default&#39;, &#39;dedicated&#39;]&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instance_tenancy</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vpc_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The ID for this Amazon virtual private cloud&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vpc_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">subnet_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of subnet IDs for this subnets in this VPC&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subnet_ids</span>

    <span class="k">def</span> <span class="nf">_exists_already</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vpc_id</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if an AWS VPC exists already</span>

<span class="sd">        If VPC exists, return namedtuple with VPC info. Otherwise, set the</span>
<span class="sd">        namedtuple&#39;s `exists` field to `False`. The remaining fields default</span>
<span class="sd">        to `None`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        namedtuple RoleExists</span>
<span class="sd">            A namedtuple with fields [&#39;exists&#39;, &#39;name&#39;, &#39;ipv4_cidr&#39;,</span>
<span class="sd">            &#39;instance_tenancy&#39;, &#39;vpc_id&#39;, &#39;subnet_ids&#39;, &#39;is_default&#39;,</span>
<span class="sd">            &#39;internet_gateway_id&#39;, &#39;net_acl_ids&#39;, &#39;route_table_ids&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># define a namedtuple for return value type</span>
        <span class="n">ResourceExists</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
            <span class="s1">&#39;ResourceExists&#39;</span><span class="p">,</span>
            <span class="p">[</span><span class="s1">&#39;exists&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;ipv4_cidr&#39;</span><span class="p">,</span> <span class="s1">&#39;instance_tenancy&#39;</span><span class="p">,</span>
             <span class="s1">&#39;vpc_id&#39;</span><span class="p">,</span> <span class="s1">&#39;subnet_ids&#39;</span><span class="p">,</span> <span class="s1">&#39;is_default&#39;</span><span class="p">,</span> <span class="s1">&#39;internet_gateway_id&#39;</span><span class="p">,</span>
             <span class="s1">&#39;net_acl_ids&#39;</span><span class="p">,</span> <span class="s1">&#39;route_table_ids&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># make all but the first value default to None</span>
        <span class="n">ResourceExists</span><span class="o">.</span><span class="fm">__new__</span><span class="o">.</span><span class="vm">__defaults__</span> <span class="o">=</span> \
            <span class="p">(</span><span class="kc">None</span><span class="p">,)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ResourceExists</span><span class="o">.</span><span class="n">_fields</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">vpc_id</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># If user supplied vpc_id, check that</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe_vpcs</span><span class="p">(</span><span class="n">VpcIds</span><span class="o">=</span><span class="p">[</span><span class="n">vpc_id</span><span class="p">])</span>

                <span class="c1"># Save vpcs for outside the if/else block</span>
                <span class="n">vpcs</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Vpcs&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">error_code</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;Error&#39;</span><span class="p">][</span><span class="s1">&#39;Code&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">error_code</span> <span class="o">==</span> <span class="s1">&#39;InvalidVpcID.NotFound&#39;</span><span class="p">:</span>
                    <span class="c1"># VPC doesn&#39;t exist</span>
                    <span class="c1"># Save vpcs for outside the if/else block</span>
                    <span class="n">vpcs</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: nocover</span>
                    <span class="c1"># I can&#39;t think of a test case for this</span>
                    <span class="c1"># But we should pass through any unexpected errors</span>
                    <span class="k">raise</span> <span class="n">e</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Else check for the tag &quot;Name: name&quot;</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe_tags</span><span class="p">(</span>
                <span class="n">Filters</span><span class="o">=</span><span class="p">[</span>
                    <span class="p">{</span><span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="s1">&#39;resource-type&#39;</span><span class="p">,</span> <span class="s1">&#39;Values&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;vpc&#39;</span><span class="p">]},</span>
                    <span class="p">{</span><span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;Values&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]},</span>
                    <span class="p">{</span><span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;Values&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">name</span><span class="p">]}</span>
                <span class="p">]</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Tags&#39;</span><span class="p">):</span>
                <span class="n">vpc_id</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Tags&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ResourceId&#39;</span><span class="p">]</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe_vpcs</span><span class="p">(</span><span class="n">VpcIds</span><span class="o">=</span><span class="p">[</span><span class="n">vpc_id</span><span class="p">])</span>
                <span class="n">vpcs</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Vpcs&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vpcs</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">vpcs</span><span class="p">:</span>
            <span class="n">vpc</span> <span class="o">=</span> <span class="n">vpcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="n">vpc</span><span class="p">[</span><span class="s1">&#39;Tags&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">ipv4_cidr</span> <span class="o">=</span> <span class="n">vpc</span><span class="p">[</span><span class="s1">&#39;CidrBlock&#39;</span><span class="p">]</span>
            <span class="n">vpc_id</span> <span class="o">=</span> <span class="n">vpc</span><span class="p">[</span><span class="s1">&#39;VpcId&#39;</span><span class="p">]</span>
            <span class="n">instance_tenancy</span> <span class="o">=</span> <span class="n">vpc</span><span class="p">[</span><span class="s1">&#39;InstanceTenancy&#39;</span><span class="p">]</span>
            <span class="n">is_default</span> <span class="o">=</span> <span class="n">vpc</span><span class="p">[</span><span class="s1">&#39;IsDefault&#39;</span><span class="p">]</span>

            <span class="c1"># Find the name tag</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">name_tag</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;Key&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="n">tags</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">name_tag</span><span class="p">[</span><span class="s1">&#39;Value&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;cloudknot-acquired-pre-existing-vpc&#39;</span>

                <span class="n">retry</span> <span class="o">=</span> <span class="n">tenacity</span><span class="o">.</span><span class="n">Retrying</span><span class="p">(</span>
                    <span class="n">wait</span><span class="o">=</span><span class="n">tenacity</span><span class="o">.</span><span class="n">wait_exponential</span><span class="p">(</span><span class="nb">max</span><span class="o">=</span><span class="mi">16</span><span class="p">),</span>
                    <span class="n">stop</span><span class="o">=</span><span class="n">tenacity</span><span class="o">.</span><span class="n">stop_after_delay</span><span class="p">(</span><span class="mi">120</span><span class="p">),</span>
                    <span class="n">retry</span><span class="o">=</span><span class="n">tenacity</span><span class="o">.</span><span class="n">retry_if_exception_type</span><span class="p">(</span>
                        <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span>
                    <span class="p">)</span>
                <span class="p">)</span>

                <span class="n">retry</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
                    <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create_tags</span><span class="p">,</span>
                    <span class="n">Resources</span><span class="o">=</span><span class="p">[</span><span class="n">vpc_id</span><span class="p">],</span>
                    <span class="n">Tags</span><span class="o">=</span><span class="p">[</span>
                        <span class="p">{</span><span class="s1">&#39;Key&#39;</span><span class="p">:</span> <span class="s1">&#39;owner&#39;</span><span class="p">,</span> <span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="s1">&#39;cloudknot&#39;</span><span class="p">},</span>
                        <span class="p">{</span><span class="s1">&#39;Key&#39;</span><span class="p">:</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">}</span>
                    <span class="p">]</span>
                <span class="p">)</span>

            <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe_subnets</span><span class="p">(</span><span class="n">Filters</span><span class="o">=</span><span class="p">[{</span>
                <span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="s1">&#39;vpc-id&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Values&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">vpc_id</span><span class="p">]</span>
            <span class="p">}])</span>

            <span class="n">subnet_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;SubnetId&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Subnets&#39;</span><span class="p">)]</span>

            <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe_internet_gateways</span><span class="p">(</span><span class="n">Filters</span><span class="o">=</span><span class="p">[{</span>
                <span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="s1">&#39;attachment.vpc-id&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Values&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">vpc_id</span><span class="p">]</span>
            <span class="p">}])</span>

            <span class="n">gateways</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;InternetGateways&#39;</span><span class="p">)</span>
            <span class="n">internet_gateway_id</span> <span class="o">=</span> <span class="n">gateways</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;InternetGatewayId&#39;</span><span class="p">)</span> \
                <span class="k">if</span> <span class="n">gateways</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe_network_acls</span><span class="p">(</span><span class="n">Filters</span><span class="o">=</span><span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="s1">&#39;vpc-id&#39;</span><span class="p">,</span> <span class="s1">&#39;Values&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">vpc_id</span><span class="p">]},</span>
                <span class="p">{</span><span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;Values&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;false&#39;</span><span class="p">]}</span>
            <span class="p">])</span>

            <span class="n">net_acl_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="p">[</span><span class="s1">&#39;NetworkAclId&#39;</span><span class="p">]</span>
                           <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;NetworkAcls&#39;</span><span class="p">)]</span>

            <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe_route_tables</span><span class="p">(</span><span class="n">Filters</span><span class="o">=</span><span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="s1">&#39;vpc-id&#39;</span><span class="p">,</span> <span class="s1">&#39;Values&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">vpc_id</span><span class="p">]},</span>
                <span class="p">{</span><span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="s1">&#39;association.main&#39;</span><span class="p">,</span> <span class="s1">&#39;Values&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;false&#39;</span><span class="p">]}</span>
            <span class="p">])</span>

            <span class="n">route_table_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">rt</span><span class="p">[</span><span class="s1">&#39;RouteTableId&#39;</span><span class="p">]</span>
                               <span class="k">for</span> <span class="n">rt</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;RouteTables&#39;</span><span class="p">)]</span>

            <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;VPC </span><span class="si">{vpcid:s}</span><span class="s1"> already exists.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vpcid</span><span class="o">=</span><span class="n">vpc_id</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="n">ResourceExists</span><span class="p">(</span>
                <span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">ipv4_cidr</span><span class="o">=</span><span class="n">ipv4_cidr</span><span class="p">,</span>
                <span class="n">instance_tenancy</span><span class="o">=</span><span class="n">instance_tenancy</span><span class="p">,</span> <span class="n">vpc_id</span><span class="o">=</span><span class="n">vpc_id</span><span class="p">,</span>
                <span class="n">subnet_ids</span><span class="o">=</span><span class="n">subnet_ids</span><span class="p">,</span> <span class="n">is_default</span><span class="o">=</span><span class="n">is_default</span><span class="p">,</span>
                <span class="n">internet_gateway_id</span><span class="o">=</span><span class="n">internet_gateway_id</span><span class="p">,</span>
                <span class="n">net_acl_ids</span><span class="o">=</span><span class="n">net_acl_ids</span><span class="p">,</span> <span class="n">route_table_ids</span><span class="o">=</span><span class="n">route_table_ids</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ResourceExists</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create AWS virtual private cloud (VPC) using instance parameters</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        string</span>
<span class="sd">            VPC-ID for the created VPC</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create_vpc</span><span class="p">(</span>
            <span class="n">CidrBlock</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ipv4_cidr</span><span class="p">,</span>
            <span class="n">InstanceTenancy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance_tenancy</span>
        <span class="p">)</span>

        <span class="n">vpc_id</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Vpc&#39;</span><span class="p">)[</span><span class="s1">&#39;VpcId&#39;</span><span class="p">]</span>

        <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Created VPC </span><span class="si">{vpcid:s}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vpcid</span><span class="o">=</span><span class="n">vpc_id</span><span class="p">))</span>

        <span class="c1"># Wait for VPC to exist and be available</span>
        <span class="n">wait_for_vpc</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_waiter</span><span class="p">(</span><span class="s1">&#39;vpc_exists&#39;</span><span class="p">)</span>
        <span class="n">wait_for_vpc</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">VpcIds</span><span class="o">=</span><span class="p">[</span><span class="n">vpc_id</span><span class="p">])</span>
        <span class="n">wait_for_vpc</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_waiter</span><span class="p">(</span><span class="s1">&#39;vpc_available&#39;</span><span class="p">)</span>
        <span class="n">wait_for_vpc</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">VpcIds</span><span class="o">=</span><span class="p">[</span><span class="n">vpc_id</span><span class="p">])</span>

        <span class="n">retry</span> <span class="o">=</span> <span class="n">tenacity</span><span class="o">.</span><span class="n">Retrying</span><span class="p">(</span>
            <span class="n">wait</span><span class="o">=</span><span class="n">tenacity</span><span class="o">.</span><span class="n">wait_exponential</span><span class="p">(</span><span class="nb">max</span><span class="o">=</span><span class="mi">16</span><span class="p">),</span>
            <span class="n">stop</span><span class="o">=</span><span class="n">tenacity</span><span class="o">.</span><span class="n">stop_after_delay</span><span class="p">(</span><span class="mi">120</span><span class="p">),</span>
            <span class="n">retry</span><span class="o">=</span><span class="n">tenacity</span><span class="o">.</span><span class="n">retry_if_exception_type</span><span class="p">(</span>
                <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Tag the VPC with name and owner</span>
        <span class="n">retry</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create_tags</span><span class="p">,</span>
            <span class="n">Resources</span><span class="o">=</span><span class="p">[</span><span class="n">vpc_id</span><span class="p">],</span>
            <span class="n">Tags</span><span class="o">=</span><span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;Key&#39;</span><span class="p">:</span> <span class="s1">&#39;owner&#39;</span><span class="p">,</span> <span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="s1">&#39;cloudknot&#39;</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;Key&#39;</span><span class="p">:</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">}</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Create and attach an internet gateway to this VPC</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create_internet_gateway</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_id</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;InternetGateway&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;InternetGatewayId&#39;</span>
        <span class="p">)</span>

        <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attach_internet_gateway</span><span class="p">(</span>
            <span class="n">InternetGatewayId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_gateway_id</span><span class="p">,</span>
            <span class="n">VpcId</span><span class="o">=</span><span class="n">vpc_id</span>
        <span class="p">)</span>

        <span class="c1"># Create a route table and add a route for all internet traffic</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create_route_table</span><span class="p">(</span><span class="n">VpcId</span><span class="o">=</span><span class="n">vpc_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_route_table_ids</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;RouteTable&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;RouteTableId&#39;</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create_route</span><span class="p">(</span>
            <span class="n">DestinationCidrBlock</span><span class="o">=</span><span class="s1">&#39;0.0.0.0/0&#39;</span><span class="p">,</span>
            <span class="n">GatewayId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_gateway_id</span><span class="p">,</span>
            <span class="n">RouteTableId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_route_table_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># Create a network access control list for this VPC</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create_network_acl</span><span class="p">(</span><span class="n">VpcId</span><span class="o">=</span><span class="n">vpc_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_network_acl_ids</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;NetworkAcl&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;NetworkAclId&#39;</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># Add this VPC to the list of VPCs in the config file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_section_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_section_name</span><span class="p">(</span><span class="s1">&#39;vpc&#39;</span><span class="p">)</span>
        <span class="n">cloudknot</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_section_name</span><span class="p">,</span> <span class="n">vpc_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">vpc_id</span>

    <span class="k">def</span> <span class="nf">_add_subnets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add one subnet to this VPC for each availability zone&quot;&quot;&quot;</span>
        <span class="c1"># Add a subnet for each availability zone</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe_availability_zones</span><span class="p">()</span>
        <span class="n">zones</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;AvailabilityZones&#39;</span><span class="p">)</span>

        <span class="c1"># Get an IPv4Network instance representing the VPC CIDR block</span>
        <span class="n">cidr</span> <span class="o">=</span> <span class="n">ipaddress</span><span class="o">.</span><span class="n">IPv4Network</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ipv4_cidr</span><span class="p">))</span>

        <span class="c1"># Get list of subnet CIDR blocks truncating list to len(zones)</span>
        <span class="n">subnet_ipv4_cidrs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cidr</span><span class="o">.</span><span class="n">subnets</span><span class="p">(</span><span class="n">new_prefix</span><span class="o">=</span><span class="mi">20</span><span class="p">))</span>

        <span class="c1"># Ensure that the CIDR block has enough addresses to cover each zone</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subnet_ipv4_cidrs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">zones</span><span class="p">):</span>  <span class="c1"># pragma: nocover</span>
            <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span><span class="s1">&#39;IPv4 CIDR block does not have enough &#39;</span>
                                      <span class="s1">&#39;addresses for each availability zone&#39;</span><span class="p">)</span>

        <span class="n">subnet_ipv4_cidrs</span> <span class="o">=</span> <span class="n">subnet_ipv4_cidrs</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">zones</span><span class="p">)]</span>

        <span class="n">subnet_ids</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">zone</span><span class="p">,</span> <span class="n">subnet_cidr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">zones</span><span class="p">,</span> <span class="n">subnet_ipv4_cidrs</span><span class="p">):</span>
            <span class="c1"># Create a subnet for each zone</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create_subnet</span><span class="p">(</span>
                <span class="n">AvailabilityZone</span><span class="o">=</span><span class="n">zone</span><span class="p">[</span><span class="s1">&#39;ZoneName&#39;</span><span class="p">],</span>
                <span class="n">CidrBlock</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">subnet_cidr</span><span class="p">),</span>
                <span class="n">VpcId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vpc_id</span>
            <span class="p">)</span>

            <span class="n">subnet_id</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Subnet&#39;</span><span class="p">)[</span><span class="s1">&#39;SubnetId&#39;</span><span class="p">]</span>
            <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">modify_subnet_attribute</span><span class="p">(</span>
                <span class="n">MapPublicIpOnLaunch</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
                <span class="n">SubnetId</span><span class="o">=</span><span class="n">subnet_id</span>
            <span class="p">)</span>

            <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">associate_route_table</span><span class="p">(</span>
                <span class="n">RouteTableId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_route_table_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">SubnetId</span><span class="o">=</span><span class="n">subnet_id</span>
            <span class="p">)</span>

            <span class="n">subnet_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subnet_id</span><span class="p">)</span>

            <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Created subnet </span><span class="si">{id:s}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">subnet_id</span><span class="p">))</span>

        <span class="c1"># Tag all subnets with name and owner</span>
        <span class="n">wait_for_subnet</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_waiter</span><span class="p">(</span><span class="s1">&#39;subnet_available&#39;</span><span class="p">)</span>
        <span class="n">retry</span> <span class="o">=</span> <span class="n">tenacity</span><span class="o">.</span><span class="n">Retrying</span><span class="p">(</span>
            <span class="n">wait</span><span class="o">=</span><span class="n">tenacity</span><span class="o">.</span><span class="n">wait_exponential</span><span class="p">(</span><span class="nb">max</span><span class="o">=</span><span class="mi">16</span><span class="p">),</span>
            <span class="n">stop</span><span class="o">=</span><span class="n">tenacity</span><span class="o">.</span><span class="n">stop_after_delay</span><span class="p">(</span><span class="mi">60</span><span class="p">),</span>
            <span class="n">retry</span><span class="o">=</span><span class="n">tenacity</span><span class="o">.</span><span class="n">retry_if_exception_type</span><span class="p">(</span>
                <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">WaiterError</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">retry</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">wait_for_subnet</span><span class="o">.</span><span class="n">wait</span><span class="p">,</span> <span class="n">SubnetIds</span><span class="o">=</span><span class="n">subnet_ids</span><span class="p">)</span>

        <span class="n">retry</span> <span class="o">=</span> <span class="n">tenacity</span><span class="o">.</span><span class="n">Retrying</span><span class="p">(</span>
            <span class="n">wait</span><span class="o">=</span><span class="n">tenacity</span><span class="o">.</span><span class="n">wait_exponential</span><span class="p">(</span><span class="nb">max</span><span class="o">=</span><span class="mi">16</span><span class="p">),</span>
            <span class="n">stop</span><span class="o">=</span><span class="n">tenacity</span><span class="o">.</span><span class="n">stop_after_delay</span><span class="p">(</span><span class="mi">120</span><span class="p">),</span>
            <span class="n">retry</span><span class="o">=</span><span class="n">tenacity</span><span class="o">.</span><span class="n">retry_if_exception_type</span><span class="p">(</span>
                <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">retry</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create_tags</span><span class="p">,</span>
            <span class="n">Resources</span><span class="o">=</span><span class="n">subnet_ids</span><span class="p">,</span>
            <span class="n">Tags</span><span class="o">=</span><span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;Key&#39;</span><span class="p">:</span> <span class="s1">&#39;owner&#39;</span><span class="p">,</span> <span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="s1">&#39;cloudknot&#39;</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;Key&#39;</span><span class="p">:</span> <span class="s1">&#39;vpc-name&#39;</span><span class="p">,</span> <span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">}</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">subnet_ids</span>

<div class="viewcode-block" id="Vpc.clobber"><a class="viewcode-back" href="../../../api/_autosummary/cloudknot.aws.Vpc.html#cloudknot.aws.Vpc.clobber">[docs]</a>    <span class="k">def</span> <span class="nf">clobber</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete this AWS virtual private cloud (VPC)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clobbered</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_profile_and_region</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Only try to delete non-default VPCs</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_default</span><span class="p">:</span>
                <span class="n">retry</span> <span class="o">=</span> <span class="n">tenacity</span><span class="o">.</span><span class="n">Retrying</span><span class="p">(</span>
                    <span class="n">wait</span><span class="o">=</span><span class="n">tenacity</span><span class="o">.</span><span class="n">wait_exponential</span><span class="p">(</span><span class="nb">max</span><span class="o">=</span><span class="mi">16</span><span class="p">),</span>
                    <span class="n">stop</span><span class="o">=</span><span class="n">tenacity</span><span class="o">.</span><span class="n">stop_after_delay</span><span class="p">(</span><span class="mi">60</span><span class="p">),</span>
                    <span class="n">retry</span><span class="o">=</span><span class="n">tenacity</span><span class="o">.</span><span class="n">retry_if_exception_type</span><span class="p">(</span>
                        <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span>
                    <span class="p">)</span>
                <span class="p">)</span>

                <span class="c1"># Delete the subnets</span>
                <span class="k">for</span> <span class="n">subnet_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subnet_ids</span><span class="p">:</span>
                    <span class="n">retry</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">delete_subnet</span><span class="p">,</span>
                               <span class="n">SubnetId</span><span class="o">=</span><span class="n">subnet_id</span><span class="p">)</span>
                    <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Deleted subnet </span><span class="si">{id:s}</span><span class="s1">&#39;</span>
                                    <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">subnet_id</span><span class="p">))</span>

                <span class="c1"># Delete the network ACL</span>
                <span class="k">for</span> <span class="n">net_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_network_acl_ids</span><span class="p">:</span>
                    <span class="n">retry</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">delete_network_acl</span><span class="p">,</span>
                               <span class="n">NetworkAclId</span><span class="o">=</span><span class="n">net_id</span><span class="p">)</span>

                <span class="c1"># Delete the route table</span>
                <span class="k">for</span> <span class="n">rt_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_route_table_ids</span><span class="p">:</span>
                    <span class="n">retry</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">delete_route_table</span><span class="p">,</span>
                               <span class="n">RouteTableId</span><span class="o">=</span><span class="n">rt_id</span><span class="p">)</span>

                <span class="c1"># Detach and delete the internet gateway</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gateway_id</span><span class="p">:</span>
                    <span class="n">retry</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">detach_internet_gateway</span><span class="p">,</span>
                               <span class="n">InternetGatewayId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_gateway_id</span><span class="p">,</span>
                               <span class="n">VpcId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vpc_id</span><span class="p">)</span>
                    <span class="n">retry</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">delete_internet_gateway</span><span class="p">,</span>
                               <span class="n">InternetGatewayId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_gateway_id</span><span class="p">)</span>

                <span class="c1"># Delete the VPC</span>
                <span class="n">retry</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">delete_vpc</span><span class="p">,</span> <span class="n">VpcId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vpc_id</span><span class="p">)</span>

            <span class="c1"># Remove this VPC from the list of VPCs in the config file</span>
            <span class="n">cloudknot</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">remove_resource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_section_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vpc_id</span><span class="p">)</span>

            <span class="c1"># Set the clobbered parameter to True,</span>
            <span class="c1"># preventing subsequent method calls</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_clobbered</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Deleted VPC </span><span class="si">{name:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Check for dependency violation and pass exception to user</span>
            <span class="n">error_code</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;Error&#39;</span><span class="p">][</span><span class="s1">&#39;Code&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">error_code</span> <span class="o">==</span> <span class="s1">&#39;DependencyViolation&#39;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe_security_groups</span><span class="p">(</span>
                    <span class="n">Filters</span><span class="o">=</span><span class="p">[{</span>
                        <span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="s1">&#39;vpc-id&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Values&#39;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vpc_id</span><span class="p">]</span>
                    <span class="p">}]</span>
                <span class="p">)</span>

                <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">sg</span><span class="p">[</span><span class="s1">&#39;GroupId&#39;</span><span class="p">]</span>
                       <span class="k">for</span> <span class="n">sg</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SecurityGroups&#39;</span><span class="p">)]</span>

                <span class="k">raise</span> <span class="n">CannotDeleteResourceException</span><span class="p">(</span>
                    <span class="s1">&#39;Could not delete this VPC because it has &#39;</span>
                    <span class="s1">&#39;dependencies. It may have security groups associated &#39;</span>
                    <span class="s1">&#39;with it. If you still want to delete this VPC, you &#39;</span>
                    <span class="s1">&#39;should first delete the security groups with the &#39;</span>
                    <span class="s1">&#39;following IDs </span><span class="si">{sg_ids!s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sg_ids</span><span class="o">=</span><span class="n">ids</span><span class="p">),</span>
                    <span class="n">resource_id</span><span class="o">=</span><span class="n">ids</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: nocover</span>
                <span class="c1"># I can&#39;t think of a test case to make this happen</span>
                <span class="k">raise</span> <span class="n">e</span>
        <span class="k">except</span> <span class="n">tenacity</span><span class="o">.</span><span class="n">RetryError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">error</span><span class="o">.</span><span class="n">reraise</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Check for dependency violation and pass exception to user</span>
                <span class="n">error_code</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;Error&#39;</span><span class="p">][</span><span class="s1">&#39;Code&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">error_code</span> <span class="o">==</span> <span class="s1">&#39;DependencyViolation&#39;</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe_security_groups</span><span class="p">(</span>
                        <span class="n">Filters</span><span class="o">=</span><span class="p">[{</span>
                            <span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="s1">&#39;vpc-id&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;Values&#39;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vpc_id</span><span class="p">]</span>
                        <span class="p">}]</span>
                    <span class="p">)</span>

                    <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">sg</span><span class="p">[</span><span class="s1">&#39;GroupId&#39;</span><span class="p">]</span>
                           <span class="k">for</span> <span class="n">sg</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SecurityGroups&#39;</span><span class="p">)]</span>

                    <span class="k">raise</span> <span class="n">CannotDeleteResourceException</span><span class="p">(</span>
                        <span class="s1">&#39;Could not delete this VPC because it has &#39;</span>
                        <span class="s1">&#39;dependencies. It may have security groups associated &#39;</span>
                        <span class="s1">&#39;with it. If you still want to delete this VPC, you &#39;</span>
                        <span class="s1">&#39;should first delete the security groups with the &#39;</span>
                        <span class="s1">&#39;following IDs </span><span class="si">{sg_ids!s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sg_ids</span><span class="o">=</span><span class="n">ids</span><span class="p">),</span>
                        <span class="n">resource_id</span><span class="o">=</span><span class="n">ids</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: nocover</span>
                    <span class="c1"># I can&#39;t think of a test case to make this happen</span>
                    <span class="k">raise</span> <span class="n">e</span></div></div>


<span class="c1"># noinspection PyPropertyAccess,PyAttributeOutsideInit</span>
<div class="viewcode-block" id="SecurityGroup"><a class="viewcode-back" href="../../../api/_autosummary/cloudknot.aws.SecurityGroup.html#cloudknot.aws.SecurityGroup">[docs]</a><span class="k">class</span> <span class="nc">SecurityGroup</span><span class="p">(</span><span class="n">NamedObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class for defining an AWS Security Group&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">security_group_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vpc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">description</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize an AWS Security Group.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        security_group_id : string</span>
<span class="sd">            ID of the security group to be retrieved</span>

<span class="sd">        name : string</span>
<span class="sd">            Name of the security group to be created</span>

<span class="sd">        vpc : Vpc</span>
<span class="sd">            Amazon virtual private cloud in which to establish this</span>
<span class="sd">            security group</span>

<span class="sd">        description : string</span>
<span class="sd">            description of this security group</span>
<span class="sd">            if description == None (default), then description is set to</span>
<span class="sd">            &quot;This security group was generated by cloudknot&quot;</span>
<span class="sd">            Default: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># User must specify either an ID or a name and VPC</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">security_group_id</span> <span class="ow">or</span> <span class="p">(</span><span class="n">name</span> <span class="ow">and</span> <span class="n">vpc</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span>
                <span class="s1">&#39;You must specify either a security group id for an existing &#39;</span>
                <span class="s1">&#39;security group or a name and VPC for a new security group.&#39;</span>
            <span class="p">)</span>

        <span class="c1"># Check that user didn&#39;t over-specify input</span>
        <span class="k">if</span> <span class="n">security_group_id</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">([</span><span class="n">name</span><span class="p">,</span> <span class="n">vpc</span><span class="p">,</span> <span class="n">description</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span>
                <span class="s1">&#39;You must specify either a security group id for an existing &#39;</span>
                <span class="s1">&#39;security group or input parameters for a new security group. &#39;</span>
                <span class="s1">&#39;You cannot do both.&#39;</span>
            <span class="p">)</span>

        <span class="c1"># Validate VPC input</span>
        <span class="k">if</span> <span class="n">vpc</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vpc</span><span class="p">,</span> <span class="n">Vpc</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CloudknotInputError</span><span class="p">(</span><span class="s1">&#39;If provided, vpc must be an &#39;</span>
                                      <span class="s1">&#39;instance of Vpc.&#39;</span><span class="p">)</span>

        <span class="n">vpc_id</span> <span class="o">=</span> <span class="n">vpc</span><span class="o">.</span><span class="n">vpc_id</span> <span class="k">if</span> <span class="n">vpc</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="n">resource</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exists_already</span><span class="p">(</span><span class="n">security_group_id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">vpc_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pre_existing</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">exists</span>

        <span class="k">if</span> <span class="n">resource</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">SecurityGroup</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">resource</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_vpc</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vpc_id</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">vpc_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_description</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">description</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_security_group_id</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">security_group_id</span>

            <span class="k">if</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">vpc</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ResourceExistsException</span><span class="p">(</span>
                    <span class="s1">&#39;The security group name </span><span class="si">{name:s}</span><span class="s1"> is already in use for &#39;</span>
                    <span class="s1">&#39;VPC </span><span class="si">{vpc_id:s}</span><span class="s1">. If you would like to retrieve this &#39;</span>
                    <span class="s1">&#39;security group, try SecurityGroup(security_group_id=&#39;</span>
                    <span class="s1">&#39;</span><span class="si">{sg_id:s}</span><span class="s1">).&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">vpc_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vpc_id</span><span class="p">,</span>
                        <span class="n">sg_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">security_group_id</span>
                    <span class="p">),</span>
                    <span class="n">resource_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">security_group_id</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_section_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_section_name</span><span class="p">(</span><span class="s1">&#39;security-groups&#39;</span><span class="p">)</span>
            <span class="n">cloudknot</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_section_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">security_group_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>

            <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Retrieved pre-existing security group </span><span class="si">{id:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">security_group_id</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">security_group_id</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ResourceDoesNotExistException</span><span class="p">(</span>
                    <span class="s1">&#39;The security group ID that you provided does not exist.&#39;</span><span class="p">,</span>
                    <span class="n">resource_id</span><span class="o">=</span><span class="n">security_group_id</span>
                <span class="p">)</span>

            <span class="nb">super</span><span class="p">(</span><span class="n">SecurityGroup</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_vpc</span> <span class="o">=</span> <span class="n">vpc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vpc_id</span> <span class="o">=</span> <span class="n">vpc</span><span class="o">.</span><span class="n">vpc_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_description</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">description</span><span class="p">)</span> <span class="k">if</span> <span class="n">description</span> <span class="k">else</span> \
                <span class="s1">&#39;This security group was automatically generated by cloudknot.&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_security_group_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create</span><span class="p">()</span>

    <span class="c1"># Declare read-only properties</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pre_existing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Boolean flag to indicate whether this resource was pre-existing</span>

<span class="sd">        True if resource was retrieved from AWS,</span>
<span class="sd">        False if it was created on __init__.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_existing</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vpc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Amazon virtual private cloud in which this security group resides&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vpc</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vpc_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;ID for the VPC in which this security group resides&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vpc_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The description for this security group&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">security_group_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The AWS ID for this security group&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_security_group_id</span>

    <span class="k">def</span> <span class="nf">_exists_already</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">security_group_id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">vpc_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if an AWS security group exists already</span>

<span class="sd">        If security group exists, return namedtuple with security group info.</span>
<span class="sd">        Otherwise, set the namedtuple&#39;s `exists` field to `False`. The</span>
<span class="sd">        remaining fields default to `None`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        namedtuple RoleExists</span>
<span class="sd">            A namedtuple with fields</span>
<span class="sd">            [&#39;exists&#39;, &#39;name&#39;, &#39;vpc_id&#39;, &#39;description&#39;, &#39;security_group_id&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># define a namedtuple for return value type</span>
        <span class="n">ResourceExists</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
            <span class="s1">&#39;ResourceExists&#39;</span><span class="p">,</span>
            <span class="p">[</span><span class="s1">&#39;exists&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;vpc_id&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;security_group_id&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># make all but the first value default to None</span>
        <span class="n">ResourceExists</span><span class="o">.</span><span class="fm">__new__</span><span class="o">.</span><span class="vm">__defaults__</span> <span class="o">=</span> \
            <span class="p">(</span><span class="kc">None</span><span class="p">,)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ResourceExists</span><span class="o">.</span><span class="n">_fields</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">security_group_id</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe_security_groups</span><span class="p">(</span>
                    <span class="n">GroupIds</span><span class="o">=</span><span class="p">[</span><span class="n">security_group_id</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># If the group_id doesn&#39;t exist or isn&#39;t formatted correctly,</span>
                <span class="c1"># return exists=False</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Error&#39;</span><span class="p">)[</span><span class="s1">&#39;Code&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="s1">&#39;InvalidGroup.NotFound&#39;</span><span class="p">,</span> <span class="s1">&#39;InvalidGroupId.Malformed&#39;</span>
                <span class="p">]:</span>
                    <span class="k">return</span> <span class="n">ResourceExists</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                    <span class="c1"># I could not think of a unit test case where the</span>
                    <span class="c1"># describe_security_groups request would yield a different</span>
                    <span class="c1"># error, but one should still pass through unhandled</span>
                    <span class="c1"># errors even if (especially if) one can&#39;t think of what</span>
                    <span class="c1"># they&#39;ll be.</span>
                    <span class="k">raise</span> <span class="n">e</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe_security_groups</span><span class="p">(</span>
                <span class="n">Filters</span><span class="o">=</span><span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="s1">&#39;group-name&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Values&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span>
                    <span class="p">},</span>
                    <span class="p">{</span>
                        <span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="s1">&#39;vpc-id&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Values&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">vpc_id</span><span class="p">]</span>
                    <span class="p">}</span>
                <span class="p">]</span>
            <span class="p">)</span>

        <span class="n">sg</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SecurityGroups&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sg</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">sg</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;GroupName&#39;</span><span class="p">]</span>
            <span class="n">vpc_id</span> <span class="o">=</span> <span class="n">sg</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;VpcId&#39;</span><span class="p">]</span>
            <span class="n">description</span> <span class="o">=</span> <span class="n">sg</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Description&#39;</span><span class="p">]</span>
            <span class="n">group_id</span> <span class="o">=</span> <span class="n">sg</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;GroupId&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">ResourceExists</span><span class="p">(</span>
                <span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">vpc_id</span><span class="o">=</span><span class="n">vpc_id</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
                <span class="n">security_group_id</span><span class="o">=</span><span class="n">group_id</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ResourceExists</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create AWS security group using instance parameters</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        string</span>
<span class="sd">            security group ID for the created security group</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create the security group</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create_security_group</span><span class="p">(</span>
            <span class="n">GroupName</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">Description</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
            <span class="n">VpcId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vpc</span><span class="o">.</span><span class="n">vpc_id</span>
        <span class="p">)</span>

        <span class="n">group_id</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;GroupId&#39;</span><span class="p">)</span>

        <span class="c1"># Add ingress rules to the security group</span>
        <span class="n">ipv4_ranges</span> <span class="o">=</span> <span class="p">[{</span>
            <span class="s1">&#39;CidrIp&#39;</span><span class="p">:</span> <span class="s1">&#39;0.0.0.0/0&#39;</span>
        <span class="p">}]</span>

        <span class="n">ipv6_ranges</span> <span class="o">=</span> <span class="p">[{</span>
            <span class="s1">&#39;CidrIpv6&#39;</span><span class="p">:</span> <span class="s1">&#39;::/0&#39;</span>
        <span class="p">}]</span>

        <span class="n">ip_permissions</span> <span class="o">=</span> <span class="p">[{</span>
            <span class="s1">&#39;IpProtocol&#39;</span><span class="p">:</span> <span class="s1">&#39;TCP&#39;</span><span class="p">,</span>
            <span class="s1">&#39;FromPort&#39;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
            <span class="s1">&#39;ToPort&#39;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
            <span class="s1">&#39;IpRanges&#39;</span><span class="p">:</span> <span class="n">ipv4_ranges</span><span class="p">,</span>
            <span class="s1">&#39;Ipv6Ranges&#39;</span><span class="p">:</span> <span class="n">ipv6_ranges</span>
        <span class="p">},</span> <span class="p">{</span>
            <span class="s1">&#39;IpProtocol&#39;</span><span class="p">:</span> <span class="s1">&#39;TCP&#39;</span><span class="p">,</span>
            <span class="s1">&#39;FromPort&#39;</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span>
            <span class="s1">&#39;ToPort&#39;</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span>
            <span class="s1">&#39;IpRanges&#39;</span><span class="p">:</span> <span class="n">ipv4_ranges</span><span class="p">,</span>
            <span class="s1">&#39;Ipv6Ranges&#39;</span><span class="p">:</span> <span class="n">ipv6_ranges</span>
        <span class="p">}]</span>

        <span class="n">retry</span> <span class="o">=</span> <span class="n">tenacity</span><span class="o">.</span><span class="n">Retrying</span><span class="p">(</span>
            <span class="n">wait</span><span class="o">=</span><span class="n">tenacity</span><span class="o">.</span><span class="n">wait_exponential</span><span class="p">(</span><span class="nb">max</span><span class="o">=</span><span class="mi">16</span><span class="p">),</span>
            <span class="n">stop</span><span class="o">=</span><span class="n">tenacity</span><span class="o">.</span><span class="n">stop_after_delay</span><span class="p">(</span><span class="mi">120</span><span class="p">),</span>
            <span class="n">retry</span><span class="o">=</span><span class="n">tenacity</span><span class="o">.</span><span class="n">retry_if_exception_type</span><span class="p">(</span>
                <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">retry</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">authorize_security_group_ingress</span><span class="p">,</span>
            <span class="n">GroupId</span><span class="o">=</span><span class="n">group_id</span><span class="p">,</span>
            <span class="n">IpPermissions</span><span class="o">=</span><span class="n">ip_permissions</span>
        <span class="p">)</span>

        <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Created security group </span><span class="si">{id:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">group_id</span><span class="p">))</span>

        <span class="c1"># Tag the security group with owner=cloudknot</span>
        <span class="n">retry</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create_tags</span><span class="p">,</span>
            <span class="n">Resources</span><span class="o">=</span><span class="p">[</span><span class="n">group_id</span><span class="p">],</span>
            <span class="n">Tags</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;Key&#39;</span><span class="p">:</span> <span class="s1">&#39;owner&#39;</span><span class="p">,</span> <span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="s1">&#39;cloudknot&#39;</span><span class="p">}]</span>
        <span class="p">)</span>

        <span class="c1"># Add this security group to the config file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_section_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_section_name</span><span class="p">(</span><span class="s1">&#39;security-groups&#39;</span><span class="p">)</span>
        <span class="n">cloudknot</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_section_name</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">group_id</span>

<div class="viewcode-block" id="SecurityGroup.clobber"><a class="viewcode-back" href="../../../api/_autosummary/cloudknot.aws.SecurityGroup.html#cloudknot.aws.SecurityGroup.clobber">[docs]</a>    <span class="k">def</span> <span class="nf">clobber</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete this AWS security group and associated resources&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clobbered</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_profile_and_region</span><span class="p">()</span>

        <span class="c1"># Get dependent EC2 instances</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe_instances</span><span class="p">(</span><span class="n">Filters</span><span class="o">=</span><span class="p">[{</span>
            <span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="s1">&#39;vpc-id&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Values&#39;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vpc_id</span><span class="p">]</span>
        <span class="p">}])</span>

        <span class="k">def</span> <span class="nf">has_security_group</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">sg_id</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">sg_id</span> <span class="ow">in</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;GroupId&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">instance</span><span class="p">[</span><span class="s1">&#39;SecurityGroups&#39;</span><span class="p">]]</span>

        <span class="n">deps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Reservations&#39;</span><span class="p">):</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="n">deps</span> <span class="o">+</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;InstanceId&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;Instances&#39;</span><span class="p">]</span>
                           <span class="k">if</span> <span class="n">has_security_group</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">security_group_id</span><span class="p">)]</span>

        <span class="c1"># Delete the dependent instances</span>
        <span class="k">if</span> <span class="n">deps</span><span class="p">:</span>
            <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">terminate_instances</span><span class="p">(</span><span class="n">InstanceIds</span><span class="o">=</span><span class="n">deps</span><span class="p">)</span>
            <span class="n">mod_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;Deleted dependent EC2 instances: </span><span class="si">{deps!s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">deps</span><span class="o">=</span><span class="n">deps</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Delete the security group</span>
        <span class="n">retry</span> <span class="o">=</span> <span class="n">tenacity</span><span class="o">.</span><span class="n">Retrying</span><span class="p">(</span>
            <span class="n">wait</span><span class="o">=</span><span class="n">tenacity</span><span class="o">.</span><span class="n">wait_exponential</span><span class="p">(</span><span class="nb">max</span><span class="o">=</span><span class="mi">16</span><span class="p">),</span>
            <span class="n">stop</span><span class="o">=</span><span class="n">tenacity</span><span class="o">.</span><span class="n">stop_after_delay</span><span class="p">(</span><span class="mi">300</span><span class="p">),</span>
            <span class="n">retry</span><span class="o">=</span><span class="n">tenacity</span><span class="o">.</span><span class="n">retry_if_exception_type</span><span class="p">(</span>
                <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">retry</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="n">clients</span><span class="p">[</span><span class="s1">&#39;ec2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">delete_security_group</span><span class="p">,</span>
            <span class="n">GroupId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">security_group_id</span>
        <span class="p">)</span>

        <span class="c1"># Remove this VPC from the list of VPCs in the config file</span>
        <span class="n">cloudknot</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">remove_resource</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_section_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">security_group_id</span>
        <span class="p">)</span>

        <span class="c1"># Set the clobbered parameter to True,</span>
        <span class="c1"># preventing subsequent method calls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clobbered</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">mod_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Clobbered security group </span><span class="si">{id:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">security_group_id</span>
        <span class="p">))</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    
    <div class="footer">
      &copy;2017, Adam Richie-Halford, Ariel Rokem.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.7</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
    <script type="text/javascript">
        $(document).ready(function() {
            $(".toggle > *").hide();
            $(".toggle .header").show();
            $(".toggle .header").click(function() {
                $(this).parent().children().not(".header").toggle(400);
                $(this).parent().children(".header").toggleClass("open");
            })
        });
    </script>

  </body>
</html>